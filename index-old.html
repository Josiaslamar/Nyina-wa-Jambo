<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Concorde Pharmacy - Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script>
      // Robust navigation fix for dashboard and landing page
      function showLandingPage() {
        document.getElementById("landingPage").style.display = "block";
        document.getElementById("dashboardPage").style.display = "none";
      }
      function showDashboard() {
        document.getElementById("landingPage").style.display = "none";
        document.getElementById("dashboardPage").style.display = "block";
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('overview-section').classList.remove('hidden');
      }
      document.addEventListener("DOMContentLoaded", function () {
        // Navigation event listeners
        var homeBtn = document.getElementById("homeBtn");
        if (homeBtn) homeBtn.onclick = showLandingPage;
        var dashboardBtn = document.getElementById("dashboardBtn");
        if (dashboardBtn) dashboardBtn.onclick = showDashboard;
        var getStartedBtn = document.getElementById("getStartedBtn");
        if (getStartedBtn) getStartedBtn.onclick = showDashboard;
        // Sidebar navigation
        document.querySelectorAll(".sidebar-btn").forEach(function(btn) {
          btn.onclick = function(e) {
            var section = btn.getAttribute("data-section");
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            var sectionDiv = document.getElementById(section + "-section");
            if (sectionDiv) sectionDiv.classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(function(b) {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('text-gray-700');
            });
            btn.classList.remove('text-gray-700');
            btn.classList.add('bg-primary', 'text-white');
          };
        });
      });
      // Modal logic for action buttons in dashboard tables
      function showActionModal(type, data) {
        let modalId = "actionModal";
        let modal = document.getElementById(modalId);
        if (!modal) {
          modal = document.createElement("div");
          modal.id = modalId;
          modal.className = "modal show";
          modal.innerHTML = `<div class='bg-white rounded-lg p-6 w-full max-w-md mx-4'>
            <div class='flex justify-between items-center mb-4'>
              <h3 id='actionModalTitle' class='text-xl font-semibold text-gray-900'></h3>
              <button id='closeActionModal' class='text-gray-400 hover:text-gray-600'>
                <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path>
                </svg>
              </button>
            </div>
            <div id='actionModalContent'></div>
          </div>`;
          document.body.appendChild(modal);
          document.getElementById("closeActionModal").onclick = function() {
            modal.classList.remove("show");
            setTimeout(() => modal.remove(), 300);
          };
        } else {
          modal.classList.add("show");
        }
        let title = "";
        let content = "";
        if (type === "edit") {
          title = "Edit Item";
          content = `<pre class='text-sm'>${JSON.stringify(data, null, 2)}</pre><button class='mt-4 px-4 py-2 bg-primary text-white rounded-lg'>Save Changes</button>`;
        } else if (type === "delete") {
          title = "Delete Item";
          content = `<p class='mb-4'>Are you sure you want to delete this item?</p><pre class='text-sm'>${JSON.stringify(data, null, 2)}</pre><button class='mt-4 px-4 py-2 bg-red-600 text-white rounded-lg'>Confirm Delete</button>`;
        } else if (type === "view") {
          title = "View Item";
          content = `<pre class='text-sm'>${JSON.stringify(data, null, 2)}</pre>`;
        }
        document.getElementById("actionModalTitle").textContent = title;
        document.getElementById("actionModalContent").innerHTML = content;
      }

      // Attach modal to action buttons in tables
      function attachActionModals() {
        // Medicines
        document.querySelectorAll("#medicinesTable button").forEach(btn => {
          btn.onclick = function(e) {
            const row = btn.closest("tr");
            const cells = Array.from(row.children).map(td => td.textContent);
            if (btn.classList.contains("text-blue-600")) {
              showActionModal("edit", { Medicine: cells[0], Category: cells[1], Stock: cells[2], Expiry: cells[3], Price: cells[4] });
            } else if (btn.classList.contains("text-red-600")) {
              showActionModal("delete", { Medicine: cells[0], Category: cells[1], Stock: cells[2], Expiry: cells[3], Price: cells[4] });
            }
          };
        });
        // Suppliers
        document.querySelectorAll("#suppliersGrid button").forEach(btn => {
          btn.onclick = function(e) {
            const card = btn.closest(".card-hover");
            const name = card.querySelector("h3").textContent;
            const contact = card.querySelector(".text-gray-600").textContent;
            if (btn.classList.contains("text-blue-600")) {
              showActionModal("edit", { Supplier: name, Contact: contact });
            } else if (btn.classList.contains("text-red-600")) {
              showActionModal("delete", { Supplier: name, Contact: contact });
            }
          };
        });
        // Customers
        document.querySelectorAll("#customersTable button").forEach(btn => {
          btn.onclick = function(e) {
            const row = btn.closest("tr");
            const cells = Array.from(row.children).map(td => td.textContent);
            if (btn.classList.contains("text-blue-600")) {
              showActionModal("edit", { Customer: cells[0], Phone: cells[1], Notes: cells[2], LastVisit: cells[3] });
            } else if (btn.classList.contains("text-red-600")) {
              showActionModal("delete", { Customer: cells[0], Phone: cells[1], Notes: cells[2], LastVisit: cells[3] });
            }
          };
        });
        // Orders
        document.querySelectorAll("#ordersTable button").forEach(btn => {
          btn.onclick = function(e) {
            const row = btn.closest("tr");
            const cells = Array.from(row.children).map(td => td.textContent);
            if (btn.classList.contains("text-blue-600")) {
              showActionModal("view", { OrderID: cells[0], Customer: cells[1], Medicines: cells[2], Total: cells[3], Date: cells[4], Status: cells[5] });
            } else if (btn.classList.contains("text-red-600")) {
              showActionModal("delete", { OrderID: cells[0], Customer: cells[1], Medicines: cells[2], Total: cells[3], Date: cells[4], Status: cells[5] });
            }
          };
        });
      }

      // Re-attach modals after Excel import
      const originalFillDashboardTableSmart = fillDashboardTableSmart;
      fillDashboardTableSmart = function(rows, tableBodyId, columns) {
        originalFillDashboardTableSmart(rows, tableBodyId, columns);
        attachActionModals();
      };
      document.addEventListener("DOMContentLoaded", function () {
        // Data Storage
        let medicines = [
          {
            id: 1,
            name: "Amoxicillin",
            category: "Antibiotics",
            stock: 150,
            expiry: "2025-12-15",
            price: 12.99,
          },
          {
            id: 2,
            name: "Paracetamol",
            category: "Pain Relief",
            stock: 8,
            expiry: "2025-10-20",
            price: 5.99,
          },
          {
            id: 3,
            name: "Vitamin D3",
            category: "Vitamins",
            stock: 200,
            expiry: "2026-03-10",
            price: 8.49,
          },
          {
            id: 4,
            name: "Lisinopril",
            category: "Heart",
            stock: 75,
            expiry: "2025-08-30",
            price: 15.99,
          },
          {
            id: 5,
            name: "Metformin",
            category: "Diabetes",
            stock: 5,
            expiry: "2025-11-25",
            price: 22.99,
          },
        ];

        let suppliers = [
          {
            id: 1,
            name: "PharmaCorp Ltd",
            contact: "+1-555-0123",
            items: "Antibiotics, Pain Relief",
            email: "contact@pharmacorp.com",
          },
          {
            id: 2,
            name: "MediSupply Inc",
            contact: "+1-555-0456",
            items: "Vitamins, Supplements",
            email: "orders@medisupply.com",
          },
          {
            id: 3,
            name: "HealthSource",
            contact: "+1-555-0789",
            items: "Heart Medications, Diabetes",
            email: "info@healthsource.com",
          },
        ];

        let customers = [
          {
            id: 1,
            name: "John Smith",
            phone: "+1-555-1111",
            notes: "Diabetes patient, allergic to penicillin",
            lastVisit: "2025-08-20",
          },
          {
            id: 2,
            name: "Mary Johnson",
            phone: "+1-555-2222",
            notes: "Hypertension medication",
            lastVisit: "2025-08-25",
          },
          {
            id: 3,
            name: "Robert Wilson",
            phone: "+1-555-3333",
            notes: "Regular vitamin supplements",
            lastVisit: "2025-08-27",
          },
        ];

        let orders = [
          {
            id: 1001,
            customerId: 1,
            customerName: "John Smith",
            medicines: [
              { id: 5, name: "Metformin", quantity: 2, price: 22.99 },
            ],
            total: 45.98,
            date: "2025-08-28",
            status: "Completed",
          },
          {
            id: 1002,
            customerId: 2,
            customerName: "Mary Johnson",
            medicines: [
              { id: 4, name: "Lisinopril", quantity: 1, price: 15.99 },
            ],
            total: 15.99,
            date: "2025-08-27",
            status: "Pending",
          },
          {
            id: 1003,
            customerId: 3,
            customerName: "Robert Wilson",
            medicines: [
              { id: 3, name: "Vitamin D3", quantity: 3, price: 8.49 },
            ],
            total: 25.47,
            date: "2025-08-26",
            status: "Completed",
          },
        ];

        let currentEditId = null;
        let currentSection = "overview";

        // Navigation Functions
        document
          .getElementById("homeBtn")
          .addEventListener("click", showLandingPage);
        document
          .getElementById("dashboardBtn")
          .addEventListener("click", showDashboard);
        document
          .getElementById("getStartedBtn")
          .addEventListener("click", showDashboard);

        function showLandingPage() {
          document.getElementById("landingPage").style.display = "block";
          document.getElementById("dashboardPage").style.display = "none";
        }

        function showDashboard() {
          document.getElementById("landingPage").style.display = "none";
          document.getElementById("dashboardPage").style.display = "block";
          showSection("overview");
          updateDashboardStats();
        }

        // Sidebar Navigation
        document.querySelectorAll(".sidebar-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const section = e.target.getAttribute("data-section");
            showSection(section);
          });
        });

        function showSection(section) {
          // Hide all sections
          document
            .querySelectorAll(".section")
            .forEach((s) => s.classList.add("hidden"));

          // Show selected section
          document
            .getElementById(section + "-section")
            .classList.remove("hidden");

          // Update sidebar active state
          document.querySelectorAll(".sidebar-btn").forEach((btn) => {
            btn.classList.remove("bg-primary", "text-white");
            btn.classList.add("text-gray-700");
          });

          document
            .querySelector(`[data-section="${section}"]`)
            .classList.remove("text-gray-700");
          document
            .querySelector(`[data-section="${section}"]`)
            .classList.add("bg-primary", "text-white");

          currentSection = section;

          // Load section data
          switch (section) {
            case "overview":
              console.log('Loading overview section...');
              updateDashboardStats();
              break;
            case "medicines":
              console.log('Loading medicines section...');
              renderMedicines();
              break;
            case "suppliers":
              console.log('Loading suppliers section...');
              renderSuppliers();
              break;
            case "customers":
              console.log('Loading customers section...');
              renderCustomers();
              break;
            case "orders":
              console.log('Loading orders section...');
              renderOrders();
              break;
            case "reports":
              console.log('Loading reports section...');
              renderReports();
              break;
            case "medicine-reports":
              console.log('Loading medicine reports section...');
              renderMedicineReports();
              break;
            case "overview":
              updateDashboardStats();
              renderRecentActivity();
              break;
          }
        }

        // Dashboard Stats - Updated to use Supabase
        async function updateDashboardStats() {
          try {
            // Fetch data from Supabase
            const medicines = await fetchMedicines();
            const orders = await fetchOrders();
            const suppliers = await fetchSuppliers();
            const customers = await fetchCustomers();
            
            // Update medicine stats
            document.getElementById("totalMedicines").textContent = medicines.length;
            
            const lowStockCount = medicines.filter((m) => (m.stock || 0) < 10).length;
            document.getElementById("lowStock").textContent = lowStockCount;
            
            // Update order stats
            document.getElementById("totalOrders").textContent = orders.length;

            // Calculate today's revenue
            const today = new Date().toISOString().split("T")[0];
            const todayRevenue = orders
              .filter((o) => o.order_date === today || o.created_at?.split('T')[0] === today)
              .reduce((sum, o) => sum + (o.total || 0), 0);
            document.getElementById("todayRevenue").textContent = `${todayRevenue.toFixed(2)}`;
            
            // Update other stats if they exist
            const totalSuppliersEl = document.getElementById("totalSuppliers");
            if (totalSuppliersEl) {
              totalSuppliersEl.textContent = suppliers.length;
            }
            
            const totalCustomersEl = document.getElementById("totalCustomers");
            if (totalCustomersEl) {
              totalCustomersEl.textContent = customers.length;
            }
            
          } catch (error) {
            console.error('Error updating dashboard stats:', error);
            // Set default values on error
            document.getElementById("totalMedicines").textContent = "0";
            document.getElementById("lowStock").textContent = "0";
            document.getElementById("totalOrders").textContent = "0";
            document.getElementById("todayRevenue").textContent = "0.00";
          }
        }

        function renderRecentActivity() {
          const activityContainer = document.getElementById("recentActivity");
          const activities = [
            {
              action: "New order created",
              details: `Order #${orders[orders.length - 1]?.id || 1001}`,
              time: "2 hours ago",
              icon: "shopping-bag",
            },
            {
              action: "Low stock alert",
              details: "Paracetamol (8 units remaining)",
              time: "4 hours ago",
              icon: "exclamation-triangle",
            },
            {
              action: "Medicine added",
              details: "Vitamin D3 restocked",
              time: "1 day ago",
              icon: "plus-circle",
            },
            {
              action: "Customer registered",
              details: "New customer: Robert Wilson",
              time: "2 days ago",
              icon: "user-plus",
            },
          ];

          activityContainer.innerHTML = activities
            .map(
              (activity) => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${getActivityIcon(activity.icon)}
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${
                          activity.action
                        }</p>
                        <p class="text-sm text-gray-600">${activity.details}</p>
                    </div>
                    <span class="text-sm text-gray-500">${activity.time}</span>
                </div>
            `
            )
            .join("");
        }

        function getActivityIcon(iconType) {
          const icons = {
            "shopping-bag":
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>',
            "exclamation-triangle":
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.232 16.5c-.77.833.192 2.5 1.732 2.5z"></path>',
            "plus-circle":
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>',
            "user-plus":
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>',
          };
          return icons[iconType] || icons["plus-circle"];
        }

        // Medicines Management - Updated to use Supabase
        async function renderMedicines() {
          const tbody = document.getElementById("medicinesTable");
          if (!tbody) return;
          
          const searchTerm =
            document.getElementById("medicineSearch")?.value.toLowerCase() ||
            "";
          const categoryFilter =
            document.getElementById("categoryFilter")?.value || "";

          // Show loading state
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading medicines...</td></tr>';

          try {
            // Fetch medicines from Supabase
            const medicines = await fetchMedicines();
            
            let filteredMedicines = medicines.filter((medicine) => {
              const matchesSearch =
                medicine.name.toLowerCase().includes(searchTerm) ||
                (medicine.category && medicine.category.toLowerCase().includes(searchTerm));
              const matchesCategory =
                !categoryFilter || medicine.category === categoryFilter;
              return matchesSearch && matchesCategory;
            });

            if (filteredMedicines.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No medicines found.</td></tr>';
              return;
            }

            tbody.innerHTML = filteredMedicines
              .map((medicine) => {
                const isLowStock = medicine.stock < 10;
                const isExpiring = medicine.expiry_date && 
                  new Date(medicine.expiry_date) <
                  new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);

                return `
                      <tr class="${isLowStock ? "low-stock" : ""}">
                          <td class="px-6 py-4">
                              <div class="font-medium text-gray-900">${
                                medicine.name
                              }</div>
                              ${
                                isExpiring
                                  ? '<div class="text-sm text-red-600">⚠️ Expiring soon</div>'
                                  : ""
                              }
                          </td>
                          <td class="px-6 py-4 text-gray-900">${
                            medicine.category || 'N/A'
                          }</td>
                          <td class="px-6 py-4">
                              <span class="${
                                isLowStock
                                  ? "text-red-600 font-semibold"
                                  : "text-gray-900"
                              }">${medicine.stock || 0}</span>
                              ${
                                isLowStock
                                  ? ' <span class="text-red-500 text-sm">⚠️ Low</span>'
                                  : ""
                              }
                          </td>
                          <td class="px-6 py-4 text-gray-900">$${(medicine.price || 0).toFixed(2)}</td>
                          <td class="px-6 py-4 text-gray-600">${medicine.expiry_date || 'N/A'}</td>
                          <td class="px-6 py-4">
                              <div class="flex space-x-2">
                                  <button onclick="editMedicine(${medicine.id})" class="text-blue-600 hover:text-blue-900">Edit</button>
                                  <button onclick="deleteMedicineById(${medicine.id})" class="text-red-600 hover:text-red-900">Delete</button>
                              </div>
                          </td>
                      </tr>
                  `;
              })
              .join("");
              
          } catch (error) {
            console.error('Error loading medicines:', error);
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading medicines. Please try again.</td></tr>';
          }
        }

        // Medicine Modal Functions
        document
          .getElementById("addMedicineBtn")
          .addEventListener("click", () => openMedicineModal());
        document
          .getElementById("closeMedicineModal")
          .addEventListener("click", closeMedicineModal);
        document
          .getElementById("cancelMedicine")
          .addEventListener("click", closeMedicineModal);
        document
          .getElementById("medicineForm")
          .addEventListener("submit", saveMedicine);

        // Search and Filter
        document
          .getElementById("medicineSearch")
          .addEventListener("input", renderMedicines);
        document
          .getElementById("categoryFilter")
          .addEventListener("change", renderMedicines);

        async function openMedicineModal(medicineId = null) {
          const modal = document.getElementById("medicineModal");
          const title = document.getElementById("medicineModalTitle");
          const form = document.getElementById("medicineForm");

          currentEditId = medicineId;

          if (medicineId) {
            title.textContent = "Edit Medicine";
            try {
              const medicines = await fetchMedicines();
              const medicine = medicines.find((m) => m.id === medicineId);
              if (medicine) {
                document.getElementById("medicineName").value = medicine.name;
                document.getElementById("medicineCategory").value = medicine.category;
                document.getElementById("medicineStock").value = medicine.stock;
                document.getElementById("medicineExpiry").value = medicine.expiry;
                document.getElementById("medicinePrice").value = medicine.price;
              }
            } catch (error) {
              console.error('Error fetching medicine data:', error);
              alert('Error loading medicine data. Please try again.');
              return;
            }
          } else {
            title.textContent = "Add Medicine";
            form.reset();
          }

          modal.classList.add("show");
        }

        function closeMedicineModal() {
          document.getElementById("medicineModal").classList.remove("show");
          currentEditId = null;
        }

        async function saveMedicine(e) {
          e.preventDefault();

          const medicineData = {
            name: document.getElementById("medicineName").value,
            category: document.getElementById("medicineCategory").value,
            stock: parseInt(document.getElementById("medicineStock").value),
            expiry: document.getElementById("medicineExpiry").value,
            price: parseFloat(document.getElementById("medicinePrice").value),
          };

          try {
            if (currentEditId) {
              await updateMedicine(currentEditId, medicineData);
            } else {
              await addMedicine(medicineData);
            }

            renderMedicines();
            updateDashboardStats();
            closeMedicineModal();

            // Show success message
            showNotification("Medicine saved successfully!", "success");
          } catch (error) {
            console.error('Error saving medicine:', error);
            showNotification("Error saving medicine. Please try again.", "error");
          }
        }

        function editMedicine(id) {
          openMedicineModal(id);
        }

        function deleteMedicine(id) {
          if (confirm("Are you sure you want to delete this medicine?")) {
            medicines = medicines.filter((m) => m.id !== id);
            renderMedicines();
            updateDashboardStats();
            showNotification("Medicine deleted successfully!", "success");
          }
        }

        // Suppliers Management - Updated to use Supabase
        async function renderSuppliers() {
          const grid = document.getElementById("suppliersGrid");
          if (!grid) return;
          
          // Show loading state
          grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Loading suppliers...</div>';
          
          try {
            // Fetch suppliers from Supabase
            const suppliers = await fetchSuppliers();
            
            if (suppliers.length === 0) {
              grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No suppliers found.</div>';
              return;
            }
            
            grid.innerHTML = suppliers
              .map(
                (supplier) => `
                  <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
                      <div class="flex items-start justify-between mb-4">
                          <div>
                              <h3 class="text-lg font-semibold text-gray-900">${
                                supplier.name
                              }</h3>
                              <p class="text-gray-600">${supplier.contact_person || 'N/A'}</p>
                              ${
                                supplier.email
                                  ? `<p class="text-gray-600">${supplier.email}</p>`
                                  : ""
                              }
                              ${
                                supplier.phone
                                  ? `<p class="text-gray-600">${supplier.phone}</p>`
                                  : ""
                              }
                          </div>
                          <div class="flex space-x-2">
                              <button onclick="editSupplier(${
                                supplier.id
                              })" class="text-blue-600 hover:text-blue-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                  </svg>
                              </button>
                              <button onclick="deleteSupplierById(${
                                supplier.id
                              })" class="text-red-600 hover:text-red-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                  </svg>
                              </button>
                          </div>
                      </div>
                      <div class="bg-gray-50 p-3 rounded-lg">
                          <p class="text-sm font-medium text-gray-700 mb-1">Location:</p>
                          <p class="text-sm text-gray-600">${supplier.address || 'N/A'}</p>
                          ${supplier.city ? `<p class="text-sm text-gray-600">${supplier.city}${supplier.country ? `, ${supplier.country}` : ''}</p>` : ''}
                      </div>
                  </div>
              `
              )
              .join("");
              
          } catch (error) {
            console.error('Error loading suppliers:', error);
            grid.innerHTML = '<div class="col-span-full text-center text-red-500 py-8">Error loading suppliers. Please try again.</div>';
          }
        }

        // Supplier Modal Functions
        document
          .getElementById("addSupplierBtn")
          .addEventListener("click", () => openSupplierModal());
        document
          .getElementById("closeSupplierModal")
          .addEventListener("click", closeSupplierModal);
        document
          .getElementById("cancelSupplier")
          .addEventListener("click", closeSupplierModal);
        document
          .getElementById("supplierForm")
          .addEventListener("submit", saveSupplier);

        async function openSupplierModal(supplierId = null) {
          const modal = document.getElementById("supplierModal");
          const title = document.getElementById("supplierModalTitle");
          const form = document.getElementById("supplierForm");

          currentEditId = supplierId;

          if (supplierId) {
            title.textContent = "Edit Supplier";
            try {
              const suppliers = await fetchSuppliers();
              const supplier = suppliers.find((s) => s.id === supplierId);
              if (supplier) {
                document.getElementById("supplierName").value = supplier.name;
                document.getElementById("supplierContact").value = supplier.contact;
                document.getElementById("supplierItems").value = supplier.items;
                document.getElementById("supplierEmail").value = supplier.email || "";
              }
            } catch (error) {
              console.error('Error fetching supplier data:', error);
              alert('Error loading supplier data. Please try again.');
              return;
            }
          } else {
            title.textContent = "Add Supplier";
            form.reset();
          }

          modal.classList.add("show");
        }

        function closeSupplierModal() {
          document.getElementById("supplierModal").classList.remove("show");
          currentEditId = null;
        }

        async function saveSupplier(e) {
          e.preventDefault();

          const supplierData = {
            name: document.getElementById("supplierName").value,
            contact: document.getElementById("supplierContact").value,
            items: document.getElementById("supplierItems").value,
            email: document.getElementById("supplierEmail").value,
          };

          try {
            if (currentEditId) {
              await updateSupplier(currentEditId, supplierData);
            } else {
              await addSupplier(supplierData);
            }

            renderSuppliers();
            closeSupplierModal();
            showNotification("Supplier saved successfully!", "success");
          } catch (error) {
            console.error('Error saving supplier:', error);
            showNotification("Error saving supplier. Please try again.", "error");
          }
        }

        function editSupplier(id) {
          openSupplierModal(id);
        }

        function deleteSupplier(id) {
          if (confirm("Are you sure you want to delete this supplier?")) {
            suppliers = suppliers.filter((s) => s.id !== id);
            renderSuppliers();
            showNotification("Supplier deleted successfully!", "success");
          }
        }

        // Customers Management
        // Customers Management - Updated to use Supabase
        async function renderCustomers() {
          const tbody = document.getElementById("customersTable");
          if (!tbody) return;
          
          // Show loading state
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading customers...</td></tr>';
          
          try {
            // Fetch customers from Supabase
            const customers = await fetchCustomers();
            
            if (customers.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No customers found.</td></tr>';
              return;
            }
            
            tbody.innerHTML = customers
              .map(
                (customer) => `
                  <tr>
                      <td class="px-6 py-4">
                          <div class="font-medium text-gray-900">${
                            customer.name
                          }</div>
                      </td>
                      <td class="px-6 py-4 text-gray-900">${customer.phone || 'N/A'}</td>
                      <td class="px-6 py-4">
                          <div class="text-sm text-gray-600 max-w-xs truncate">${
                            customer.notes || "No notes"
                          }</div>
                      </td>
                      <td class="px-6 py-4 text-gray-900">${customer.last_visit || 'N/A'}</td>
                      <td class="px-6 py-4">
                          <div class="flex space-x-2">
                              <button onclick="editCustomer(${
                                customer.id
                              })" class="text-blue-600 hover:text-blue-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                  </svg>
                              </button>
                              <button onclick="deleteCustomerById(${
                                customer.id
                              })" class="text-red-600 hover:text-red-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                  </svg>
                              </button>
                          </div>
                      </td>
                  </tr>
              `
              )
              .join("");
              
          } catch (error) {
            console.error('Error loading customers:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading customers. Please try again.</td></tr>';
          }
        }

        // Customer Modal Functions
        document
          .getElementById("addCustomerBtn")
          .addEventListener("click", () => openCustomerModal());
        document
          .getElementById("closeCustomerModal")
          .addEventListener("click", closeCustomerModal);
        document
          .getElementById("cancelCustomer")
          .addEventListener("click", closeCustomerModal);
        document
          .getElementById("customerForm")
          .addEventListener("submit", saveCustomer);

        async function openCustomerModal(customerId = null) {
          const modal = document.getElementById("customerModal");
          const title = document.getElementById("customerModalTitle");
          const form = document.getElementById("customerForm");

          currentEditId = customerId;

          if (customerId) {
            title.textContent = "Edit Customer";
            try {
              const customers = await fetchCustomers();
              const customer = customers.find((c) => c.id === customerId);
              if (customer) {
                document.getElementById("customerName").value = customer.name;
                document.getElementById("customerPhone").value = customer.phone;
                document.getElementById("customerNotes").value = customer.notes || "";
              }
            } catch (error) {
              console.error('Error fetching customer data:', error);
              alert('Error loading customer data. Please try again.');
              return;
            }
          } else {
            title.textContent = "Add Customer";
            form.reset();
          }

          modal.classList.add("show");
        }

        function closeCustomerModal() {
          document.getElementById("customerModal").classList.remove("show");
          currentEditId = null;
        }

        async function saveCustomer(e) {
          e.preventDefault();

          const customerData = {
            name: document.getElementById("customerName").value,
            phone: document.getElementById("customerPhone").value,
            notes: document.getElementById("customerNotes").value,
            lastVisit: new Date().toISOString().split("T")[0],
          };

          try {
            if (currentEditId) {
              await updateCustomer(currentEditId, customerData);
            } else {
              await addCustomer(customerData);
            }

            renderCustomers();
            closeCustomerModal();
            showNotification("Customer saved successfully!", "success");
          } catch (error) {
            console.error('Error saving customer:', error);
            showNotification("Error saving customer. Please try again.", "error");
          }
        }

        function editCustomer(id) {
          openCustomerModal(id);
        }

        function deleteCustomer(id) {
          if (confirm("Are you sure you want to delete this customer?")) {
            customers = customers.filter((c) => c.id !== id);
            renderCustomers();
            showNotification("Customer deleted successfully!", "success");
          }
        }

        // Orders Management - Updated to use Supabase
        async function renderOrders() {
          const tbody = document.getElementById("ordersTable");
          if (!tbody) return;
          
          // Show loading state
          tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading orders...</td></tr>';
          
          try {
            // Fetch orders from Supabase
            const orders = await fetchOrders();
            
            if (orders.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No orders found.</td></tr>';
              return;
            }
            
            tbody.innerHTML = orders
              .map(
                (order) => `
                  <tr>
                      <td class="px-6 py-4">
                          <div class="font-medium text-gray-900">#${
                            order.id
                          }</div>
                      </td>
                      <td class="px-6 py-4 text-gray-900">${
                        order.customer_name || 'N/A'
                      }</td>
                      <td class="px-6 py-4">
                          <div class="text-sm text-gray-600">
                              ${order.medicine_name || 'N/A'} (${order.quantity || 1})
                          </div>
                      </td>
                      <td class="px-6 py-4 text-gray-900">$${(order.total || 0).toFixed(2)}</td>
                      <td class="px-6 py-4 text-gray-900">${order.order_date || order.created_at?.split('T')[0] || 'N/A'}</td>
                      <td class="px-6 py-4">
                          <span class="px-2 py-1 text-xs rounded-full ${
                            order.status === "completed"
                              ? "bg-green-100 text-green-800"
                              : order.status === "pending"
                              ? "bg-yellow-100 text-yellow-800"
                              : "bg-blue-100 text-blue-800"
                          }">
                              ${order.status || 'pending'}
                          </span>
                      </td>
                      <td class="px-6 py-4">
                          <div class="flex space-x-2">
                              <button onclick="viewOrder(${
                                order.id
                              })" class="text-blue-600 hover:text-blue-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                  </svg>
                              </button>
                              <button onclick="deleteOrderById(${
                                order.id
                              })" class="text-red-600 hover:text-red-800">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                  </svg>
                              </button>
                          </div>
                      </td>
                  </tr>
              `
              )
              .join("");
              
          } catch (error) {
            console.error('Error loading orders:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading orders. Please try again.</td></tr>';
          }
        }

        // Order Management Functions

        // Order Modal Functions
        document
          .getElementById("addOrderBtn")
          .addEventListener("click", () => openOrderModal());
        document
          .getElementById("closeOrderModal")
          .addEventListener("click", closeOrderModal);
        document
          .getElementById("cancelOrder")
          .addEventListener("click", closeOrderModal);
        document
          .getElementById("orderForm")
          .addEventListener("submit", saveOrder);

        function openOrderModal() {
          const modal = document.getElementById("orderModal");
          const customerSelect = document.getElementById("orderCustomer");
          const medicinesDiv = document.getElementById("orderMedicines");

          // Populate customers
          customerSelect.innerHTML =
            '<option value="">Select Customer</option>' +
            customers
              .map((c) => `<option value="${c.id}">${c.name}</option>`)
              .join("");

          // Populate medicines with checkboxes
          medicinesDiv.innerHTML = medicines
            .map(
              (medicine) => `
                <div class="flex items-center space-x-3 p-2 border rounded">
                    <input type="checkbox" id="med_${medicine.id}" class="medicine-checkbox" 
                           data-id="${medicine.id}" data-name="${medicine.name}" data-price="${medicine.price}">
                    <label for="med_${medicine.id}" class="flex-1 cursor-pointer">
                        <span class="font-medium">${medicine.name}</span>
                        <span class="text-gray-600 ml-2">${medicine.price}</span>
                    </label>
                    <input type="number" id="qty_${medicine.id}" min="1" max="${medicine.stock}" 
                           value="1" class="w-16 px-2 py-1 border rounded medicine-quantity" disabled>
                </div>
            `
            )
            .join("");

          // Add event listeners for checkboxes and quantities
          document
            .querySelectorAll(".medicine-checkbox")
            .forEach((checkbox) => {
              checkbox.addEventListener("change", updateOrderTotal);
            });

          document.querySelectorAll(".medicine-quantity").forEach((input) => {
            input.addEventListener("input", updateOrderTotal);
            input.addEventListener("change", function () {
              const checkbox = document.getElementById(
                `med_${this.id.split("_")[1]}`
              );
              this.disabled = !checkbox.checked;
            });
          });

          modal.classList.add("show");
          updateOrderTotal();
        }

        function closeOrderModal() {
          document.getElementById("orderModal").classList.remove("show");
          document.getElementById("orderForm").reset();
        }

        function updateOrderTotal() {
          let total = 0;
          document
            .querySelectorAll(".medicine-checkbox:checked")
            .forEach((checkbox) => {
              const medicineId = checkbox.dataset.id;
              const price = parseFloat(checkbox.dataset.price);
              const quantity =
                parseInt(document.getElementById(`qty_${medicineId}`).value) ||
                1;

              // Enable quantity input
              document.getElementById(`qty_${medicineId}`).disabled = false;

              total += price * quantity;
            });

          // Disable quantity inputs for unchecked medicines
          document
            .querySelectorAll(".medicine-checkbox:not(:checked)")
            .forEach((checkbox) => {
              const medicineId = checkbox.dataset.id;
              document.getElementById(`qty_${medicineId}`).disabled = true;
            });

          document.getElementById("orderTotal").textContent = `${total.toFixed(
            2
          )}`;
        }

        function saveOrder(e) {
          e.preventDefault();

          const customerId = parseInt(
            document.getElementById("orderCustomer").value
          );
          const customer = customers.find((c) => c.id === customerId);

          if (!customer) {
            alert("Please select a customer");
            return;
          }

          const selectedMedicines = [];
          let total = 0;

          document
            .querySelectorAll(".medicine-checkbox:checked")
            .forEach((checkbox) => {
              const medicineId = parseInt(checkbox.dataset.id);
              const medicineName = checkbox.dataset.name;
              const price = parseFloat(checkbox.dataset.price);
              const quantity = parseInt(
                document.getElementById(`qty_${medicineId}`).value
              );

              selectedMedicines.push({
                id: medicineId,
                name: medicineName,
                quantity: quantity,
                price: price,
              });

              total += price * quantity;

              // Update medicine stock
              const medicineIndex = medicines.findIndex(
                (m) => m.id === medicineId
              );
              if (medicineIndex !== -1) {
                medicines[medicineIndex].stock -= quantity;
              }
            });

          if (selectedMedicines.length === 0) {
            alert("Please select at least one medicine");
            return;
          }

          const newOrderId = Math.max(...orders.map((o) => o.id)) + 1;
          const newOrder = {
            id: newOrderId,
            customerId: customerId,
            customerName: customer.name,
            medicines: selectedMedicines,
            total: total,
            date: new Date().toISOString().split("T")[0],
            status: "Completed",
          };

          orders.push(newOrder);
          renderOrders();
          renderMedicines(); // Update medicine table to reflect stock changes
          updateDashboardStats();
          closeOrderModal();
          showNotification("Order created successfully!", "success");
        }

        function viewOrder(orderId) {
          const order = orders.find((o) => o.id === orderId);
          const medicinesList = order.medicines
            .map(
              (m) =>
                `${m.name} x${m.quantity} - ${(m.price * m.quantity).toFixed(
                  2
                )}`
            )
            .join("\n");

          alert(
            `Order #${order.id}\nCustomer: ${
              order.customerName
            }\nDate: ${formatDate(order.date)}\nStatus: ${
              order.status
            }\n\nMedicines:\n${medicinesList}\n\nTotal: ${order.total.toFixed(
              2
            )}`
          );
        }

        function deleteOrder(id) {
          if (confirm("Are you sure you want to delete this order?")) {
            orders = orders.filter((o) => o.id !== id);
            renderOrders();
            updateDashboardStats();
            showNotification("Order deleted successfully!", "success");
          }
        }

        // Reports Management
        function renderReports() {
          const statsContainer = document.getElementById("reportStats");
          statsContainer.innerHTML = `<div class='p-4 text-gray-500'>Loading reports...</div>`;
          Promise.all([
            fetchMedicines(),
            fetchSuppliers(),
            fetchCustomers(),
            fetchOrders()
          ]).then(([medicines, suppliers, customers, orders]) => {
            const totalSales = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            statsContainer.innerHTML = `
              <div class="p-4 bg-white rounded-lg shadow-sm">
                  <p class="text-gray-600 text-sm">Total Sales</p>
                  <p class="text-2xl font-bold text-gray-900">$${totalSales.toFixed(2)}</p>
              </div>
              <div class="p-4 bg-white rounded-lg shadow-sm">
                  <p class="text-gray-600 text-sm">Total Orders</p>
                  <p class="text-2xl font-bold text-gray-900">${orders.length}</p>
              </div>
              <div class="p-4 bg-white rounded-lg shadow-sm">
                  <p class="text-gray-600 text-sm">Total Customers</p>
                  <p class="text-2xl font-bold text-gray-900">${customers.length}</p>
              </div>
              <div class="p-4 bg-white rounded-lg shadow-sm">
                  <p class="text-gray-600 text-sm">Total Medicines</p>
                  <p class="text-2xl font-bold text-gray-900">${medicines.length}</p>
              </div>
              <div class="p-4 bg-white rounded-lg shadow-sm">
                  <p class="text-gray-600 text-sm">Total Suppliers</p>
                  <p class="text-2xl font-bold text-gray-900">${suppliers.length}</p>
              </div>
            `;
          });
        }

        // XLSX Export Functions for Reports
        function exportSalesXLSX() {
          const ws_data = [
            ["Order ID", "Customer", "Medicines", "Total", "Date", "Status"],
          ];
          orders.forEach((order) => {
            const meds = order.medicines
              .map((m) => `${m.name} (${m.quantity})`)
              .join("; ");
            ws_data.push([
              order.id,
              order.customerName,
              meds,
              order.total.toFixed(2),
              order.date,
              order.status,
            ]);
          });
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          styleHeader(ws, 6);
          styleTable(ws, ws_data.length, 6);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sales Report");
          XLSX.writeFile(wb, "sales_report.xlsx");
        }

        function exportInventoryXLSX() {
          const ws_data = [
            ["Medicine", "Category", "Stock", "Expiry", "Price"],
          ];
          medicines.forEach((med) => {
            ws_data.push([
              med.name,
              med.category,
              med.stock,
              med.expiry,
              med.price,
            ]);
          });
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          styleHeader(ws, 5);
          styleTable(ws, ws_data.length, 5);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Inventory Report");
          XLSX.writeFile(wb, "inventory_report.xlsx");
        }

        function exportCustomersXLSX() {
          const ws_data = [["Customer", "Phone", "Notes", "Last Visit"]];
          customers.forEach((cust) => {
            ws_data.push([cust.name, cust.phone, cust.notes, cust.lastVisit]);
          });
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          styleHeader(ws, 4);
          styleTable(ws, ws_data.length, 4);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Customer Report");
          XLSX.writeFile(wb, "customer_report.xlsx");
        }

        document
          .getElementById("exportSalesBtn")
          .addEventListener("click", function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Sales Report");
            worksheet.addRow([
              "Order ID",
              "Customer",
              "Medicines",
              "Total",
              "Date",
              "Status",
            ]);
            if (typeof orders !== "undefined") {
              orders.forEach((order) => {
                worksheet.addRow([
                  order.id,
                  order.customerName,
                  Array.isArray(order.medicines)
                    ? order.medicines.join("; ")
                    : order.medicines,
                  order.total,
                  order.date,
                  order.status,
                ]);
              });
            }
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "sales_report.xlsx");
            });
          });
        document
          .getElementById("exportInventoryBtn")
          .addEventListener("click", function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Inventory Report");
            worksheet.addRow([
              "Medicine",
              "Category",
              "Stock",
              "Expiry",
              "Price",
            ]);
            if (typeof medicines !== "undefined") {
              medicines.forEach((med) => {
                worksheet.addRow([
                  med.name,
                  med.category,
                  med.stock,
                  med.expiry,
                  med.price,
                ]);
              });
            }
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "inventory_report.xlsx");
            });
          });
        document
          .getElementById("exportCustomersBtn")
          .addEventListener("click", function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Customer Report");
            worksheet.addRow(["Customer", "Phone", "Notes", "Last Visit"]);
            if (typeof customers !== "undefined") {
              customers.forEach((cust) => {
                worksheet.addRow([
                  cust.name,
                  cust.phone,
                  cust.notes,
                  cust.lastVisit,
                ]);
              });
            }
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "customer_report.xlsx");
            });
          });

        // Medicine Reports Export Event Listeners
        document
          .getElementById("exportMedicineInBtn")
          ?.addEventListener("click", async function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Medicine Stock IN");
            worksheet.addRow([
              "Medicine",
              "Category", 
              "Quantity IN",
              "Price",
              "Supplier",
              "IN Date"
            ]);
            
            try {
              const medicines = await fetchMedicines();
              medicines.forEach((med) => {
                worksheet.addRow([
                  med.name,
                  med.category || 'N/A',
                  med.stock || 0,
                  med.price || 0,
                  med.supplier || 'N/A',
                  med.created_at ? new Date(med.created_at).toLocaleDateString() : 'N/A'
                ]);
              });
            } catch (error) {
              console.error('Error fetching medicines for export:', error);
            }
            
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "medicine_stock_in.xlsx");
            });
          });

        document
          .getElementById("exportMedicineOutBtn")
          ?.addEventListener("click", async function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Medicine Stock OUT");
            worksheet.addRow([
              "Medicine",
              "Category",
              "Quantity OUT",
              "Price",
              "Customer",
              "OUT Date"
            ]);
            
            try {
              const orders = await fetchOrders();
              orders.forEach((order) => {
                worksheet.addRow([
                  order.medicine_name || 'N/A',
                  order.category || 'N/A',
                  order.quantity || 0,
                  order.total || 0,
                  order.customer_name || 'N/A',
                  order.created_at ? new Date(order.created_at).toLocaleDateString() : 'N/A'
                ]);
              });
            } catch (error) {
              console.error('Error fetching orders for export:', error);
            }
            
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "medicine_stock_out.xlsx");
            });
          });

        document
          .getElementById("exportMedicineStockBtn")
          ?.addEventListener("click", async function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Current Medicine Stock");
            worksheet.addRow([
              "Medicine",
              "Category",
              "Current Stock",
              "Price",
              "Supplier",
              "Last Updated"
            ]);
            
            try {
              const medicines = await fetchMedicines();
              medicines.forEach((med) => {
                worksheet.addRow([
                  med.name,
                  med.category || 'N/A',
                  med.stock || 0,
                  med.price || 0,
                  med.supplier || 'N/A',
                  med.updated_at ? new Date(med.updated_at).toLocaleDateString() : 
                  med.created_at ? new Date(med.created_at).toLocaleDateString() : 'N/A'
                ]);
              });
            } catch (error) {
              console.error('Error fetching medicines for export:', error);
            }
            
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "current_medicine_stock.xlsx");
            });
          });

        document
          .getElementById("exportFullMedicineReportBtn")
          ?.addEventListener("click", async function () {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Full Medicine Report");
            worksheet.addRow([
              "Medicine",
              "Category",
              "Movement Type",
              "Quantity",
              "Price",
              "Current Stock",
              "IN Date",
              "OUT Date",
              "Supplier/Customer"
            ]);
            
            try {
              const medicines = await fetchMedicines();
              const orders = await fetchOrders();
              
              medicines.forEach((med) => {
                // Add current stock row
                worksheet.addRow([
                  med.name,
                  med.category || 'N/A',
                  'Current Stock',
                  med.stock || 0,
                  med.price || 0,
                  med.stock || 0,
                  med.created_at ? new Date(med.created_at).toLocaleDateString() : 'N/A',
                  '',
                  med.supplier || 'N/A'
                ]);
                
                // Add related orders (OUT movements)
                const relatedOrders = orders.filter(order => 
                  order.medicine_name && order.medicine_name.toLowerCase().includes(med.name.toLowerCase())
                );
                
                relatedOrders.forEach(order => {
                  worksheet.addRow([
                    med.name,
                    med.category || 'N/A',
                    'Stock OUT',
                    -(order.quantity || 1),
                    order.total || med.price || 0,
                    med.stock || 0,
                    '',
                    order.created_at ? new Date(order.created_at).toLocaleDateString() : 'N/A',
                    order.customer_name || 'Customer'
                  ]);
                });
              });
            } catch (error) {
              console.error('Error fetching data for full report export:', error);
            }
            
            worksheet.getRow(1).font = { bold: true };
            workbook.xlsx.writeBuffer().then((buffer) => {
              saveAs(new Blob([buffer]), "full_medicine_report.xlsx");
            });
          });

        // Medicine Reports Filter and Refresh
        document
          .getElementById("refreshMedicineReports")
          ?.addEventListener("click", function () {
            renderMedicineReports();
          });

        document
          .getElementById("medicineReportFilter")
          ?.addEventListener("change", function () {
            renderMedicineReports();
          });

        // Helper to style header row (bold, border)
        function styleHeader(ws, colCount) {
          for (let c = 0; c < colCount; c++) {
            const cell = ws[XLSX.utils.encode_cell({ r: 0, c })];
            if (cell) {
              cell.s = {
                font: { bold: true },
                alignment: { horizontal: "center" },
                border: {
                  top: { style: "thin", color: { rgb: "000000" } },
                  bottom: { style: "thin", color: { rgb: "000000" } },
                  left: { style: "thin", color: { rgb: "000000" } },
                  right: { style: "thin", color: { rgb: "000000" } },
                },
              };
            }
          }
        }

        // Helper to style all table cells with borders
        function styleTable(ws, rowCount, colCount) {
          for (let r = 1; r < rowCount; r++) {
            for (let c = 0; c < colCount; c++) {
              const cell = ws[XLSX.utils.encode_cell({ r, c })];
              if (cell) {
                cell.s = {
                  border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } },
                  },
                };
              }
            }
          }
        }

        // Utility Functions
        function formatDate(dateStr) {
          if (!dateStr) return "";
          const d = new Date(dateStr);
          return d.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        function showNotification(message, type = "success") {
          // Simple notification (can be improved)
          const notif = document.createElement("div");
          notif.className = `fixed top-6 right-6 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold ${
            type === "success" ? "bg-primary" : "bg-red-600"
          }`;
          notif.textContent = message;
          document.body.appendChild(notif);
          setTimeout(() => notif.remove(), 2500);
        }

        // Initial Render
        showLandingPage();
        renderMedicines();
        renderSuppliers();
        renderCustomers();
        renderOrders();
        updateDashboardStats();
        renderRecentActivity();
      });
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .fade-in {
        animation: fadeIn 0.6s ease-in;
      }
      .slide-up {
        animation: slideUp 0.8s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stats-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      }
      .low-stock {
        background-color: #fef2f2;
        border-left: 4px solid #ef4444;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .animate-pulse-slow {
        animation: pulse 3s infinite;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 11.172V5l-1-1z"
                ></path>
          </svg>
            </div>
            <h1 class="text-xl font-bold text-gray-900">HP NYINA WA JAMBO</h1>
          </div>
          <div class="flex space-x-4">
            <button
              id="homeBtn"
              class="px-4 py-2 text-primary hover:text-primary-dark font-medium transition-colors"
            >
              Home
            </button>
            <button
              id="dashboardBtn"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
            >
              Dashboard
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen">
      <!-- Hero Section -->
      <section class="gradient-bg text-white py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <div class="slide-up">
            <h2 class="text-5xl font-bold mb-6">Your Health, Our Priority</h2>
            <p class="text-xl mb-8 text-green-100 max-w-3xl mx-auto">
              Modern pharmacy management system designed to streamline
              operations, track inventory, and provide exceptional customer
              service.
            </p>
            <button
              id="getStartedBtn"
              class="bg-white text-primary px-8 py-4 rounded-lg font-semibold text-lg hover:bg-gray-100 transition-all transform hover:scale-105"
            >
              Get Started Today
            </button>
          </div>
        </div>
      </section>

      <!-- Services Section -->
      <section class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16 fade-in">
            <h3 class="text-3xl font-bold text-gray-900 mb-4">
              Comprehensive Pharmacy Solutions
            </h3>
            <p class="text-gray-600 text-lg">
              Everything you need to run a modern pharmacy efficiently
            </p>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="text-center p-6 rounded-lg card-hover">
              <div
                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
              </div>
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                Online Prescription Management
              </h4>
              <p class="text-gray-600">
                Digital prescription processing and management system
              </p>
            </div>
            <div class="text-center p-6 rounded-lg card-hover">
              <div
                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                  ></path>
                </svg>
              </div>
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                Inventory Tracking
              </h4>
              <p class="text-gray-600">
                Real-time stock monitoring with automated alerts
              </p>
            </div>
            <div class="text-center p-6 rounded-lg card-hover">
              <div
                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 012 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2v-6m-1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </div>
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                Sales Reports
              </h4>
              <p class="text-gray-600">
                Comprehensive analytics and reporting tools
              </p>
            </div>
            <div class="text-center p-6 rounded-lg card-hover">
              <div
                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192L5.636 18.364M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path>
                </svg>
              </div>
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                Customer Support
              </h4>
              <p class="text-gray-600">
                24/7 customer assistance and consultation
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Pain Points Section -->
      <section class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h3 class="text-3xl font-bold text-gray-900 mb-4">
              Problems We Solve
            </h3>
            <p class="text-gray-600 text-lg">
              Common pharmacy challenges that we address
            </p>
          </div>
          <div class="grid md:grid-cols-2 gap-8">
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500"
            >
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                ❌ Manual Stock Management
              </h4>
              <p class="text-gray-600">
                Leads to errors, overstocking, and missed opportunities
              </p>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500"
            >
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                ❌ Expiry Date Tracking
              </h4>
              <p class="text-gray-600">
                Hard to monitor expiry dates, resulting in waste and losses
              </p>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500"
            >
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                ❌ Paper-Based Prescriptions
              </h4>
              <p class="text-gray-600">
                Time-consuming and prone to human error
              </p>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500"
            >
              <h4 class="text-xl font-semibold text-gray-900 mb-2">
                ❌ No Instant Reports
              </h4>
              <p class="text-gray-600">
                Weak decision making due to lack of real-time data
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Testimonials -->
      <section class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h3 class="text-3xl font-bold text-gray-900 mb-4">
              What Our Clients Say
            </h3>
          </div>
          <div class="grid md:grid-cols-3 gap-8">
            <div class="bg-gray-50 p-6 rounded-lg">
              <p class="text-gray-600 mb-4">
                "This system has transformed how we manage our pharmacy. Stock
                management is now effortless!"
              </p>
              <div class="flex items-center">
                <div
                  class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold"
                >
                  JD
                </div>
                <div class="ml-3">
                  <p class="font-semibold text-gray-900">Dr. John Davis</p>
                  <p class="text-gray-500">Central Pharmacy</p>
                </div>
              </div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg">
              <p class="text-gray-600 mb-4">
                "Real-time inventory tracking has saved us thousands in expired
                medications. Highly recommended!"
              </p>
              <div class="flex items-center">
                <div
                  class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold"
                >
                  SM
                </div>
                <div class="ml-3">
                  <p class="font-semibold text-gray-900">Sarah Miller</p>
                  <p class="text-gray-500">HealthCare Pharmacy</p>
                </div>
              </div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg">
              <p class="text-gray-600 mb-4">
                "The reporting features give us insights we never had before.
                Our profits have increased by 30%!"
              </p>
              <div class="flex items-center">
                <div
                  class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold"
                >
                  RK
                </div>
                <div class="ml-3">
                  <p class="font-semibold text-gray-900">Robert Kim</p>
                  <p class="text-gray-500">MediCare Plus</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact Section -->
      <section class="py-20 gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h3 class="text-3xl font-bold mb-8">Ready to Get Started?</h3>
          <p class="text-xl mb-8 text-green-100">
            Contact us today for a personalized demo
          </p>
          <div
            class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-8"
          >
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                ></path>
                <path
                  d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                ></path>
              </svg>
              <span>demo@concordepharmacy.com</span>
            </div>
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
                ></path>
              </svg>
              <span>+1 (555) 123-4567</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Dashboard -->
       <div id="dashboardPage" class="hidden min-h-screen bg-gray-50">
      <div class="flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-sm h-screen sticky top-16">
          <nav class="p-4 space-y-2">
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="overview"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"
                ></path>
              </svg>
              Dashboard Overview
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="medicines"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 11.172V5l-1-1z"
                ></path>
              </svg>
              Medicines
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="suppliers"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
              Suppliers
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="customers"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM3 20a6 6 0 0112 0v1H3v-1z"
                ></path>
              </svg>
              Customers
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="orders"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                ></path>
              </svg>
              Orders
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="reports"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              Reports
            </button>
            <button
              class="sidebar-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 font-medium text-gray-700"
              data-section="medicine-reports"
            >
              <svg
                class="w-5 h-5 inline mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
              Medicine Reports
            </button>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
          <!-- Overview Section -->
          <div id="overview-section" class="section">
            <!-- Excel Import Section -->
            <!-- <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">
                Import Excel Sheet
              </h3>
              <input
                type="file"
                id="excelImportInput"
                accept=".xlsx,.xls"
                class="mb-4 block"
              />
              <div id="excelImportTableContainer" class="overflow-x-auto"></div>
            </div> -->

            <h2 class="text-3xl font-bold text-gray-900 mb-8">
              Dashboard Overview
            </h2>

            <!-- Supabase Connection Status -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">
                  <i class="fas fa-database mr-2 text-blue-600"></i>
                  Database Connection Status
                </h3>
                <button
                  id="testConnectionBtn"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  onclick="testSupabaseConnection()"
                >
                  <i class="fas fa-sync-alt mr-2"></i>
                  Test Connection
                </button>
              </div>
              <div id="connectionStatus" class="p-4 bg-gray-50 rounded-lg">
                <div class="text-gray-600">
                  <i class="fas fa-clock mr-2"></i>
                  Click "Test Connection" to check database status...
                </div>
              </div>
              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                  <strong>Supabase URL:</strong><br>
                  <code class="bg-gray-100 px-2 py-1 rounded text-xs">https://qeprqgdkearetdpbvcyr.supabase.co</code>
                </div>
                <div>
                  <strong>Tables:</strong><br>
                  <span class="text-xs">medicines, suppliers, customers, orders</span>
                </div>
              </div>
            </div>

            <!-- Stats Cards -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div class="stats-card p-6 rounded-lg border">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-gray-600 text-sm">Total Medicines</p>
                    <p
                      id="totalMedicines"
                      class="text-3xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-blue-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.678-2.153-1.415-3.414l5-5A2 2 0 009 11.172V5l-1-1z"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="stats-card p-6 rounded-lg border">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-gray-600 text-sm">Low Stock Items</p>
                    <p id="lowStock" class="text-3xl font-bold text-red-600">
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-red-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.232 16.5c-.77.833.192 2.5 1.732 2.5z"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="stats-card p-6 rounded-lg border">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-gray-600 text-sm">Total Orders</p>
                    <p
                      id="totalOrders"
                      class="text-3xl font-bold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-primary"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                      ></path>
                </svg>
                  </div>
                </div>
              </div>
              <div class="stats-card p-6 rounded-lg border">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-gray-600 text-sm">Revenue Today</p>
                    <p
                      id="todayRevenue"
                      class="text-3xl font-bold text-gray-900"
                    >
                      $0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-yellow-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">
                Recent Activity
              </h3>
              <div id="recentActivity" class="space-y-3">
                <!-- Activity items will be populated here -->
              </div>
            </div>
          </div>

          <!-- Medicines Section -->
          <div id="medicines-section" class="section hidden">
            <!-- Excel Import for Medicines -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">Import Medicines Excel Sheet</h3>
              <input type="file" id="excelImportMedicinesInput" accept=".xlsx,.xls" class="mb-4 block" />
            </div>
            <div class="flex justify-between items-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">
                Medicines Inventory
              </h2>
              <button
                id="addMedicineBtn"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark transition-colors"
              >
                <svg
                  class="w-5 h-5 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Add Medicine
              </button>
            </div>

            <!-- Search and Filter -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
              <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                  <input
                    id="medicineSearch"
                    type="text"
                    placeholder="Search medicines..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>
                <select
                  id="categoryFilter"
                  class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                >
                  <option value="">All Categories</option>
                  <option value="Antibiotics">Antibiotics</option>
                  <option value="Pain Relief">Pain Relief</option>
                  <option value="Vitamins">Vitamins</option>
                  <option value="Heart">Heart</option>
                  <option value="Diabetes">Diabetes</option>
                </select>
              </div>
            </div>

            <!-- Medicines Table -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Medicine
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Category
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Stock
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Expiry Date
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Price
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="medicinesTable"
                    class="bg-white divide-y divide-gray-200"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Suppliers Section -->
          <div id="suppliers-section" class="section hidden">
            <!-- Excel Import for Suppliers -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">Import Suppliers Excel Sheet</h3>
              <input type="file" id="excelImportSuppliersInput" accept=".xlsx,.xls" class="mb-4 block" />
            </div>
            <div class="flex justify-between items-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">Suppliers</h2>
              <button
                id="addSupplierBtn"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark transition-colors"
              >
                <svg
                  class="w-5 h-5 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Add Supplier
              </button>
            </div>

            <div class="grid gap-6">
              <div
                id="suppliersGrid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              ></div>
            </div>
          </div>

          <!-- Customers Section -->
          <div id="customers-section" class="section hidden">
            <!-- Excel Import for Customers -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">Import Customers Excel Sheet</h3>
              <input type="file" id="excelImportCustomersInput" accept=".xlsx,.xls" class="mb-4 block" />
            </div>
            <div class="flex justify-between items-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">Customers</h2>
              <button
                id="addCustomerBtn"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark transition-colors"
              >
                <svg
                  class="w-5 h-5 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Add Customer
              </button>
            </div>

            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Customer
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Phone
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Prescription Notes
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Last Visit
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="customersTable"
                    class="bg-white divide-y divide-gray-200"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Orders Section -->
          <div id="orders-section" class="section hidden">
            <!-- Excel Import for Orders -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">Import Orders Excel Sheet</h3>
              <input type="file" id="excelImportOrdersInput" accept=".xlsx,.xls" class="mb-4 block" />
            </div>
            <div class="flex justify-between items-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900">Orders</h2>
              <button
                id="addOrderBtn"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark transition-colors"
              >
                <svg
                  class="w-5 h-5 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Create Order
              </button>
            </div>

            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Order ID
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Customer
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Medicines
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Total Price
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Date
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Status
                      </th>
                      <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="ordersTable"
                    class="bg-white divide-y divide-gray-200"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Reports Section -->
          <div id="reports-section" class="section hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">Sales Reports</h2>

            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"
            >
              <button
                id="exportSalesBtn"
                class="bg-white border-2 border-primary text-primary px-6 py-4 rounded-lg hover:bg-primary hover:text-white transition-colors"
              >
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
                <span class="block font-semibold">Export Sales Report</span>
                <span class="block text-sm opacity-75">Download CSV</span>
              </button>
              <button
                id="exportInventoryBtn"
                class="bg-white border-2 border-primary text-primary px-6 py-4 rounded-lg hover:bg-primary hover:text-white transition-colors"
              >
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
                <span class="block font-semibold">Inventory Report</span>
                <span class="block text-sm opacity-75">Current Stock</span>
              </button>
              <button
                id="exportCustomersBtn"
                class="bg-white border-2 border-primary text-primary px-6 py-4 rounded-lg hover:bg-primary hover:text-white transition-colors"
              >
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path>
                </svg>
                <span class="block font-semibold">Customer Report</span>
                <span class="block text-sm opacity-75">Download List</span>
              </button>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">
                Import Excel Sheet
              </h3>
              <input
                type="file"
                id="excelImportInput"
                accept=".xlsx,.xls"
                class="mb-4 block"
              />
              <div id="excelImportTableContainer" class="overflow-x-auto"></div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">
                Quick Statistics
              </h3>
              <div
                id="reportStats"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
              ></div>
            </div>
          </div>

          <!-- Medicine Reports Section -->
          <div id="medicine-reports-section" class="section hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">Medicine Reports</h2>
            
            <!-- Export Controls -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
              <h3 class="text-xl font-semibold text-gray-900 mb-4">Export Options</h3>
              <div class="flex flex-wrap gap-4">
                <button
                  id="exportMedicineInBtn"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors"
                >
                  Export Stock IN
                </button>
                <button
                  id="exportMedicineOutBtn"
                  class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
                >
                  Export Stock OUT
                </button>
                <button
                  id="exportMedicineStockBtn"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Export Current Stock
                </button>
                <button
                  id="exportFullMedicineReportBtn"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                >
                  Export Full Report
                </button>
              </div>
            </div>

            <!-- Medicine Reports Table -->
            <div class="bg-white rounded-lg shadow-sm border">
              <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h3 class="text-xl font-semibold text-gray-900">Medicine Movement Reports</h3>
                  <div class="flex gap-4">
                    <select id="medicineReportFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                      <option value="all">All Movements</option>
                      <option value="in">Stock IN</option>
                      <option value="out">Stock OUT</option>
                      <option value="current">Current Stock</option>
                    </select>
                    <input
                      type="date"
                      id="medicineReportDateFrom"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                      placeholder="From Date"
                    />
                    <input
                      type="date"
                      id="medicineReportDateTo"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                      placeholder="To Date"
                    />
                    <button
                      id="refreshMedicineReports"
                      class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors"
                    >
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicine</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Movement Type</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IN Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OUT Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                    </tr>
                  </thead>
                  <tbody id="medicineReportsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Medicine reports will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Medicine Modal -->
    <div id="medicineModal" class="modal">
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="medicineModalTitle"
            class="text-xl font-semibold text-gray-900"
          >
            Add Medicine
          </h3>
          <button
            id="closeMedicineModal"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <form id="medicineForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Medicine Name</label
              >
              <input
                id="medicineName"
                type="text"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Category</label
              >
              <select
                id="medicineCategory"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="">Select Category</option>
                <option value="Antibiotics">Antibiotics</option>
                <option value="Pain Relief">Pain Relief</option>
                <option value="Vitamins">Vitamins</option>
                <option value="Heart">Heart</option>
                <option value="Diabetes">Diabetes</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Stock Quantity</label
              >
              <input
                id="medicineStock"
                type="number"
                required
                min="0"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Expiry Date</label
              >
              <input
                id="medicineExpiry"
                type="date"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Price ($)</label
              >
              <input
                id="medicinePrice"
                type="number"
                required
                min="0"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="cancelMedicine"
              class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark"
            >
              Save Medicine
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="modal">
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="supplierModalTitle"
            class="text-xl font-semibold text-gray-900"
          >
            Add Supplier
          </h3>
          <button
            id="closeSupplierModal"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <form id="supplierForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Supplier Name</label
              >
              <input
                id="supplierName"
                type="text"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Contact Number</label
              >
              <input
                id="supplierContact"
                type="tel"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Supply Items</label
              >
              <textarea
                id="supplierItems"
                rows="3"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="e.g., Antibiotics, Pain Relief, Vitamins"
              ></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Email</label
              >
              <input
                id="supplierEmail"
                type="email"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="cancelSupplier"
              class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark"
            >
              Save Supplier
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="customerModalTitle"
            class="text-xl font-semibold text-gray-900"
          >
            Add Customer
          </h3>
          <button
            id="closeCustomerModal"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <form id="customerForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Customer Name</label
              >
              <input
                id="customerName"
                type="text"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Phone Number</label
              >
              <input
                id="customerPhone"
                type="tel"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Prescription Notes</label
              >
              <textarea
                id="customerNotes"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Medical conditions, allergies, etc."
              ></textarea>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="cancelCustomer"
              class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark"
            >
              Save Customer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
      <div
        class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 id="orderModalTitle" class="text-xl font-semibold text-gray-900">
            Create Order
          </h3>
          <button
            id="closeOrderModal"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <form id="orderForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Customer</label
              >
              <select
                id="orderCustomer"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="">Select Customer</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Medicines</label
              >
              <div
                id="orderMedicines"
                class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3"
              ></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div
                class="flex justify-between items-center text-lg font-semibold"
              >
                <span>Total Price:</span>
                <span id="orderTotal" class="text-primary">$0.00</span>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="cancelOrder"
              class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark"
            >
              Create Order
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#16A34A",
              "primary-dark": "#15803D",
              "primary-light": "#22C55E",
            },
          },
        },
      };

      // Medicine Reports: Fetch and display data from Supabase
      async function renderMedicineReports() {
        const tableBody = document.getElementById('medicineReportsTableBody');
        if (!tableBody) return;
        
        tableBody.innerHTML = `<tr><td colspan='9' class='px-6 py-4 text-gray-500 text-center'>Loading medicine reports...</td></tr>`;
        
        try {
          const medicines = await fetchMedicines();
          const orders = await fetchOrders();
          
          let html = '';
          
          // Process medicines data and create comprehensive reports
          medicines.forEach(med => {
            // Find related orders for this medicine
            const relatedOrders = orders.filter(order => 
              order.medicine_name && order.medicine_name.toLowerCase().includes(med.name.toLowerCase())
            );
            
            // Calculate current stock and movements
            const currentStock = med.stock || 0;
            const price = med.price || 0;
            const category = med.category || 'N/A';
            
            // Create a row for current stock status
            html += `<tr class="hover:bg-gray-50">
              <td class='px-6 py-4 font-medium text-gray-900'>${med.name}</td>
              <td class='px-6 py-4 text-gray-600'>${category}</td>
              <td class='px-6 py-4'>
                <span class='px-2 py-1 text-xs font-semibold rounded-full ${currentStock > 10 ? 'bg-green-100 text-green-800' : currentStock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}'>
                  Current Stock
                </span>
              </td>
              <td class='px-6 py-4 text-gray-900'>${currentStock}</td>
              <td class='px-6 py-4 text-gray-900'>$${price.toFixed(2)}</td>
              <td class='px-6 py-4 font-medium text-gray-900'>${currentStock}</td>
              <td class='px-6 py-4 text-gray-600'>${med.created_at ? new Date(med.created_at).toLocaleDateString() : '-'}</td>
              <td class='px-6 py-4 text-gray-600'>-</td>
              <td class='px-6 py-4 text-gray-600'>${med.supplier || '-'}</td>
            </tr>`;
            
            // Add rows for orders (OUT movements)
            relatedOrders.forEach(order => {
              html += `<tr class="hover:bg-gray-50 border-l-4 border-red-200">
                <td class='px-6 py-4 font-medium text-gray-900'>${med.name}</td>
                <td class='px-6 py-4 text-gray-600'>${category}</td>
                <td class='px-6 py-4'>
                  <span class='px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800'>
                    Stock OUT
                  </span>
                </td>
                <td class='px-6 py-4 text-red-600'>-${order.quantity || 1}</td>
                <td class='px-6 py-4 text-gray-900'>$${(order.total || price).toFixed(2)}</td>
                <td class='px-6 py-4 font-medium text-gray-900'>${currentStock}</td>
                <td class='px-6 py-4 text-gray-600'>-</td>
                <td class='px-6 py-4 text-gray-600'>${order.created_at ? new Date(order.created_at).toLocaleDateString() : '-'}</td>
                <td class='px-6 py-4 text-gray-600'>${order.customer_name || 'Customer'}</td>
              </tr>`;
            });
          });
          
          if (html === '') {
            tableBody.innerHTML = `<tr><td colspan='9' class='px-6 py-4 text-gray-500 text-center'>No medicine data found.</td></tr>`;
          } else {
            tableBody.innerHTML = html;
          }
          
        } catch (error) {
          console.error('Error loading medicine reports:', error);
          tableBody.innerHTML = `<tr><td colspan='9' class='px-6 py-4 text-red-500 text-center'>Error loading medicine reports. Please try again.</td></tr>`;
        }
      }

      // Show correct section and render medicine reports if needed
      function showSection(section) {
        // ...existing code...
        if (section === 'medicine-reports') {
          renderMedicineReports();
        }
      }

      // Enhanced Supabase Connection Test
      async function testSupabaseConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        if (statusDiv) {
          statusDiv.innerHTML = '<div class="text-yellow-600"><i class="fas fa-spinner fa-spin mr-2"></i>Testing connection...</div>';
        }
        
        console.log('Testing Supabase connection...');
        
        // Check if supabase client is available
        if (typeof supabase === 'undefined') {
          const errorMsg = 'Supabase client not found. Make sure supabase.js is loaded.';
          console.error('❌', errorMsg);
          if (statusDiv) {
            statusDiv.innerHTML = `
              <div class="text-red-600">
                <i class="fas fa-times-circle mr-2"></i>
                <strong>Supabase Client Error!</strong>
                <div class="mt-2 text-sm">${errorMsg}</div>
              </div>
            `;
          }
          return false;
        }
        
        console.log('Supabase client found, testing connection...');
        
        try {
          // Test 1: Basic connection
          const { data: medicinesData, error: medicinesError } = await supabase.from('medicines').select('*').limit(1);
          
          // Test 2: Check all tables
          const { data: suppliersData, error: suppliersError } = await supabase.from('suppliers').select('*').limit(1);
          const { data: customersData, error: customersError } = await supabase.from('customers').select('*').limit(1);
          const { data: ordersData, error: ordersError } = await supabase.from('orders').select('*').limit(1);
          
          let results = {
            medicines: { data: medicinesData, error: medicinesError },
            suppliers: { data: suppliersData, error: suppliersError },
            customers: { data: customersData, error: customersError },
            orders: { data: ordersData, error: ordersError }
          };
          
          console.log('Connection test results:', results);
          
          // Check if any errors occurred
          const errors = Object.entries(results).filter(([table, result]) => result.error);
          const successes = Object.entries(results).filter(([table, result]) => !result.error);
          
          if (errors.length === 0) {
            console.log('✅ Supabase connection successful! All tables accessible.');
            if (statusDiv) {
              statusDiv.innerHTML = `
                <div class="text-green-600">
                  <i class="fas fa-check-circle mr-2"></i>
                  <strong>Connection Successful!</strong>
                  <div class="mt-2 text-sm">
                    All tables accessible: ${successes.map(([table]) => table).join(', ')}
                  </div>
                </div>
              `;
            }
            return true;
          } else {
            console.error('❌ Some Supabase tables have errors:', errors);
            
            // Check if it's a "table not found" error (need to create tables)
            const missingTableErrors = errors.filter(([table, result]) => 
              result.error.message && result.error.message.includes('Could not find the table')
            );
            
            if (missingTableErrors.length > 0) {
              if (statusDiv) {
                statusDiv.innerHTML = `
                  <div class="text-orange-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Tables Missing!</strong>
                    <div class="mt-2 text-sm">
                      <div>Connection successful but tables need to be created.</div>
                      <div class="mt-2">
                        <strong>Missing tables:</strong> ${missingTableErrors.map(([table]) => table).join(', ')}
                      </div>
                      <div class="mt-2 text-blue-600">
                        📋 Run the SQL script in create-tables.sql file in your Supabase SQL Editor.
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              if (statusDiv) {
                statusDiv.innerHTML = `
                  <div class="text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Partial Connection Issues</strong>
                    <div class="mt-2 text-sm">
                      <div class="text-green-600">Working: ${successes.map(([table]) => table).join(', ')}</div>
                      <div class="text-red-600">Issues: ${errors.map(([table, result]) => `${table} (${result.error.message})`).join(', ')}</div>
                    </div>
                  </div>
                `;
              }
            }
            return false;
          }
          
        } catch (error) {
          console.error('❌ Supabase connection failed:', error);
          if (statusDiv) {
            statusDiv.innerHTML = `
              <div class="text-red-600">
                <i class="fas fa-times-circle mr-2"></i>
                <strong>Connection Failed!</strong>
                <div class="mt-2 text-sm">${error.message}</div>
              </div>
            `;
          }
          return false;
        }
      }

      // Helper functions for CRUD operations
      async function deleteMedicineById(id) {
        if (confirm('Are you sure you want to delete this medicine?')) {
          try {
            await deleteMedicine(id);
            renderMedicines(); // Refresh the list
            updateDashboardStats(); // Update stats
            alert('Medicine deleted successfully!');
          } catch (error) {
            console.error('Error deleting medicine:', error);
            alert('Failed to delete medicine. Please try again.');
          }
        }
      }

      async function deleteSupplierById(id) {
        if (confirm('Are you sure you want to delete this supplier?')) {
          try {
            await deleteSupplier(id);
            renderSuppliers(); // Refresh the list
            alert('Supplier deleted successfully!');
          } catch (error) {
            console.error('Error deleting supplier:', error);
            alert('Failed to delete supplier. Please try again.');
          }
        }
      }

      async function deleteCustomerById(id) {
        if (confirm('Are you sure you want to delete this customer?')) {
          try {
            await deleteCustomer(id);
            renderCustomers(); // Refresh the list
            alert('Customer deleted successfully!');
          } catch (error) {
            console.error('Error deleting customer:', error);
            alert('Failed to delete customer. Please try again.');
          }
        }
      }

      async function deleteOrderById(id) {
        if (confirm('Are you sure you want to delete this order?')) {
          try {
            await deleteOrder(id);
            renderOrders(); // Refresh the list
            updateDashboardStats(); // Update stats
            alert('Order deleted successfully!');
          } catch (error) {
            console.error('Error deleting order:', error);
            alert('Failed to delete order. Please try again.');
          }
        }
      }

      // Test connection on page load
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          testSupabaseConnection();
        }, 1000);
      });

      // Legacy connection test (keeping for compatibility)
      supabase.from('medicines').select('*').then(({ data, error }) => {
        if (error) {
          console.error('Supabase connection error:', error);
        } else {
          console.log('Supabase connection successful! Data:', data);
        }
      });
    </script>
  </body>
</html>
