<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Management - Nyina wa Jambo Pharmacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="notification-system.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      }
      .card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }
      .input-focus:focus {
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .notification.show {
        transform: translateX(0);
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.warning {
        background-color: #f59e0b;
      }
      .notification.info {
        background-color: #3b82f6;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      .sidebar {
        background: linear-gradient(180deg, #16a34a 0%, #15803d 100%);
      }
      .table-container {
        max-height: 600px;
        overflow-y: auto;
      }
      .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background-color: #f9fafb;
      }
      .file-upload-area.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .file-upload-area:hover {
        border-color: #9ca3af;
      }
      .progress-bar {
        background-color: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        height: 8px;
      }
      .progress-fill {
        background-color: #10b981;
        height: 100%;
        transition: width 0.3s ease;
      }
      .btn-primary {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .btn-secondary {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .btn-secondary:hover:not(:disabled) {
        background: #f9fafb;
        border-color: #9ca3af;
      }
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .import-step {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
      }
      .import-step.active {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .import-step.completed {
        border-color: #10b981;
        background-color: #ecfdf5;
      }

      /* Category-specific field styling */
      .category-fields {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }
      
      .category-fields h3 {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #medicinesFields {
        border-left-color: #22c55e;
      }

      #suppliesFields {
        border-left-color: #3b82f6;
      }

      #equipmentFields {
        border-left-color: #8b5cf6;
      }

      #othersFields {
        border-left-color: #f59e0b;
      }

      /* Dynamic modal animations */
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }

      /* Role-based visibility */
      .admin-only {
        display: none !important;
      }
      .receptionist-only {
        display: none !important;
      }
      .customer-only {
        display: none !important;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-100">
    <div id="notificationContainer"></div>
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-64 bg-green-800 text-white flex-shrink-0 hidden lg:block">
        <div class="p-6">
          <a href="dashboard.html" class="text-2xl font-bold text-white flex items-center">
            <i class="fas fa-pills mr-3"></i>
            <span>Nyina wa Jambo</span>
          </a>
        </div>
        <nav class="mt-6">
          <a href="dashboard.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors">
            <i class="fas fa-tachometer-alt w-6 text-center"></i>
            <span class="ml-4">Dashboard</span>
          </a>
          <a href="inventory.html" class="flex items-center py-3 px-6 bg-green-600 text-white receptionist-only">
            <i class="fas fa-boxes w-6 text-center"></i>
            <span class="ml-4">Inventory</span>
          </a>
          <a href="suppliers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-truck w-6 text-center"></i>
            <span class="ml-4">Suppliers</span>
          </a>
          <a href="customers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors">
            <i class="fas fa-users w-6 text-center"></i>
            <span class="ml-4">Customers</span>
          </a>
          <a href="orders.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
            <i class="fas fa-shopping-cart w-6 text-center"></i>
            <span class="ml-4">Orders</span>
          </a>
          <a href="user-management.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-user-cog w-6 text-center"></i>
            <span class="ml-4">User Management</span>
          </a>
          <a href="reports.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-chart-line w-6 text-center"></i>
            <span class="ml-4">Reports</span>
          </a>
          <a href="cash-book.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-book w-6 text-center"></i>
            <span class="ml-4">Cash Book</span>
          </a>
        </nav>
        <div class="mt-auto p-6 bottom-0">
          <button onclick="signOut()" class="w-full flex items-center justify-center py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <i class="fas fa-sign-out-alt mr-2"></i>
            <span>Logout</span>
          </button>
        </div>
      </aside>

      <!-- Main content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top bar -->
        <header class="bg-white shadow-sm flex justify-between items-center p-4">
          <button id="menu-toggle" class="text-gray-700 lg:hidden">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-xl font-semibold text-gray-800 hidden lg:block">
            Inventory Management
          </h1>

          <div class="flex items-center space-x-4">
            <div class="relative">
              <button id="userAvatar" class="flex items-center space-x-2">
                <img id="avatarImg" src="" alt="User Avatar" class="w-10 h-10 rounded-full" />
                <span id="currentUser" class="text-gray-700 font-medium hidden md:block"></span>
              </button>
              <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 hidden">
                <div class="py-1">
                  <div class="px-4 py-2 text-sm text-gray-500 border-b">
                    <span id="userInfo"></span>
                  </div>
                  <!-- <a href="index.html?home=true" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-home mr-2"></i>Home Page
                  </a> -->
                  <button onclick="signOut()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main content area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          <div class="container mx-auto">
            <!-- Page Header -->
            <div class="mb-8">
              <div class="flex justify-between items-center">
                <div>
                  <h1 class="text-3xl font-bold text-gray-900">Inventory Management</h1>
                  <p class="text-gray-600 mt-2">Comprehensive inventory tracking for medicines, supplies, equipment, and more</p>
                </div>
                <div class="flex gap-3">
                  <button id="importBtn" class="btn-primary admin-only">
                    <i class="fas fa-file-excel"></i>Bulk Import
                  </button>
                </div>
              </div>
            </div>

            <!-- Inventory Categories Guide -->
            <div class="card rounded-lg shadow-sm p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">üìã Inventory Categories</h2>
                <button id="toggleCategoriesGuide" class="text-sm text-blue-600 hover:text-blue-800">
                  <i class="fas fa-chevron-up" id="categoriesIcon"></i> Hide Guide
                </button>
              </div>
              <div id="categoriesGuide" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Medicines Category -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="flex items-center mb-3">
                    <span class="text-2xl mr-2">üíä</span>
                    <h3 class="font-semibold text-green-800">Medicines</h3>
                  </div>
                  <p class="text-sm text-green-700 mb-3">Pharmaceutical products intended to diagnose, treat, cure, or prevent disease.</p>
                  <div class="text-xs text-green-600">
                    <p class="font-medium mb-1">Examples:</p>
                    <ul class="space-y-1">
                      <li>‚Ä¢ Antibiotics (Amoxicillin, Azithromycin)</li>
                      <li>‚Ä¢ Painkillers (Paracetamol, Ibuprofen)</li>
                      <li>‚Ä¢ Antimalarials (Artemether-Lumefantrine)</li>
                      <li>‚Ä¢ Vaccines, Insulin, Syrups</li>
                    </ul>
                    <p class="font-medium mt-2 text-green-800">Notes: Controlled by regulations, require expiry tracking, prescription status, batch numbers.</p>
                  </div>
                </div>

                <!-- Supplies Category -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div class="flex items-center mb-3">
                    <span class="text-2xl mr-2">üß¥</span>
                    <h3 class="font-semibold text-blue-800">Supplies</h3>
                  </div>
                  <p class="text-sm text-blue-700 mb-3">Consumable items used in treatment but are not medicines.</p>
                  <div class="text-xs text-blue-600">
                    <p class="font-medium mb-1">Examples:</p>
                    <ul class="space-y-1">
                      <li>‚Ä¢ Gloves, Masks, Cotton, Bandages</li>
                      <li>‚Ä¢ Alcohol swabs, Syringes, Needles</li>
                      <li>‚Ä¢ IV fluid sets, Catheters</li>
                      <li>‚Ä¢ Gauze, Adhesive tape</li>
                    </ul>
                    <p class="font-medium mt-2 text-blue-800">Notes: Often needed in bulk, track stock levels, sterile vs. non-sterile distinction.</p>
                  </div>
                </div>

                <!-- Equipment Category -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                  <div class="flex items-center mb-3">
                    <span class="text-2xl mr-2">ü©∫</span>
                    <h3 class="font-semibold text-purple-800">Equipment</h3>
                  </div>
                  <p class="text-sm text-purple-700 mb-3">Reusable medical devices or tools used for diagnosis, monitoring, or treatment.</p>
                  <div class="text-xs text-purple-600">
                    <p class="font-medium mb-1">Examples:</p>
                    <ul class="space-y-1">
                      <li>‚Ä¢ Thermometers, BP machines</li>
                      <li>‚Ä¢ Glucometers, Nebulizers</li>
                      <li>‚Ä¢ Scales, Stethoscopes</li>
                      <li>‚Ä¢ Pulse oximeters</li>
                    </ul>
                    <p class="font-medium mt-2 text-purple-800">Notes: Not consumed, require maintenance/calibration, higher cost, lower turnover.</p>
                  </div>
                </div>

                <!-- Others Category -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                  <div class="flex items-center mb-3">
                    <span class="text-2xl mr-2">üõçÔ∏è</span>
                    <h3 class="font-semibold text-orange-800">Others</h3>
                  </div>
                  <p class="text-sm text-orange-700 mb-3">Items that don't fit neatly into the above categories.</p>
                  <div class="text-xs text-orange-600">
                    <p class="font-medium mb-1">Examples:</p>
                    <ul class="space-y-1">
                      <li>‚Ä¢ Baby formula, Diapers</li>
                      <li>‚Ä¢ Nutritional supplements, Vitamins</li>
                      <li>‚Ä¢ Cosmetics, Soap, Lotion</li>
                      <li>‚Ä¢ Bottled water, Snacks</li>
                    </ul>
                    <p class="font-medium mt-2 text-orange-800">Notes: Adds flexibility for non-medical items sold in pharmacy.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters and Search -->
            <div class="card rounded-lg shadow-sm p-6 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Search Inventory</label>
                  <input type="text" id="medicineSearch" placeholder="Search by name, code, or category..." class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
                  <select id="categoryFilter" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                    <option value="">All Categories</option>
                    <option value="Medicines">üíä Medicines</option>
                    <option value="Supplies">üß¥ Supplies</option>
                    <option value="Equipment">ü©∫ Equipment</option>
                    <option value="Others">üõçÔ∏è Others</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button id="exportBtn" class="btn-secondary">
                    <i class="fas fa-download"></i>Export Excel
                  </button>
                </div>
              </div>
            </div>

            <!-- Category-Based Inventory Sections -->
            
            <!-- Medicines Section -->
            <div id="medicinesSection" class="card rounded-lg shadow-sm overflow-hidden mb-6">
              <div class="bg-green-50 border-b border-green-200 px-6 py-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">üíä</span>
                    <div>
                      <h3 class="text-lg font-semibold text-green-800">Medicines</h3>
                      <p class="text-sm text-green-600">Pharmaceutical products for treatment</p>
                    </div>
                  </div>
                  <button id="addMedicineBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Medicine
                  </button>
                </div>
              </div>
              <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selling Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="medicinesTable" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <!-- Supplies Section -->
            <div id="suppliesSection" class="card rounded-lg shadow-sm overflow-hidden mb-6">
              <div class="bg-blue-50 border-b border-blue-200 px-6 py-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">üß¥</span>
                    <div>
                      <h3 class="text-lg font-semibold text-blue-800">Medical Supplies</h3>
                      <p class="text-sm text-blue-600">Consumable medical items</p>
                    </div>
                  </div>
                  <button id="addSupplyBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Supply
                  </button>
                </div>
              </div>
              <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="suppliesTable" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <!-- Equipment Section -->
            <div id="equipmentSection" class="card rounded-lg shadow-sm overflow-hidden mb-6">
              <div class="bg-purple-50 border-b border-purple-200 px-6 py-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">ü©∫</span>
                    <div>
                      <h3 class="text-lg font-semibold text-purple-800">Medical Equipment</h3>
                      <p class="text-sm text-purple-600">Reusable medical devices</p>
                    </div>
                  </div>
                  <button id="addEquipmentBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Equipment
                  </button>
                </div>
              </div>
              <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model/Brand</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="equipmentTable" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <!-- Others Section -->
            <div id="othersSection" class="card rounded-lg shadow-sm overflow-hidden mb-6">
              <div class="bg-orange-50 border-b border-orange-200 px-6 py-4">
                <div class="flex justify-between items-center">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">üõçÔ∏è</span>
                    <div>
                      <h3 class="text-lg font-semibold text-orange-800">Other Items</h3>
                      <p class="text-sm text-orange-600">Non-medical items and supplements</p>
                    </div>
                  </div>
                  <button id="addOtherBtn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Item
                  </button>
                </div>
              </div>
              <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="othersTable" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Dynamic Inventory Modal -->
    <div id="medicineModal" class="modal">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
          <h2 id="medicineModalTitle" class="text-xl font-semibold">Add Inventory Item</h2>
          <button id="closeMedicineModal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <form id="medicineForm" class="space-y-6">
          <!-- Common Fields for All Categories -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Item Code</label>
                <input type="text" id="medicineCode" required class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., MED001, SUP001, EQP001" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Item Name</label>
                <input type="text" id="medicineName" required class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Paracetamol, Gloves, Thermometer" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Inventory Category</label>
                <select id="medicineCategory" required class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" onchange="toggleCategoryFields(this.value)">
                  <option value="">Select Category</option>
                  <option value="Medicines">üíä Medicines - Pharmaceutical products for treatment</option>
                  <option value="Supplies">üß¥ Supplies - Consumable medical items</option>
                  <option value="Equipment">ü©∫ Equipment - Reusable medical devices</option>
                  <option value="Others">üõçÔ∏è Others - Non-medical items and supplements</option>
                </select>
                <div id="categoryDescription" class="mt-2 text-sm text-gray-600 hidden"></div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="medicineDescription" rows="3" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="Detailed description of the item"></textarea>
              </div>
            </div>
          </div>

          <!-- Medicines-Specific Fields -->
          <div id="medicinesFields" class="category-fields bg-green-50 p-4 rounded-lg hidden">
            <h3 class="text-lg font-medium text-green-800 mb-4">üè• Medicine Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Generic Name</label>
                <input type="text" id="genericName" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Acetaminophen" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Brand Name</label>
                <input type="text" id="brandName" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Panadol" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Dosage Form</label>
                <select id="dosageForm" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Dosage Form</option>
                  <option value="tablet">Tablet</option>
                  <option value="capsule">Capsule</option>
                  <option value="syrup">Syrup</option>
                  <option value="injection">Injection</option>
                  <option value="cream">Cream</option>
                  <option value="ointment">Ointment</option>
                  <option value="drops">Drops</option>
                  <option value="inhaler">Inhaler</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Strength/Concentration</label>
                <input type="text" id="strength" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 500mg, 250mg/5ml" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Batch Number</label>
                <input type="text" id="batchNumber" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., BT123456" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Manufacturer</label>
                <input type="text" id="manufacturer" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Pfizer, GSK" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date <span class="text-red-500">*</span></label>
                <input type="date" id="medicineExpiry" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Storage Conditions</label>
                <select id="storageConditions" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Storage Condition</option>
                  <option value="room_temperature">Room Temperature (15-25¬∞C)</option>
                  <option value="cool_dry">Cool & Dry Place</option>
                  <option value="refrigerated">Refrigerated (2-8¬∞C)</option>
                  <option value="frozen">Frozen (-18¬∞C or below)</option>
                  <option value="controlled_room">Controlled Room Temperature</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="flex items-center">
                  <input type="checkbox" id="requiresPrescription" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded mr-2" />
                  <span class="text-sm font-medium text-gray-700">Requires Prescription</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Supplies-Specific Fields -->
          <div id="suppliesFields" class="category-fields bg-blue-50 p-4 rounded-lg hidden">
            <h3 class="text-lg font-medium text-blue-800 mb-4">üß¥ Supply Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Supply Type</label>
                <select id="supplyType" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Supply Type</option>
                  <option value="disposable">Disposable</option>
                  <option value="consumable">Consumable</option>
                  <option value="protective">Protective Equipment</option>
                  <option value="surgical">Surgical Supplies</option>
                  <option value="diagnostic">Diagnostic Supplies</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Material</label>
                <input type="text" id="material" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Latex, Nitrile, Cotton" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Size/Specification</label>
                <input type="text" id="sizeSpec" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Large, Medium, Small, 10ml" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Package Quantity</label>
                <input type="number" id="packageQty" min="1" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 100 pieces per box" />
              </div>
              <div>
                <label class="flex items-center">
                  <input type="checkbox" id="isSterile" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2" />
                  <span class="text-sm font-medium text-gray-700">Sterile Product</span>
                </label>
              </div>
              <div>
                <label class="flex items-center">
                  <input type="checkbox" id="isSingleUse" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2" />
                  <span class="text-sm font-medium text-gray-700">Single Use Only</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Equipment-Specific Fields -->
          <div id="equipmentFields" class="category-fields bg-purple-50 p-4 rounded-lg hidden">
            <h3 class="text-lg font-medium text-purple-800 mb-4">ü©∫ Equipment Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Type</label>
                <select id="equipmentType" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Equipment Type</option>
                  <option value="diagnostic">Diagnostic Equipment</option>
                  <option value="therapeutic">Therapeutic Equipment</option>
                  <option value="monitoring">Monitoring Equipment</option>
                  <option value="surgical">Surgical Equipment</option>
                  <option value="laboratory">Laboratory Equipment</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
                <input type="text" id="serialNumber" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., SN123456789" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Model Number</label>
                <input type="text" id="modelNumber" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., MDL-2024" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Warranty Expiry</label>
                <input type="date" id="warrantyExpiry" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Schedule</label>
                <select id="maintenanceSchedule" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Schedule</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="annually">Annually</option>
                  <option value="as_needed">As Needed</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Last Maintenance Date</label>
                <input type="date" id="lastMaintenanceDate" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Calibration Due Date</label>
                <input type="date" id="calibrationDue" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" />
              </div>
              <div>
                <label class="flex items-center">
                  <input type="checkbox" id="requiresCalibration" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded mr-2" />
                  <span class="text-sm font-medium text-gray-700">Requires Regular Calibration</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Others-Specific Fields -->
          <div id="othersFields" class="category-fields bg-orange-50 p-4 rounded-lg hidden">
            <h3 class="text-lg font-medium text-orange-800 mb-4">üõçÔ∏è Other Item Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Item Type</label>
                <select id="otherItemType" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Item Type</option>
                  <option value="supplement">Health Supplement</option>
                  <option value="cosmetic">Cosmetic Product</option>
                  <option value="baby_care">Baby Care</option>
                  <option value="personal_care">Personal Care</option>
                  <option value="office_supply">Office Supply</option>
                  <option value="cleaning">Cleaning Supply</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Target Demographic</label>
                <select id="targetDemographic" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Target</option>
                  <option value="adults">Adults</option>
                  <option value="children">Children</option>
                  <option value="elderly">Elderly</option>
                  <option value="pregnant">Pregnant Women</option>
                  <option value="all_ages">All Ages</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Shelf Life (months)</label>
                <input type="number" id="shelfLife" min="1" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 24 months" />
              </div>
              <div>
                <label class="flex items-center">
                  <input type="checkbox" id="isOTC" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded mr-2" />
                  <span class="text-sm font-medium text-gray-700">Over-the-Counter (OTC)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Common Pricing and Inventory Fields -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-900 mb-4">üí∞ Pricing & Inventory</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Price (RWF)</label>
                <input type="number" id="costPrice" min="0" step="0.01" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 1000" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Selling Price (RWF) <span class="text-red-500">*</span></label>
                <input type="number" id="sellingPrice" required min="0" step="0.01" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 1500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Stock <span class="text-red-500">*</span></label>
                <input type="number" id="medicineStock" required min="0" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 100" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Unit of Measurement</label>
                <select id="unit" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Unit</option>
                  <option value="pieces">Pieces</option>
                  <option value="bottles">Bottles</option>
                  <option value="tubes">Tubes</option>
                  <option value="boxes">Boxes</option>
                  <option value="packs">Packs</option>
                  <option value="sets">Sets</option>
                  <option value="rolls">Rolls</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Stock Level</label>
                <input type="number" id="minStockLevel" min="0" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 10" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Stock Level</label>
                <input type="number" id="maxStockLevel" min="0" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Supplier</label>
                <select id="medicineSupplier" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Supplier</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sale Type</label>
                <select id="saleType" required class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors">
                  <option value="">Select Sale Type</option>
                  <option value="Private">Private</option>
                  <option value="Mutuel">Mutuel</option>
                  <option value="Both">Both</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end space-x-4 pt-6 border-t">
            <button type="button" onclick="closeMedicineModal()" class="px-6 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              Cancel
            </button>
            <button type="submit" id="saveMedicineBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
              <span class="btn-text">Save Item</span>
              <div class="loading-spinner hidden ml-2">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </button>
          </div>
        </form>
      </div>
    </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Max Stock Level</label>
              <input type="number" id="maxStockLevel" min="0" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., 1000" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
              <textarea id="medicineDescription" rows="3" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="Enter medicine description"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Storage Conditions</label>
              <textarea id="storageConditions" rows="3" class="input-focus w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none transition-colors" placeholder="e.g., Store at room temperature"></textarea>
            </div>
          </div>
          <div class="flex justify-end space-x-4 mt-6">
            <button type="button" id="cancelMedicine" class="btn-secondary">Cancel</button>
            <button type="submit" id="saveMedicineBtn" class="btn-primary">
              <span class="btn-text">Save Medicine</span>
              <div class="loading-spinner hidden"></div>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
      <div class="modal-content max-w-4xl">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Bulk Import Medicines</h2>
          <button id="closeImportModal" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Import Steps -->
        <div class="mb-6">
          <div class="import-step active" id="step1">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium">1</div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Upload Excel File</h3>
                <p class="text-sm text-gray-500">Select your Excel file containing medicine data</p>
              </div>
            </div>
          </div>
          <div class="import-step" id="step2">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-medium">2</div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Review Data</h3>
                <p class="text-sm text-gray-500">Preview and validate imported data</p>
              </div>
            </div>
          </div>
          <div class="import-step" id="step3">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-medium">3</div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Import Complete</h3>
                <p class="text-sm text-gray-500">Save data to database</p>
              </div>
            </div>
          </div>
        </div>

        <!-- File Upload Section -->
        <div id="uploadSection">
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">Excel Format Requirements</h3>
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <p class="text-sm text-blue-800 mb-2">Your Excel file should contain the following columns:</p>
              <div class="grid grid-cols-2 gap-2 text-xs text-blue-700">
                <span>‚Ä¢ medicine_code</span>
                <span>‚Ä¢ name</span>
                <span>‚Ä¢ generic_name</span>
                <span>‚Ä¢ brand_name</span>
                <span>‚Ä¢ category_id</span>
                <span>‚Ä¢ dosage_form</span>
                <span>‚Ä¢ strength</span>
                <span>‚Ä¢ unit</span>
                <span>‚Ä¢ cost_price</span>
                <span>‚Ä¢ selling_price</span>
                <span>‚Ä¢ stock</span>
                <span>‚Ä¢ supplier_id</span>
                <span>‚Ä¢ sale_type</span>
                <span>‚Ä¢ requires_prescription</span>
                <span>‚Ä¢ expiry_date</span>
                <span>‚Ä¢ batch_number</span>
                <span>‚Ä¢ manufacturer</span>
                <span>‚Ä¢ min_stock_level</span>
                <span>‚Ä¢ max_stock_level</span>
                <span>‚Ä¢ description</span>
                <span>‚Ä¢ storage_conditions</span>
              </div>
            </div>
          </div>
          
          <div class="file-upload-area" id="fileUploadArea">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag and drop your Excel file here</p>
            <p class="text-sm text-gray-500 mb-4">or click to browse files</p>
            <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" />
            <button type="button" id="browseBtn" class="btn-secondary">
              <i class="fas fa-folder-open"></i>Browse Files
            </button>
          </div>
          
          <div id="fileInfo" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-file-excel text-green-600 mr-3"></i>
              <div>
                <p class="text-sm font-medium text-green-800" id="fileName"></p>
                <p class="text-xs text-green-600" id="fileSize"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="hidden">
          <h3 class="text-lg font-semibold mb-4">Data Preview</h3>
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600" id="previewCount"></span>
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">Validation:</span>
                <span id="validationStatus" class="px-2 py-1 rounded-full text-xs font-medium"></span>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto max-h-96 border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr id="previewTableHead"></tr>
              </thead>
              <tbody id="previewTableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
          <div id="validationErrors" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <h4 class="text-sm font-medium text-red-800 mb-2">Validation Errors:</h4>
            <ul id="errorList" class="text-sm text-red-700 list-disc list-inside"></ul>
          </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="hidden">
          <h3 class="text-lg font-semibold mb-4">Import Progress</h3>
          <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
              <span>Importing medicines...</span>
              <span id="progressText">0%</span>
            </div>
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <div id="importResults" class="hidden">
            <div class="grid grid-cols-3 gap-4 text-center">
              <div class="p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600" id="successCount">0</div>
                <div class="text-sm text-green-600">Successful</div>
              </div>
              <div class="p-4 bg-red-50 rounded-lg">
                <div class="text-2xl font-bold text-red-600" id="errorCount">0</div>
                <div class="text-sm text-red-600">Errors</div>
              </div>
              <div class="p-4 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                <div class="text-sm text-blue-600">Total</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 mt-6 pt-6 border-t border-gray-200">
          <button type="button" id="cancelImport" class="btn-secondary">
            <i class="fas fa-times"></i>Cancel
          </button>
          <button type="button" id="downloadTemplate" class="btn-secondary">
            <i class="fas fa-download"></i>Download Template
          </button>
          <button type="button" id="submitImportBtn" class="btn-primary" disabled>
            <span class="btn-text">Import Data</span>
            <div class="loading-spinner hidden"></div>
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentEditId = null;
      let categories = [];
      let suppliers = [];
      let importData = [];
      let currentStep = 1;

      async function logout() {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          window.location.href = "login.html";
        } catch (error) {
          showError("Error signing out: " + error.message);
        }
      }

      function showNotification(message, type, container) {
        const notification = document.createElement("div");
        notification.className = `notification ${type} show`;
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>
            <span>${message}</span>
          </div>
        `;
        container.appendChild(notification);
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      function updateImportStep(step) {
        const steps = [1, 2, 3];
        steps.forEach(s => {
          const stepEl = document.getElementById(`step${s}`);
          const circle = stepEl.querySelector('.w-8');
          if (s < step) {
            stepEl.classList.remove('active');
            stepEl.classList.add('completed');
            circle.classList.remove('bg-blue-500', 'bg-gray-300');
            circle.classList.add('bg-green-500');
            circle.innerHTML = '<i class="fas fa-check text-white"></i>';
          } else if (s === step) {
            stepEl.classList.add('active');
            stepEl.classList.remove('completed');
            circle.classList.remove('bg-gray-300', 'bg-green-500');
            circle.classList.add('bg-blue-500');
            circle.textContent = s;
          } else {
            stepEl.classList.remove('active', 'completed');
            circle.classList.remove('bg-blue-500', 'bg-green-500');
            circle.classList.add('bg-gray-300');
            circle.textContent = s;
          }
        });
        currentStep = step;
      }

      async function init() {
        try {
          if (!(await isAuthenticated())) {
            window.location.href = "login.html";
            return;
          }
          const profile = await getUserProfile();
          if (!profile || (profile.role !== "admin" && profile.role !== "receptionist")) {
            showNotification("Access denied. Admin or receptionist privileges required.", "error", document.getElementById("notificationContainer"));
            setTimeout(() => signOut(), 2000);
            return;
          }
          await loadCategories();
          await loadSuppliers();
          updateNavigation(profile);
          renderMedicines();
          setupEventListeners();
        } catch (error) {
          console.error("Initialization error:", error);
          showNotification("Initialization error: " + error.message, "error", document.getElementById("notificationContainer"));
        }
      }

      async function loadCategories() {
        try {
          const data = await supabase.from("medicine_categories").select("id, name").eq("is_active", true).order("name");
          categories = data.data || [];
          const select = document.getElementById("medicineCategory");
          const filter = document.getElementById("categoryFilter");
          select.innerHTML = '<option value="">Select Category</option>' + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
          filter.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
        } catch (error) {
          showNotification("Error loading categories: " + error.message, "error", document.getElementById("notificationContainer"));
        }
      }

      async function loadSuppliers() {
        try {
          const data = await fetchSuppliers();
          suppliers = data || [];
          const select = document.getElementById("medicineSupplier");
          select.innerHTML = '<option value="">Select Supplier</option>' + suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
        } catch (error) {
          showNotification("Error loading suppliers: " + error.message, "error", document.getElementById("notificationContainer"));
        }
      }

      function updateNavigation(profile) {
        try {
          if (profile) {
            document.getElementById("currentUser").textContent = profile.full_name || 'User';
            document.getElementById("userInfo").textContent = `${profile.full_name || 'User'} (${profile.role || 'staff'})`;
            
            const avatarImg = document.getElementById("avatarImg");
            if (avatarImg) {
              avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.full_name || 'User')}&background=16a34a&color=fff&bold=true`;
            }
            
            document.querySelectorAll(".admin-only").forEach(el => {
              el.style.setProperty('display', profile.role === "admin" ? "flex" : "none", 'important');
            });
            document.querySelectorAll(".receptionist-only").forEach(el => {
              el.style.setProperty('display', 
                profile.role === "admin" || profile.role === "receptionist" ? "flex" : "none", 
                'important');
            });
          } else {
            document.getElementById("currentUser").textContent = 'Guest';
            document.getElementById("userInfo").textContent = 'Guest User';
          }
        } catch (error) {
          console.error('Error updating navigation:', error);
          document.getElementById("currentUser").textContent = 'User';
          document.getElementById("userInfo").textContent = 'User';
        }
      }

      function setupEventListeners() {
        // Category-specific add button event listeners
        document.getElementById("addMedicineBtn").addEventListener("click", () => openMedicineModal(null, "Medicines"));
        document.getElementById("addSupplyBtn").addEventListener("click", () => openMedicineModal(null, "Supplies"));
        document.getElementById("addEquipmentBtn").addEventListener("click", () => openMedicineModal(null, "Equipment"));
        document.getElementById("addOtherBtn").addEventListener("click", () => openMedicineModal(null, "Others"));
        
        // Modal and form event listeners
        document.getElementById("closeMedicineModal").addEventListener("click", closeMedicineModal);
        document.getElementById("cancelMedicine").addEventListener("click", closeMedicineModal);
        document.getElementById("medicineForm").addEventListener("submit", saveMedicine);
        document.getElementById("medicineSearch").addEventListener("input", renderMedicines);
        document.getElementById("categoryFilter").addEventListener("change", renderMedicines);
        document.getElementById("exportBtn").addEventListener("click", exportToExcel);

        // Category guide toggle
        document.getElementById("toggleCategoriesGuide").addEventListener("click", toggleCategoriesGuide);
        
        // Category selection handler for form
        document.getElementById("medicineCategory").addEventListener("change", handleCategorySelection);

        // Import event listeners
        const importBtn = document.getElementById("importBtn");
        importBtn.addEventListener("click", async () => {
          try {
            const profile = await getUserProfile();
            if (profile?.role === "admin") {
              openImportModal();
            } else {
              showNotification("Access denied. Only admins can import data.", "error", document.getElementById("notificationContainer"));
            }
          } catch (error) {
            showNotification("Error checking user role: " + error.message, "error", document.getElementById("notificationContainer"));
          }
        });

        document.getElementById("closeImportModal").addEventListener("click", closeImportModal);
        document.getElementById("cancelImport").addEventListener("click", closeImportModal);
        
        // File upload handlers
        const fileInput = document.getElementById("excelFile");
        const browseBtn = document.getElementById("browseBtn");
        const uploadArea = document.getElementById("fileUploadArea");

        browseBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", handleFileSelect);

        // Drag and drop handlers
        uploadArea.addEventListener("dragover", handleDragOver);
        uploadArea.addEventListener("dragleave", handleDragLeave);
        uploadArea.addEventListener("drop", handleFileDrop);

        document.getElementById("submitImportBtn").addEventListener("click", saveImportedData);
        document.getElementById("downloadTemplate").addEventListener("click", downloadTemplate);

        // Navigation event listeners
        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        menuToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          sidebar.classList.toggle("hidden");
        });

        const userAvatar = document.getElementById("userAvatar");
        const userDropdown = document.getElementById("userDropdown");
        userAvatar.addEventListener("click", (e) => {
          e.stopPropagation();
          userDropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", (e) => {
          if (!sidebar.classList.contains("hidden") && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
            sidebar.classList.add("hidden");
          }
          if (!userDropdown.classList.contains("hidden") && !userAvatar.contains(e.target)) {
            userDropdown.classList.add("hidden");
          }
        });
      }

      // File handling functions
      function handleDragOver(e) {
        e.preventDefault();
        document.getElementById("fileUploadArea").classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        document.getElementById("fileUploadArea").classList.remove("dragover");
      }

      function handleFileDrop(e) {
        e.preventDefault();
        document.getElementById("fileUploadArea").classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById("excelFile").files = files;
          handleFileSelect({ target: { files } });
        }
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
        if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
          showNotification("Please select a valid Excel file (.xlsx or .xls)", "error", document.getElementById("notificationContainer"));
          return;
        }

        // Show file info
        const fileInfo = document.getElementById("fileInfo");
        const fileName = document.getElementById("fileName");
        const fileSize = document.getElementById("fileSize");
        
        fileName.textContent = file.name;
        fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
        fileInfo.classList.remove("hidden");

        // Process file
        processExcelFile(file);
      }

      async function processExcelFile(file) {
        try {
          showNotification("Processing Excel file...", "info", document.getElementById("notificationContainer"));
          
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const data = new Uint8Array(event.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
              
              if (!jsonData.length) {
                showNotification("Excel sheet is empty or has no data rows.", "error", document.getElementById("notificationContainer"));
                return;
              }

              importData = jsonData;
              validateAndPreviewData(jsonData);
              updateImportStep(2);
              
              // Show preview section and hide upload section
              document.getElementById("uploadSection").classList.add("hidden");
              document.getElementById("previewSection").classList.remove("hidden");
              
            } catch (error) {
              showNotification("Error processing Excel file: " + error.message, "error", document.getElementById("notificationContainer"));
            }
          };
          
          reader.onerror = () => {
            showNotification("Error reading file.", "error", document.getElementById("notificationContainer"));
          };
          
          reader.readAsArrayBuffer(file);
        } catch (error) {
          showNotification("Error processing file: " + error.message, "error", document.getElementById("notificationContainer"));
        }
      }

      function validateAndPreviewData(data) {
        const requiredFields = ['name', 'selling_price', 'sale_type'];
        const errors = [];
        let validRows = 0;

        // Validate data
        data.forEach((row, index) => {
          const rowNumber = index + 1;
          
          // Check required fields
          requiredFields.forEach(field => {
            if (!row[field] || String(row[field]).trim() === '') {
              errors.push(`Row ${rowNumber}: Missing required field '${field}'`);
            }
          });

          // Validate price fields
          if (row.selling_price && (isNaN(parseFloat(row.selling_price)) || parseFloat(row.selling_price) < 0)) {
            errors.push(`Row ${rowNumber}: Invalid selling price`);
          }
          
          if (row.cost_price && (isNaN(parseFloat(row.cost_price)) || parseFloat(row.cost_price) < 0)) {
            errors.push(`Row ${rowNumber}: Invalid cost price`);
          }

          // Validate stock
          if (row.stock && (isNaN(parseInt(row.stock)) || parseInt(row.stock) < 0)) {
            errors.push(`Row ${rowNumber}: Invalid stock quantity`);
          }

          // Validate sale type
          if (row.sale_type && !['Private', 'Mutuel', 'Both'].includes(row.sale_type)) {
            errors.push(`Row ${rowNumber}: Invalid sale type. Must be 'Private', 'Mutuel', or 'Both'`);
          }

          if (errors.length === 0 || errors.filter(e => e.includes(`Row ${rowNumber}:`)).length === 0) {
            validRows++;
          }
        });

        // Update preview count and validation status
        document.getElementById("previewCount").textContent = `${data.length} rows found, ${validRows} valid`;
        
        const validationStatus = document.getElementById("validationStatus");
        const validationErrors = document.getElementById("validationErrors");
        const submitBtn = document.getElementById("submitImportBtn");

        if (errors.length === 0) {
          validationStatus.className = "px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800";
          validationStatus.textContent = "‚úì Valid";
          validationErrors.classList.add("hidden");
          submitBtn.disabled = false;
        } else {
          validationStatus.className = "px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800";
          validationStatus.textContent = "‚úó Errors Found";
          
          const errorList = document.getElementById("errorList");
          errorList.innerHTML = errors.slice(0, 10).map(error => `<li>${error}</li>`).join("");
          if (errors.length > 10) {
            errorList.innerHTML += `<li class="font-medium">... and ${errors.length - 10} more errors</li>`;
          }
          validationErrors.classList.remove("hidden");
          submitBtn.disabled = true;
        }

        // Render preview table
        renderPreviewTable(data.slice(0, 50)); // Show first 50 rows
      }

      function renderPreviewTable(data) {
        if (!data.length) return;

        const head = document.getElementById("previewTableHead");
        const body = document.getElementById("previewTableBody");
        
        const headers = Object.keys(data[0]);
        head.innerHTML = headers.map(h => 
          `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`
        ).join("");

        body.innerHTML = data.map((row, index) => {
          const cells = headers.map(header => {
            let value = row[header];
            if (value === null || value === undefined) value = '';
            
            // Highlight important fields
            let cellClass = "px-4 py-3 whitespace-nowrap text-sm text-gray-900";
            if (['name', 'selling_price', 'sale_type'].includes(header) && (!value || String(value).trim() === '')) {
              cellClass += " bg-red-50 text-red-900";
            }
            
            return `<td class="${cellClass}">${String(value).substring(0, 50)}${String(value).length > 50 ? '...' : ''}</td>`;
          }).join("");
          
          return `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">${cells}</tr>`;
        }).join("");
      }

      async function saveImportedData() {
        const submitBtn = document.getElementById("submitImportBtn");
        const btnText = submitBtn.querySelector('.btn-text');
        const spinner = submitBtn.querySelector('.loading-spinner');
        
        submitBtn.disabled = true;
        btnText.textContent = "Importing...";
        spinner.classList.remove("hidden");

        try {
          // Show progress section
          document.getElementById("previewSection").classList.add("hidden");
          document.getElementById("progressSection").classList.remove("hidden");
          updateImportStep(3);

          console.log("Starting import process...");
          console.log("Import data:", importData);
          console.log("Categories available:", categories);
          console.log("Suppliers available:", suppliers);

          const totalCount = importData.length;
          let successCount = 0;
          let errorCount = 0;
          const batchSize = 10;

          // Prepare all data first
          const allMedicineData = importData.map(row => ({
            medicine_code: row.medicine_code || `MED${new Date().getFullYear()}${String(Math.floor(Math.random() * 10000)).padStart(4, "0")}`,
            name: row.name,
            generic_name: row.generic_name || null,
            brand_name: row.brand_name || null,
            category_id: categories.find(c => c.name === row.category_name)?.id || parseInt(row.category_id) || null,
            dosage_form: row.dosage_form || null,
            strength: row.strength || null,
            unit: row.unit || null,
            cost_price: parseFloat(row.cost_price) || 0,
            selling_price: parseFloat(row.selling_price) || 0,
            stock: parseInt(row.stock) || 0,
            supplier_id: suppliers.find(s => s.name === row.supplier_name)?.id || parseInt(row.supplier_id) || null,
            sale_type: row.sale_type || "Private",
            requires_prescription: row.requires_prescription === true || row.requires_prescription === "true" || row.requires_prescription === "Yes",
            expiry_date: row.expiry_date || null,
            batch_number: row.batch_number || null,
            manufacturer: row.manufacturer || null,
            min_stock_level: parseInt(row.min_stock_level) || 10,
            max_stock_level: parseInt(row.max_stock_level) || 1000,
            description: row.description || null,
            storage_conditions: row.storage_conditions || null,
          }));

          // Process in batches
          for (let i = 0; i < allMedicineData.length; i += batchSize) {
            const batch = allMedicineData.slice(i, i + batchSize);
            const batchPromises = batch.map(async (medicineData, index) => {
              try {
                console.log(`Processing medicine ${i + index + 1}:`, medicineData);
                
                // Use the supabase direct approach to avoid permission issues
                const user = await getCurrentUser();
                const { data, error } = await supabase
                  .from('medicines')
                  .insert([{ ...medicineData, created_by: user?.id }])
                  .select();

                if (error) {
                  console.error(`Error inserting medicine ${i + index + 1}:`, error);
                  throw error;
                }
                
                console.log(`Successfully inserted medicine ${i + index + 1}:`, data);
                successCount++;
              } catch (error) {
                console.error(`Error importing medicine ${i + index + 1}:`, error.message, medicineData);
                errorCount++;
              }
            });

            await Promise.allSettled(batchPromises);

            // Update progress
            const progress = Math.min(((i + batchSize) / allMedicineData.length) * 100, 100);
            document.getElementById("progressFill").style.width = `${progress}%`;
            document.getElementById("progressText").textContent = `${Math.round(progress)}%`;
          }

          // Show results
          document.getElementById("successCount").textContent = successCount;
          document.getElementById("errorCount").textContent = errorCount;
          document.getElementById("totalCount").textContent = totalCount;
          document.getElementById("importResults").classList.remove("hidden");

          if (successCount > 0) {
            showNotification(`Successfully imported ${successCount} medicines!`, "success", document.getElementById("notificationContainer"));
            renderMedicines();
          }
          
          if (errorCount > 0) {
            showNotification(`${errorCount} medicines failed to import. Check the logs for details.`, "warning", document.getElementById("notificationContainer"));
          }

          // Auto close after 3 seconds if all successful
          if (errorCount === 0) {
            setTimeout(() => {
              closeImportModal();
            }, 3000);
          }

        } catch (error) {
          showNotification("Error during import: " + error.message, "error", document.getElementById("notificationContainer"));
        } finally {
          submitBtn.disabled = false;
          btnText.textContent = "Import Data";
          spinner.classList.add("hidden");
        }
      }

      function downloadTemplate() {
        const templateData = [{
          medicine_code: "MED2024001",
          name: "Paracetamol",
          generic_name: "Acetaminophen",
          brand_name: "Panadol",
          category_id: 1,
          dosage_form: "tablet",
          strength: "500mg",
          unit: "pieces",
          cost_price: 1000,
          selling_price: 1500,
          stock: 100,
          supplier_id: 1,
          sale_type: "Both",
          requires_prescription: "No",
          expiry_date: "2025-12-31",
          batch_number: "BATCH001",
          manufacturer: "Sample Pharma",
          min_stock_level: 10,
          max_stock_level: 1000,
          description: "Pain reliever and fever reducer",
          storage_conditions: "Store at room temperature"
        }];

        const worksheet = XLSX.utils.json_to_sheet(templateData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Medicine Template");
        XLSX.writeFile(workbook, "Medicine_Import_Template.xlsx");
        
        showNotification("Template downloaded successfully!", "success", document.getElementById("notificationContainer"));
      }

      function openImportModal() {
        const modal = document.getElementById("importModal");
        modal.classList.add("show");
        
        // Reset modal state
        updateImportStep(1);
        importData = [];
        document.getElementById("uploadSection").classList.remove("hidden");
        document.getElementById("previewSection").classList.add("hidden");
        document.getElementById("progressSection").classList.add("hidden");
        document.getElementById("fileInfo").classList.add("hidden");
        document.getElementById("excelFile").value = "";
        document.getElementById("submitImportBtn").disabled = true;
      }

      function closeImportModal() {
        document.getElementById("importModal").classList.remove("show");
      }

      // Updated function to render medicines in category-specific tables
      async function renderMedicines() {
        const searchTerm = document.getElementById("medicineSearch").value.toLowerCase();
        const categoryFilter = document.getElementById("categoryFilter").value;

        // Clear all category tables
        const categoryTables = ['medicinesTable', 'suppliesTable', 'equipmentTable', 'othersTable'];
        categoryTables.forEach(tableId => {
          const tbody = document.getElementById(tableId);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
          }
        });

        try {
          const medicines = await fetchMedicines();
          
          // Group medicines by category
          const categorizedMedicines = {
            'Medicines': [],
            'Supplies': [],
            'Equipment': [],
            'Others': []
          };

          // Filter and categorize medicines
          medicines.forEach(medicine => {
            const matchesSearch = medicine.medicine_code.toLowerCase().includes(searchTerm) ||
                                 medicine.name.toLowerCase().includes(searchTerm) ||
                                 medicine.category_name.toLowerCase().includes(searchTerm);
            
            // Determine category based on category_name or category_id
            let category = 'Others'; // default
            
            if (medicine.category_name) {
              const categoryName = medicine.category_name.toLowerCase();
              if (categoryName.includes('medicine') || categoryName.includes('drug') || categoryName.includes('tablet') || categoryName.includes('syrup')) {
                category = 'Medicines';
              } else if (categoryName.includes('supply') || categoryName.includes('consumable') || categoryName.includes('disposable')) {
                category = 'Supplies';
              } else if (categoryName.includes('equipment') || categoryName.includes('device') || categoryName.includes('machine') || categoryName.includes('instrument')) {
                category = 'Equipment';
              }
            }
            
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
              categorizedMedicines[category].push(medicine);
            }
          });

          // Render each category table
          renderCategoryTable('medicinesTable', categorizedMedicines['Medicines'], 'medicines');
          renderCategoryTable('suppliesTable', categorizedMedicines['Supplies'], 'supplies');
          renderCategoryTable('equipmentTable', categorizedMedicines['Equipment'], 'equipment');
          renderCategoryTable('othersTable', categorizedMedicines['Others'], 'others');

          // Check for notifications across all categories
          const allFilteredMedicines = Object.values(categorizedMedicines).flat();
          checkForNotifications(allFilteredMedicines);
          
        } catch (error) {
          console.error("Error loading medicines:", error);
          categoryTables.forEach(tableId => {
            const tbody = document.getElementById(tableId);
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Error loading data. Please try again.</td></tr>';
            }
          });
        }
      }

      // Helper function to render individual category tables
      function renderCategoryTable(tableId, medicines, categoryType) {
        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        if (medicines.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No ${categoryType} found.</td></tr>`;
          return;
        }

        tbody.innerHTML = medicines.map(medicine => {
          const stockClass = medicine.stock <= medicine.min_stock_level ? "text-red-600 font-semibold" : medicine.stock <= medicine.min_stock_level * 2 ? "text-yellow-600" : "text-green-600";
          const expiryDate = medicine.expiry_date ? new Date(medicine.expiry_date) : null;
          const today = new Date();
          const daysUntilExpiry = expiryDate ? Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)) : null;
          const expiryClass = daysUntilExpiry <= 0 ? "text-red-600" : daysUntilExpiry <= 30 ? "text-yellow-600" : "text-gray-900";
          
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-gray-900">${medicine.medicine_code}</td>
              <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${medicine.name}</td>
              <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${medicine.category_name}</span></td>
              <td class="px-6 py-4 whitespace-nowrap"><span class="${stockClass}">${medicine.stock}</span> ${medicine.stock <= medicine.min_stock_level ? '<i class="fas fa-exclamation-triangle ml-1 text-red-500"></i>' : ""}</td>
              <td class="px-6 py-4 whitespace-nowrap ${expiryClass}">${medicine.expiry_date || "N/A"} ${daysUntilExpiry <= 0 ? '<i class="fas fa-times-circle ml-1 text-red-500"></i>' : daysUntilExpiry <= 30 ? '<i class="fas fa-clock ml-1 text-orange-500"></i>' : ""}</td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-900">${formatCurrency(medicine.selling_price)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-600">${medicine.supplier_name || "N/A"}</td>
              <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full ${medicine.sale_type === "Private" ? "bg-purple-100 text-purple-800" : medicine.sale_type === "Mutuel" ? "bg-green-100 text-green-800" : "bg-blue-100 text-blue-800"}">${medicine.sale_type}</span></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editMedicine(${medicine.id})" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                <button onclick="archiveMedicineLocal(${medicine.id})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        }).join("");
      }
      }

      function checkForNotifications(medicines) {
        const today = new Date();
        const lowStockCount = medicines.filter(m => m.stock <= m.min_stock_level).length;
        const expiringCount = medicines.filter(m => {
          if (!m.expiry_date) return false;
          const expiryDate = new Date(m.expiry_date);
          const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
          return daysUntilExpiry > 0 && daysUntilExpiry <= 30;
        }).length;
        const expiredCount = medicines.filter(m => m.expiry_date && new Date(m.expiry_date) < today).length;

        if (expiredCount > 0)
          showNotification(`‚ö†Ô∏è ${expiredCount} medicine(s) have expired!`, "error", document.getElementById("notificationContainer"));
        if (expiringCount > 0)
          showNotification(`üïí ${expiringCount} medicine(s) expiring within 30 days!`, "warning", document.getElementById("notificationContainer"));
        if (lowStockCount > 0)
          showNotification(`üì¶ ${lowStockCount} medicine(s) have low stock!`, "warning", document.getElementById("notificationContainer"));
      }

      async function openMedicineModal(medicineId = null, category = null) {
        const modal = document.getElementById("medicineModal");
        const title = document.getElementById("medicineModalTitle");
        const form = document.getElementById("medicineForm");
        currentEditId = medicineId;

        form.reset();
        modal.classList.add("show");
        
        if (medicineId) {
          title.textContent = "Edit Inventory Item";
          try {
            const medicine = (await fetchMedicines()).find(m => m.id === medicineId);
            if (medicine) {
              document.getElementById("medicineCode").value = medicine.medicine_code;
              document.getElementById("medicineName").value = medicine.name;
              document.getElementById("genericName").value = medicine.generic_name || "";
              document.getElementById("brandName").value = medicine.brand_name || "";
              document.getElementById("medicineCategory").value = medicine.category_id || "";
              document.getElementById("dosageForm").value = medicine.dosage_form || "";
              document.getElementById("strength").value = medicine.strength || "";
              document.getElementById("unit").value = medicine.unit || "";
              document.getElementById("costPrice").value = medicine.cost_price || "";
              document.getElementById("sellingPrice").value = medicine.selling_price;
              document.getElementById("medicineStock").value = medicine.stock;
              document.getElementById("medicineSupplier").value = medicine.supplier_id || "";
              document.getElementById("saleType").value = medicine.sale_type;
              document.getElementById("requiresPrescription").checked = medicine.requires_prescription;
              document.getElementById("medicineExpiry").value = medicine.expiry_date || "";
              document.getElementById("batchNumber").value = medicine.batch_number || "";
              document.getElementById("manufacturer").value = medicine.manufacturer || "";
              document.getElementById("minStockLevel").value = medicine.min_stock_level || "";
              document.getElementById("maxStockLevel").value = medicine.max_stock_level || "";
              document.getElementById("medicineDescription").value = medicine.description || "";
              document.getElementById("storageConditions").value = medicine.storage_conditions || "";
            }
          } catch (error) {
            showNotification("Error loading medicine data: " + error.message, "error", document.getElementById("notificationContainer"));
            return;
          }
        } else {
          // Add mode - set title and category based on the category
          const categoryTitles = {
            'Medicines': 'Add New Medicine',
            'Supplies': 'Add New Supply',
            'Equipment': 'Add New Equipment',
            'Others': 'Add New Item'
          };
          title.textContent = categoryTitles[category] || 'Add New Inventory Item';
          
          document.getElementById("medicineCode").value = `MED${new Date().getFullYear()}${String(Math.floor(Math.random() * 10000)).padStart(4, "0")}`;
          
          // Pre-select the category if provided
          if (category) {
            // Map category names to category IDs (assuming these exist in your category dropdown)
            const categoryMap = {
              'Medicines': '1',
              'Supplies': '2', 
              'Equipment': '3',
              'Others': '4'
            };
            const categorySelect = document.getElementById("medicineCategory");
            if (categorySelect && categoryMap[category]) {
              categorySelect.value = category; // Use category name directly
            }
            // Show relevant fields immediately
            toggleCategoryFields(category);
          }
        }
        
        // Also show/hide category-specific fields based on current selection
        const currentCategory = document.getElementById("medicineCategory").value;
        if (currentCategory) {
          toggleCategoryFields(currentCategory);
        }
      }

      function closeMedicineModal() {
        document.getElementById("medicineModal").classList.remove("show");
        currentEditId = null;
      }

      // Function to show/hide category-specific fields
      function toggleCategoryFields(category) {
        // Hide all category-specific field sections
        const categoryFields = document.querySelectorAll('.category-fields');
        categoryFields.forEach(section => {
          section.classList.add('hidden');
        });

        // Show relevant fields based on selected category
        switch(category) {
          case 'Medicines':
            document.getElementById('medicinesFields').classList.remove('hidden');
            // Update modal title
            document.getElementById('medicineModalTitle').textContent = 'üíä Add New Medicine';
            // Show category description
            updateCategoryDescription('Pharmaceutical products intended to diagnose, treat, cure, or prevent disease. Includes tablets, syrups, injections, and other medicinal preparations.');
            break;
            
          case 'Supplies':
            document.getElementById('suppliesFields').classList.remove('hidden');
            document.getElementById('medicineModalTitle').textContent = 'üß¥ Add New Supply';
            updateCategoryDescription('Consumable medical items used in treatment but are not medicines. Includes gloves, masks, syringes, and other disposable items.');
            break;
            
          case 'Equipment':
            document.getElementById('equipmentFields').classList.remove('hidden');
            document.getElementById('medicineModalTitle').textContent = 'ü©∫ Add New Equipment';
            updateCategoryDescription('Reusable medical devices or tools used for diagnosis, monitoring, or treatment. Includes stethoscopes, thermometers, and other medical instruments.');
            break;
            
          case 'Others':
            document.getElementById('othersFields').classList.remove('hidden');
            document.getElementById('medicineModalTitle').textContent = 'üõçÔ∏è Add New Item';
            updateCategoryDescription('Non-medical items and supplements including health supplements, cosmetics, baby care products, and personal care items.');
            break;
            
          default:
            document.getElementById('medicineModalTitle').textContent = 'Add New Inventory Item';
            updateCategoryDescription('');
        }
      }

      // Function to update category description
      function updateCategoryDescription(description) {
        const descriptionDiv = document.getElementById('categoryDescription');
        if (description) {
          descriptionDiv.textContent = description;
          descriptionDiv.classList.remove('hidden');
        } else {
          descriptionDiv.classList.add('hidden');
        }
      }

      async function saveMedicine(e) {
        e.preventDefault();
        const saveBtn = document.getElementById("saveMedicineBtn");
        const btnText = saveBtn.querySelector('.btn-text');
        const spinner = saveBtn.querySelector('.loading-spinner');
        
        saveBtn.disabled = true;
        btnText.textContent = "Saving...";
        spinner.classList.remove("hidden");

        // Get the selected category to determine which fields to collect
        const selectedCategory = document.getElementById("medicineCategory").value;

        // Base data common to all categories
        const medicineData = {
          medicine_code: document.getElementById("medicineCode").value,
          name: document.getElementById("medicineName").value,
          category_name: selectedCategory, // Store category name instead of ID
          unit: document.getElementById("unit").value || null,
          cost_price: parseFloat(document.getElementById("costPrice").value) || 0,
          selling_price: parseFloat(document.getElementById("sellingPrice").value),
          stock: parseInt(document.getElementById("medicineStock").value) || 0,
          supplier_id: parseInt(document.getElementById("medicineSupplier").value) || null,
          sale_type: document.getElementById("saleType").value,
          min_stock_level: parseInt(document.getElementById("minStockLevel").value) || 10,
          max_stock_level: parseInt(document.getElementById("maxStockLevel").value) || 1000,
          description: document.getElementById("medicineDescription").value || null,
        };

        // Add category-specific fields based on selected category
        switch(selectedCategory) {
          case 'Medicines':
            Object.assign(medicineData, {
              generic_name: document.getElementById("genericName").value || null,
              brand_name: document.getElementById("brandName").value || null,
              dosage_form: document.getElementById("dosageForm").value || null,
              strength: document.getElementById("strength").value || null,
              batch_number: document.getElementById("batchNumber").value || null,
              manufacturer: document.getElementById("manufacturer").value || null,
              expiry_date: document.getElementById("medicineExpiry").value || null,
              storage_conditions: document.getElementById("storageConditions").value || null,
              requires_prescription: document.getElementById("requiresPrescription").checked,
            });
            break;

          case 'Supplies':
            Object.assign(medicineData, {
              supply_type: document.getElementById("supplyType").value || null,
              material: document.getElementById("material").value || null,
              size_specification: document.getElementById("sizeSpec").value || null,
              package_quantity: parseInt(document.getElementById("packageQty").value) || null,
              is_sterile: document.getElementById("isSterile").checked,
              is_single_use: document.getElementById("isSingleUse").checked,
            });
            break;

          case 'Equipment':
            Object.assign(medicineData, {
              equipment_type: document.getElementById("equipmentType").value || null,
              serial_number: document.getElementById("serialNumber").value || null,
              model_number: document.getElementById("modelNumber").value || null,
              warranty_expiry: document.getElementById("warrantyExpiry").value || null,
              maintenance_schedule: document.getElementById("maintenanceSchedule").value || null,
              last_maintenance_date: document.getElementById("lastMaintenanceDate").value || null,
              calibration_due_date: document.getElementById("calibrationDue").value || null,
              requires_calibration: document.getElementById("requiresCalibration").checked,
            });
            break;

          case 'Others':
            Object.assign(medicineData, {
              item_type: document.getElementById("otherItemType").value || null,
              target_demographic: document.getElementById("targetDemographic").value || null,
              shelf_life_months: parseInt(document.getElementById("shelfLife").value) || null,
              is_otc: document.getElementById("isOTC").checked,
            });
            break;
        }

        try {
          if (currentEditId) {
            await updateMedicine(currentEditId, medicineData);
            showNotification("Item updated successfully!", "success", document.getElementById("notificationContainer"));
          } else {
            await addMedicine(medicineData);
            showNotification("Item added successfully!", "success", document.getElementById("notificationContainer"));
          }
          renderMedicines();
          closeMedicineModal();
        } catch (error) {
          showNotification("Error saving item: " + error.message, "error", document.getElementById("notificationContainer"));
        } finally {
          saveBtn.disabled = false;
          btnText.textContent = "Save Item";
          spinner.classList.add("hidden");
        }
      }


      function editMedicine(id) {
        openMedicineModal(id);
      }

      async function archiveMedicineLocal(id) {
        if (confirm("Are you sure you want to archive this medicine?")) {
          try {
            await archiveMedicine(id);
            renderMedicines();
            showNotification("Medicine archived successfully!", "success", document.getElementById("notificationContainer"));
          } catch (error) {
            showNotification("Error archiving medicine: " + error.message, "error", document.getElementById("notificationContainer"));
          }
        }
      }

      async function exportToExcel() {
        try {
          showNotification("Generating Excel file...", "info", document.getElementById("notificationContainer"));
          const medicines = await fetchMedicines();
          
          if (!medicines.length) {
            showNotification("No data to export.", "warning", document.getElementById("notificationContainer"));
            return;
          }

          if (typeof ExcelJS === "undefined") {
            showNotification("ExcelJS library not loaded. Please refresh the page.", "error", document.getElementById("notificationContainer"));
            return;
          }

          // Create a new workbook and worksheet
          const workbook = new ExcelJS.Workbook();
          const sheetName = `Medicines_${new Date().toISOString().split("T")[0]}`;
          const worksheet = workbook.addWorksheet(sheetName);

          // Define header row
          const headers = [
            "Medicine Code",
            "Name",
            "Generic Name", 
            "Brand Name",
            "Category",
            "Dosage Form",
            "Strength",
            "Unit",
            "Cost Price (RWF)",
            "Selling Price (RWF)",
            "Stock",
            "Supplier",
            "Sale Type",
            "Requires Prescription",
            "Expiry Date",
            "Batch Number",
            "Manufacturer",
            "Min Stock Level",
            "Max Stock Level",
            "Description",
            "Storage Conditions"
          ];
          worksheet.addRow(headers);

          // Add medicines data
          medicines.forEach((medicine) => {
            worksheet.addRow([
              medicine.medicine_code || "N/A",
              medicine.name || "N/A",
              medicine.generic_name || "N/A",
              medicine.brand_name || "N/A",
              medicine.category_name || "N/A",
              medicine.dosage_form || "N/A",
              medicine.strength || "N/A",
              medicine.unit || "N/A",
              medicine.cost_price || 0,
              medicine.selling_price || 0,
              medicine.stock || 0,
              medicine.supplier_name || "N/A",
              medicine.sale_type || "N/A",
              medicine.requires_prescription ? "Yes" : "No",
              medicine.expiry_date || "N/A",
              medicine.batch_number || "N/A",
              medicine.manufacturer || "N/A",
              medicine.min_stock_level || 0,
              medicine.max_stock_level || 0,
              medicine.description || "N/A",
              medicine.storage_conditions || "N/A"
            ]);
          });

          // Style header row
          const headerRow = worksheet.getRow(1);
          headerRow.eachCell((cell) => {
            cell.font = { bold: true };
            cell.alignment = { vertical: "middle", horizontal: "center" };
            cell.fill = {
              type: "pattern",
              pattern: "solid",
              fgColor: { argb: "FFD9D9D9" }, // light gray background
            };
            cell.border = {
              top: { style: "thin" },
              left: { style: "thin" },
              bottom: { style: "thin" },
              right: { style: "thin" },
            };
          });
          headerRow.height = 25;

          // Style all data rows
          worksheet.eachRow((row, rowNumber) => {
            row.eachCell((cell) => {
              cell.border = {
                top: { style: "thin" },
                left: { style: "thin" },
                bottom: { style: "thin" },
                right: { style: "thin" },
              };
              cell.alignment = { vertical: "middle", horizontal: "left" };
            });
            if (rowNumber > 1) {
              row.height = 18;
            }
          });

          // Set column widths
          worksheet.columns = [
            { width: 15 }, // Medicine Code
            { width: 25 }, // Name
            { width: 20 }, // Generic Name
            { width: 20 }, // Brand Name
            { width: 15 }, // Category
            { width: 15 }, // Dosage Form
            { width: 12 }, // Strength
            { width: 10 }, // Unit
            { width: 15 }, // Cost Price
            { width: 15 }, // Selling Price
            { width: 8 },  // Stock
            { width: 20 }, // Supplier
            { width: 12 }, // Sale Type
            { width: 18 }, // Prescription
            { width: 12 }, // Expiry Date
            { width: 15 }, // Batch Number
            { width: 20 }, // Manufacturer
            { width: 12 }, // Min Stock
            { width: 12 }, // Max Stock
            { width: 30 }, // Description
            { width: 30 }  // Storage Conditions
          ];

          // Enable autofilter
          worksheet.autoFilter = {
            from: "A1",
            to: "U1",
          };

          // Generate filename
          const now = new Date();
          const dateStr = now.toISOString().split("T")[0];
          const timeStr = now.toTimeString().split(" ")[0].replace(/:/g, "-");
          const filename = `medicines_export_${dateStr}_${timeStr}.xlsx`;

          // Write file (ExcelJS ‚Üí Blob ‚Üí saveAs)
          const buffer = await workbook.xlsx.writeBuffer();
          saveAs(new Blob([buffer]), filename);

          showNotification(`Medicines exported successfully as ${filename}!`, "success", document.getElementById("notificationContainer"));
        } catch (error) {
          console.error("Export error:", error);
          showNotification("Error exporting medicines: " + error.message, "error", document.getElementById("notificationContainer"));
        }
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-RW', {
          style: 'currency',
          currency: 'RWF',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(amount || 0);
      }

      // Category guide toggle functionality
      function toggleCategoriesGuide() {
        const guide = document.getElementById("categoriesGuide");
        const icon = document.getElementById("categoriesIcon");
        const button = document.getElementById("toggleCategoriesGuide");
        
        if (guide.style.display === "none") {
          guide.style.display = "block";
          icon.className = "fas fa-chevron-up";
          button.innerHTML = '<i class="fas fa-chevron-up" id="categoriesIcon"></i> Hide Guide';
        } else {
          guide.style.display = "none";
          icon.className = "fas fa-chevron-down";
          button.innerHTML = '<i class="fas fa-chevron-down" id="categoriesIcon"></i> Show Guide';
        }
      }

      // Handle category selection in form
      function handleCategorySelection() {
        const select = document.getElementById("medicineCategory");
        const description = document.getElementById("categoryDescription");
        const selectedValue = select.value;
        
        const descriptions = {
          "Medicines": "üíä Pharmaceutical products requiring expiry tracking, prescription status, and batch numbers. Subject to strict regulations.",
          "Supplies": "üß¥ Consumable medical items used in treatment. Track quantity and sterile vs. non-sterile status.",
          "Equipment": "ü©∫ Reusable medical devices for diagnosis and monitoring. Require maintenance schedules and calibration.",
          "Others": "üõçÔ∏è Non-medical items like supplements, cosmetics, and general pharmacy products."
        };
        
        if (selectedValue && descriptions[selectedValue]) {
          description.textContent = descriptions[selectedValue];
          description.classList.remove("hidden");
        } else {
          description.classList.add("hidden");
        }
      }

      async function fetchMedicines() {
        try {
          const { data, error } = await supabase
            .from('medicines')
            .select(`
              *,
              medicine_categories(name),
              suppliers(name)
            `)
            .eq('is_active', true)
            .order('name');

          if (error) throw error;

          return data.map(medicine => ({
            ...medicine,
            category_name: medicine.medicine_categories?.name || 'No Category',
            supplier_name: medicine.suppliers?.name || 'No Supplier'
          }));
        } catch (error) {
          console.error('Error fetching medicines:', error);
          throw error;
        }
      }

      async function fetchSuppliers() {
        try {
          const { data, error } = await supabase
            .from('suppliers')
            .select('id, name')
            .eq('is_active', true)
            .order('name');

          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching suppliers:', error);
          throw error;
        }
      }

      // Make sure the functions are available globally
      window.editMedicine = editMedicine;
      window.archiveMedicineLocal = archiveMedicineLocal;

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>