<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Reports - Nyina wa Jambo Pharmacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-primary text-white flex-shrink-0 hidden lg:block">
            <div class="p-6">
                <a href="index.html?home=true" class="text-2xl font-bold text-white flex items-center">
                    <i class="fas fa-pills mr-3"></i>
                    <span>Nyina wa Jambo</span>
                </a>
            </div>
            <nav class="mt-6">
                <a href="index.html?dashboard=true" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors">
                    <i class="fas fa-tachometer-alt w-6 text-center"></i>
                    <span class="ml-4">Dashboard</span>
                </a>
                <a href="medicines.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
                    <i class="fas fa-capsules w-6 text-center"></i>
                    <span class="ml-4">Medicines</span>
                </a>
                <a href="suppliers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
                    <i class="fas fa-truck w-6 text-center"></i>
                    <span class="ml-4">Suppliers</span>
                </a>
                <a href="customers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
                    <i class="fas fa-users w-6 text-center"></i>
                    <span class="ml-4">Customers</span>
                </a>
                <a href="orders.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
                    <i class="fas fa-shopping-cart w-6 text-center"></i>
                    <span class="ml-4">Orders</span>
                </a>
                <a href="reports.html" class="flex items-center py-3 px-6 bg-green-600 text-white admin-only">
                    <i class="fas fa-chart-line w-6 text-center"></i>
                    <span class="ml-4">Reports</span>
                </a>
            </nav>
            <div class="absolute bottom-0 w-full p-6">
                <button onclick="logout()" class="w-full flex items-center justify-center py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top bar -->
            <header class="bg-white shadow-sm flex justify-between items-center p-4">
                <button id="menu-toggle" class="text-gray-700 lg:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl font-semibold text-gray-800 hidden lg:block">Medicine Reports & Analytics</h1>
                <div class="relative">
                    <button id="userAvatar" class="flex items-center space-x-2">
                        <img src="" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <span id="currentUser" class="text-gray-700 font-medium hidden md:block"></span>
                    </button>
                    <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 hidden">
                        <div class="py-1">
                            <div class="px-4 py-2 text-sm text-gray-500 border-b">
                                <span id="userInfo"></span>
                            </div>
                             <a href="index.html?home=true" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-home mr-2"></i>Home Page
                            </a>
                            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main content area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div class="container mx-auto">
                    <!-- Page Header -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">Medicine Reports & Analytics</h1>
                                <p class="text-gray-600 mt-2">Comprehensive medicine inventory tracking and analytics</p>
                            </div>
                            <div class="flex space-x-3">
                                <button id="addStockBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add Stock Movement
                                </button>
                                <button id="exportReportsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-download mr-2"></i>Export Reports
                                </button>
                                <button id="refreshBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100">
                                    <i class="fas fa-pills text-blue-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Medicines</p>
                                    <p id="totalMedicines" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100">
                                    <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Stock In (Today)</p>
                                    <p id="stockInToday" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-red-100">
                                    <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Stock Out (Today)</p>
                                    <p id="stockOutToday" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Low Stock Items</p>
                                    <p id="lowStockCount" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Stock Movement Trends -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Stock Movement Trends (Last 7 Days)</h3>
                            <canvas id="stockTrendsChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Medicine Categories Distribution -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Medicine Categories Distribution</h3>
                            <canvas id="categoriesChart" width="400" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Tabs Section -->
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-8">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8 px-6">
                                <button id="inventoryTab" class="tab-button active border-b-2 border-primary text-primary py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-warehouse mr-2"></i>Inventory Report
                                </button>
                                <button id="movementsTab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-exchange-alt mr-2"></i>Stock Movements
                                </button>
                                <button id="alertsTab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                    <i class="fas fa-bell mr-2"></i>Alerts & Warnings
                                </button>
                            </nav>
                        </div>

                        <!-- Inventory Report Tab -->
                        <div id="inventoryContent" class="tab-content">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Medicine Inventory Overview</h3>
                                    <div class="flex space-x-3">
                                        <input type="text" id="inventorySearch" placeholder="Search medicines..." class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                                        <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                                            <option value="">All Categories</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicine</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Movement</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventoryTable" class="bg-white divide-y divide-gray-200">
                                            <!-- Table content will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Movements Tab -->
                        <div id="movementsContent" class="tab-content hidden">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Recent Stock Movements</h3>
                                    <div class="flex space-x-3">
                                        <input type="date" id="dateFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                                        <select id="movementTypeFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                                            <option value="">All Movements</option>
                                            <option value="in">Stock In</option>
                                            <option value="out">Stock Out</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicine</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Movement</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previous Stock</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Stock</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="movementsTable" class="bg-white divide-y divide-gray-200">
                                            <!-- Table content will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Alerts Tab -->
                        <div id="alertsContent" class="tab-content hidden">
                            <div class="p-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Inventory Alerts & Warnings</h3>
                                <div class="space-y-4">
                                    <!-- Low Stock Alerts -->
                                    <div class="border-l-4 border-red-400 bg-red-50 p-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-exclamation-circle text-red-400"></i>
                                            </div>
                                            <div class="ml-3">
                                                <h4 class="text-lg font-medium text-red-800">Critical Low Stock</h4>
                                                <div id="criticalLowStock" class="mt-2 text-sm text-red-700">
                                                    <!-- Critical alerts will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Expiry Warnings -->
                                    <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-clock text-yellow-400"></i>
                                            </div>
                                            <div class="ml-3">
                                                <h4 class="text-lg font-medium text-yellow-800">Expiry Warnings</h4>
                                                <div id="expiryWarnings" class="mt-2 text-sm text-yellow-700">
                                                    <!-- Expiry warnings will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- General Alerts -->
                                    <div class="border-l-4 border-blue-400 bg-blue-50 p-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-info-circle text-blue-400"></i>
                                            </div>
                                            <div class="ml-3">
                                                <h4 class="text-lg font-medium text-blue-800">General Notifications</h4>
                                                <div id="generalAlerts" class="mt-2 text-sm text-blue-700">
                                                    <!-- General alerts will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Stock Movement Modal -->
    <div id="addStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Add Stock Movement</h2>
                <button id="closeStockModal" class="close">&times;</button>
            </div>
            <form id="addStockForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Medicine</label>
                    <select id="stockMedicineId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        <option value="">Select Medicine</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Movement Type</label>
                    <select id="stockMovementType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        <option value="in">Stock In (Add Inventory)</option>
                        <option value="out">Stock Out (Reduce Inventory)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="stockQuantity" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Reason</label>
                    <select id="stockReason" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        <option value="purchase">Purchase</option>
                        <option value="sale">Sale</option>
                        <option value="expired">Expired</option>
                        <option value="damaged">Damaged</option>
                        <option value="adjustment">Stock Adjustment</option>
                        <option value="return">Return</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                    <textarea id="stockNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelStockBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 border border-gray-300 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md hover:bg-green-600">
                        Add Movement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        let stockTrendsChart = null;
        let categoriesChart = null;
        let allMedicines = [];
        let allMovements = [];

        document.addEventListener("DOMContentLoaded", function () {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            const user = getCurrentUser();
            if (!user || user.role !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html?dashboard=true';
                }, 2000);
                return;
            }

            updateNavigation();
            loadAllReportsData();
            setupEventListeners();
            setupTabSwitching();
        });

        function updateNavigation() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('currentUser').textContent = `${user.fullName}`;
                document.getElementById('userInfo').textContent = `${user.fullName} (${user.role})`;
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName)}&background=16a34a&color=fff&bold=true`;

                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => el.style.display = (user.role === 'admin') ? 'flex' : 'none');
                
                const receptionistElements = document.querySelectorAll('.receptionist-only');
                receptionistElements.forEach(el => el.style.display = (user.role === 'receptionist' || user.role === 'admin') ? 'flex' : 'none');
            }
        }

        function setupEventListeners() {
            document.getElementById("refreshBtn").addEventListener("click", loadAllReportsData);
            document.getElementById("exportReportsBtn").addEventListener("click", exportAllReports);
            document.getElementById("addStockBtn").addEventListener("click", openAddStockModal);
            document.getElementById("addStockForm").addEventListener("submit", handleAddStock);
            document.getElementById("cancelStockBtn").addEventListener("click", closeAddStockModal);
            document.getElementById("closeStockModal").addEventListener("click", closeAddStockModal);
            
            document.getElementById("inventorySearch").addEventListener("input", filterInventoryTable);
            document.getElementById("categoryFilter").addEventListener("change", filterInventoryTable);
            document.getElementById("dateFilter").addEventListener("change", filterMovementsTable);
            document.getElementById("movementTypeFilter").addEventListener("change", filterMovementsTable);

            // Sidebar toggle
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                sidebar.classList.toggle('hidden');
            });

            // User dropdown
            const userAvatar = document.getElementById('userAvatar');
            const userDropdown = document.getElementById('userDropdown');
            userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('hidden');
            });

            // Close dropdown/sidebar when clicking outside
            document.addEventListener('click', function(e) {
                if (!sidebar.classList.contains('hidden') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.add('hidden');
                }
                if (!userDropdown.classList.contains('hidden') && !userAvatar.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });
        }

        function setupTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.id.replace('Tab', 'Content');
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-primary', 'text-primary');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    this.classList.add('active', 'border-primary', 'text-primary');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    document.getElementById(tabId).classList.remove('hidden');
                });
            });
        }

        async function loadAllReportsData() {
            try {
                showNotification("Loading medicine reports data...", "info");
                const [medicines, movements] = await Promise.all([fetchMedicines(), fetchStockMovements()]);
                allMedicines = medicines;
                allMovements = movements;

                updateKeyMetrics(medicines, movements);
                updateCharts(medicines, movements);
                updateInventoryTable(medicines, movements);
                updateMovementsTable(movements);
                updateAlertsTab(medicines);
                populateMedicineDropdown(medicines);
                populateCategoryFilter(medicines);

                showNotification("Medicine reports loaded successfully!", "success");
            } catch (error) {
                showNotification("Error loading reports data.", "error");
            }
        }

        function updateKeyMetrics(medicines, movements) {
            const today = new Date().toISOString().split('T')[0];
            const stockInToday = movements.filter(m => m.movement_type === 'in' && m.movement_date === today).reduce((sum, m) => sum + m.quantity, 0);
            const stockOutToday = movements.filter(m => m.movement_type === 'out' && m.movement_date === today).reduce((sum, m) => sum + m.quantity, 0);
            const lowStockItems = medicines.filter(m => (m.stock || 0) <= 10);

            document.getElementById("totalMedicines").textContent = medicines.length;
            document.getElementById("stockInToday").textContent = stockInToday;
            document.getElementById("stockOutToday").textContent = stockOutToday;
            document.getElementById("lowStockCount").textContent = lowStockItems.length;
        }

        function updateCharts(medicines, movements) {
            updateStockTrendsChart(movements);
            updateCategoriesChart(medicines);
        }

        function updateStockTrendsChart(movements) {
            const ctx = document.getElementById('stockTrendsChart').getContext('2d');
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const stockInData = last7Days.map(date => movements.filter(m => m.movement_type === 'in' && m.movement_date === date).reduce((sum, m) => sum + m.quantity, 0));
            const stockOutData = last7Days.map(date => movements.filter(m => m.movement_type === 'out' && m.movement_date === date).reduce((sum, m) => sum + m.quantity, 0));

            if (stockTrendsChart) stockTrendsChart.destroy();
            stockTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => new Date(date).toLocaleDateString()),
                    datasets: [
                        { label: 'Stock In', data: stockInData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
                        { label: 'Stock Out', data: stockOutData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateCategoriesChart(medicines) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            const categories = medicines.reduce((acc, med) => {
                const cat = med.category || 'Uncategorized';
                acc[cat] = (acc[cat] || 0) + 1;
                return acc;
            }, {});

            if (categoriesChart) categoriesChart.destroy();
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function updateInventoryTable(medicines, movements) {
            const tbody = document.getElementById("inventoryTable");
            tbody.innerHTML = medicines.map(medicine => {
                const stockLevel = medicine.stock || 0;
                const stockStatus = stockLevel <= 10 ? 'Critical' : stockLevel <= 50 ? 'Low' : 'Good';
                const stockClass = stockLevel <= 10 ? 'text-red-600' : stockLevel <= 50 ? 'text-yellow-600' : 'text-green-600';
                const totalValue = stockLevel * (medicine.price || 0);
                const lastMovement = movements.filter(m => m.medicine_id === medicine.id).sort((a, b) => new Date(b.movement_date) - new Date(a.movement_date))[0];
                const lastMovementText = lastMovement ? `${lastMovement.movement_type.toUpperCase()} (${lastMovement.movement_date})` : 'No movements';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${medicine.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${medicine.category || 'Uncategorized'}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap ${stockClass} font-semibold">${stockLevel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-900">${Math.round(totalValue).toLocaleString()} RWF</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full ${stockClass === 'text-red-600' ? 'bg-red-100' : stockClass === 'text-yellow-600' ? 'bg-yellow-100' : 'bg-green-100'} ${stockClass}">${stockStatus}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastMovementText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button onclick="viewMedicineMovements(${medicine.id})" class="text-primary hover:text-green-600">View History</button></td>
                    </tr>`;
            }).join("");
        }

        function updateMovementsTable(movements) {
            const tbody = document.getElementById("movementsTable");
            tbody.innerHTML = movements.slice(0, 50).map(movement => {
                const movementClass = movement.movement_type === 'in' ? 'text-green-600' : 'text-red-600';
                const movementIcon = movement.movement_type === 'in' ? 'fa-arrow-up' : 'fa-arrow-down';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${movement.movement_date}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${movement.medicine_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${movementClass}"><i class="fas ${movementIcon} mr-1"></i>${movement.movement_type.toUpperCase()}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${movementClass} font-semibold">${movement.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${movement.previous_stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${movement.new_stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${movement.reason}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${movement.notes || '-'}</td>
                    </tr>`;
            }).join("");
        }

        function updateAlertsTab(medicines) {
            const criticalLowStock = document.getElementById("criticalLowStock");
            const expiryWarnings = document.getElementById("expiryWarnings");
            const generalAlerts = document.getElementById("generalAlerts");
            
            const criticalItems = medicines.filter(m => (m.stock || 0) <= 5);
            criticalLowStock.innerHTML = criticalItems.length > 0 ? criticalItems.map(m => `<p>• ${m.name}: Only ${m.stock || 0} units remaining</p>`).join('') : '<p>No critical low stock items.</p>';
            
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiringItems = medicines.filter(m => m.expiry_date && new Date(m.expiry_date) <= thirtyDaysFromNow && new Date(m.expiry_date) >= today);
            expiryWarnings.innerHTML = expiringItems.length > 0 ? expiringItems.map(m => `<p>• ${m.name}: Expires on ${m.expiry_date}</p>`).join('') : '<p>No expiry warnings for the next 30 days.</p>';
            
            const lowStockItems = medicines.filter(m => (m.stock || 0) > 5 && (m.stock || 0) <= 20);
            generalAlerts.innerHTML = `<p>• ${medicines.length} total medicines in inventory</p><p>• ${lowStockItems.length} items with low stock (6-20 units)</p><p>• ${medicines.filter(m => !m.category).length} uncategorized medicines</p>`;
        }

        function filterInventoryTable() {
            const searchTerm = document.getElementById("inventorySearch").value.toLowerCase();
            const categoryFilter = document.getElementById("categoryFilter").value;
            const filteredMedicines = allMedicines.filter(m => m.name.toLowerCase().includes(searchTerm) && (!categoryFilter || m.category === categoryFilter));
            updateInventoryTable(filteredMedicines, allMovements);
        }

        function filterMovementsTable() {
            const dateFilter = document.getElementById("dateFilter").value;
            const typeFilter = document.getElementById("movementTypeFilter").value;
            const filteredMovements = allMovements.filter(m => (!dateFilter || m.movement_date === dateFilter) && (!typeFilter || m.movement_type === typeFilter));
            updateMovementsTable(filteredMovements);
        }

        function populateMedicineDropdown(medicines) {
            const select = document.getElementById("stockMedicineId");
            select.innerHTML = '<option value="">Select Medicine</option>' + medicines.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function populateCategoryFilter(medicines) {
            const categories = [...new Set(medicines.map(m => m.category).filter(Boolean))];
            const select = document.getElementById("categoryFilter");
            select.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function openAddStockModal() {
            document.getElementById("addStockModal").style.display = "flex";
        }

        function closeAddStockModal() {
            document.getElementById("addStockModal").style.display = "none";
            document.getElementById("addStockForm").reset();
        }

        async function handleAddStock(event) {
            event.preventDefault();
            const medicineId = parseInt(document.getElementById("stockMedicineId").value);
            const movementType = document.getElementById("stockMovementType").value;
            const quantity = parseInt(document.getElementById("stockQuantity").value);
            const reason = document.getElementById("stockReason").value;
            const notes = document.getElementById("stockNotes").value;

            if (!medicineId || !quantity || quantity <= 0) {
                showNotification("Please fill in all required fields with valid values.", "error");
                return;
            }

            try {
                showNotification("Processing stock movement...", "info");
                const result = movementType === 'in' ? await processStockIn(medicineId, quantity, reason, notes) : await processStockOut(medicineId, quantity, reason, notes);
                
                if (result !== null) {
                    showNotification("Stock movement recorded successfully!", "success");
                    closeAddStockModal();
                    setTimeout(loadAllReportsData, 1000);
                } else {
                    showNotification("Error: Could not process stock movement. Check stock levels.", "error");
                }
            } catch (error) {
                showNotification("Error recording stock movement.", "error");
            }
        }

        function viewMedicineMovements(medicineId) {
            document.getElementById("movementsTab").click();
            const filteredMovements = allMovements.filter(m => m.medicine_id === medicineId);
            updateMovementsTable(filteredMovements);
            showNotification(`Showing movements for selected medicine`, "info");
        }

        async function exportAllReports() {
            try {
                showNotification("Preparing export...", "info");
                let csvContent = "Medicine Inventory Report\nMedicine,Category,Stock,Value,Status\n";
                allMedicines.forEach(m => {
                    const stockLevel = m.stock || 0;
                    const totalValue = stockLevel * (m.price || 0);
                    const stockStatus = stockLevel <= 10 ? 'Critical' : stockLevel <= 50 ? 'Low' : 'Good';
                    csvContent += `"${m.name}","${m.category || 'Uncategorized'}",${stockLevel},${Math.round(totalValue)},${stockStatus}\n`;
                });

                csvContent += "\n\nStock Movements Report\nDate,Medicine,Movement,Quantity,Previous Stock,New Stock,Reason,Notes\n";
                allMovements.slice(0, 100).forEach(m => {
                    csvContent += `"${m.movement_date}","${m.medicine_name}","${m.movement_type.toUpperCase()}",${m.quantity},${m.previous_stock},${m.new_stock},"${m.reason}","${m.notes || ''}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `medicine_reports_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("Reports exported successfully!", "success");
            } catch (error) {
                showNotification("Error exporting reports.", "error");
            }
        }

        function showNotification(message, type = "info") {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove("show"), 3000);
        }
    </script>

    <style>
        :root {
            --primary: #16a34a; /* Green-600 */
        }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .ring-primary { --tw-ring-color: var(--primary); }
        .hover\:bg-green-600:hover { background-color: #15803d; } /* Green-700 */

        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; transform: translateX(120%); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; z-index: 1001; }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.success { background-color: #10b981; }
        .notification.warning { background-color: #f59e0b; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }

        canvas { max-height: 300px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 0; border-radius: 0.5rem; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: modalSlideIn 0.3s ease-out; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 0.5rem 0.5rem 0 0; }
        .modal-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827; }
        .close { color: #6b7280; font-size: 1.5rem; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0.25rem; line-height: 1; border-radius: 0.25rem; transition: color 0.2s ease, background-color 0.2s ease; }
        .close:hover, .close:focus { color: #374151; background-color: #f3f4f6; }
        .modal form { padding: 1.5rem; }
        .tab-button.active { border-bottom-color: var(--primary) !important; color: var(--primary) !important; }
    </style>
</body>
</html>
