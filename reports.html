<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medicine Reports - Nyina wa Jambo Pharmacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="notification-system.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen bg-gray-100">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-64 bg-green-800 text-white flex-shrink-0 hidden lg:block"
      >
        <div class="p-6">
          <a
            href="dashboard.html"
            class="text-2xl font-bold text-white flex items-center"
          >
            <i class="fas fa-pills mr-3"></i>
            <span>Nyina wa Jambo</span>
          </a>
        </div>
        <nav class="mt-6">
          <a href="dashboard.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors">
            <i class="fas fa-tachometer-alt w-6 text-center"></i>
            <span class="ml-4">Dashboard</span>
          </a>
          <a href="medicines.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
            <i class="fas fa-capsules w-6 text-center"></i>
            <span class="ml-4">Medicines</span>
          </a>
          <a href="suppliers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-truck w-6 text-center"></i>
            <span class="ml-4">Suppliers</span>
          </a>
          <a href="customers.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors">
            <i class="fas fa-users w-6 text-center"></i>
            <span class="ml-4">Customers</span>
          </a>
          <a href="orders.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors receptionist-only">
            <i class="fas fa-shopping-cart w-6 text-center"></i>
            <span class="ml-4">Orders</span>
          </a>
          <a href="user-management.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-user-cog w-6 text-center"></i>
            <span class="ml-4">User Management</span>
          </a>
          <a href="reports.html" class="flex items-center py-3 px-6 bg-green-600 text-white admin-only">
            <i class="fas fa-chart-line w-6 text-center"></i>
            <span class="ml-4">Reports</span>
          </a>
          <a href="cash-book.html" class="flex items-center py-3 px-6 text-gray-300 hover:bg-green-600 hover:text-white transition-colors admin-only">
            <i class="fas fa-book w-6 text-center"></i>
            <span class="ml-4">Cash Book</span>
          </a>
        </nav>
            
        <div class="mt-auto p-6 bottom-0">
          <button
            onclick="logout()"
            class="w-full flex items-center justify-center py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <i class="fas fa-sign-out-alt mr-2"></i>
            <span>Logout</span>
          </button>
        </div>
      </aside>

      <div class="flex-1 flex flex-col overflow-hidden">
        <header
          class="bg-white shadow-sm flex justify-between items-center p-4"
        >
          <button id="menu-toggle" class="text-gray-700 lg:hidden">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-xl font-semibold text-gray-800 hidden lg:block">
            Medicine Reports & Analytics
          </h1>
          <div class="flex items-center space-x-4">
            <div class="relative">
              <button id="userAvatar" class="flex items-center space-x-2">
                <img src="" alt="User Avatar" class="w-10 h-10 rounded-full" />
                <span
                  id="currentUser"
                  class="text-gray-700 font-medium hidden md:block"
                ></span>
              </button>
              <div
                id="userDropdown"
                class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 hidden"
              >
                <div class="py-1">
                  <div class="px-4 py-2 text-sm text-gray-500 border-b">
                    <span id="userInfo"></span>
                  </div>
                  <!-- <a
                    href="index.html?home=true"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >
                    <i class="fas fa-home mr-2"></i>Home Page
                  </a> -->
                  <button
                    onclick="logout()"
                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          <div class="container mx-auto">
            <div class="mb-8">
              <div class="flex justify-between items-center">
                <div>
                  <h1 class="text-3xl font-bold text-gray-900">
                    Medicine Reports & Analytics
                  </h1>
                  <p class="text-gray-600 mt-2">
                    Comprehensive medicine inventory tracking and analytics
                  </p>
                </div>
                <div class="flex space-x-3">
                  <button
                    id="addStockBtn"
                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors"
                  >
                    <i class="fas fa-plus mr-2"></i>Add Stock Movement
                  </button>
                  <button
                    id="exportReportsBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                  >
                    <i class="fas fa-download mr-2"></i>Export Reports
                  </button>
                  <button
                    id="refreshBtn"
                    class="bg-primary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors"
                  >
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                  </button>
                </div>
              </div>
            </div>

            <!-- Key Metrics Cards -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-blue-100">
                    <i class="fas fa-pills text-blue-600 text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Total Medicines
                    </p>
                    <p
                      id="totalMedicines"
                      class="text-2xl font-semibold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-green-100">
                    <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Stock In (Today)
                    </p>
                    <p
                      id="stockInToday"
                      class="text-2xl font-semibold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-red-100">
                    <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Stock Out (Today)
                    </p>
                    <p
                      id="stockOutToday"
                      class="text-2xl font-semibold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-yellow-100">
                    <i
                      class="fas fa-exclamation-triangle text-yellow-600 text-xl"
                    ></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Low Stock Items
                    </p>
                    <p
                      id="lowStockCount"
                      class="text-2xl font-semibold text-gray-900"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Stock Movement Trends (Last 7 Days)
                </h3>
                <canvas id="stockTrendsChart" width="400" height="300"></canvas>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Medicine Categories Distribution
                </h3>
                <canvas id="categoriesChart" width="400" height="300"></canvas>
              </div>
            </div>

            <!-- Stock Movement Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-green-700 mb-4">
                  <i class="fas fa-arrow-up mr-2"></i>Stock In Movements
                </h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Date
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Medicine
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Quantity
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Reason
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="stockInTable"
                      class="bg-white divide-y divide-gray-200"
                    ></tbody>
                  </table>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-red-700 mb-4">
                  <i class="fas fa-arrow-down mr-2"></i>Stock Out Movements
                </h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Date
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Medicine
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Quantity
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                        >
                          Reason
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="stockOutTable"
                      class="bg-white divide-y divide-gray-200"
                    ></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Tabbed Reports Section -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-8">
              <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                  <button
                    id="inventoryTab"
                    class="tab-button active border-b-2 border-primary text-primary py-4 px-1 text-sm font-medium"
                  >
                    <i class="fas fa-warehouse mr-2"></i>Inventory Report
                  </button>
                  <button
                    id="movementsTab"
                    class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                  >
                    <i class="fas fa-exchange-alt mr-2"></i>Stock Movements
                  </button>
                  <button
                    id="alertsTab"
                    class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                  >
                    <i class="fas fa-bell mr-2"></i>Alerts & Warnings
                  </button>
                  <button
                    id="performanceTab"
                    class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                  >
                    <i class="fas fa-chart-bar mr-2"></i>Staff Performance
                  </button>
                </nav>
              </div>

              <!-- Inventory Tab -->
              <div id="inventoryContent" class="tab-content">
                <div class="p-6">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                      Medicine Inventory Overview
                    </h3>
                    <div class="flex space-x-3">
                      <input
                        type="text"
                        id="inventorySearch"
                        placeholder="Search medicines..."
                        class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                      />
                      <select
                        id="categoryFilter"
                        class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                      >
                        <option value="">All Categories</option>
                      </select>
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Medicine
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Strength
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Category
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Stock
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Value
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Status
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Last Movement
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="inventoryTable"
                        class="bg-white divide-y divide-gray-200"
                      ></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Movements Tab -->
              <div id="movementsContent" class="tab-content hidden">
                <div class="p-6">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                      Recent Stock Movements
                    </h3>
                    <div class="flex space-x-3">
                      <input
                        type="date"
                        id="dateFilter"
                        class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                      />
                      <select
                        id="movementTypeFilter"
                        class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                      >
                        <option value="">All Types</option>
                        <option value="in">Stock In</option>
                        <option value="out">Stock Out</option>
                      </select>
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Date
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Medicine
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Strength
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Type
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Quantity
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Previous Stock
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            New Stock
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Reason
                          </th>
                          <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                          >
                            Notes
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="movementsTable"
                        class="bg-white divide-y divide-gray-200"
                      ></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Alerts Tab -->
              <div id="alertsContent" class="tab-content hidden">
                <div class="p-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Inventory Alerts & Warnings
                  </h3>
                  <div class="space-y-4">
                    <div class="border-l-4 border-red-400 bg-red-50 p-4">
                      <div class="flex">
                        <div class="flex-shrink-0">
                          <i class="fas fa-exclamation-circle text-red-400"></i>
                        </div>
                        <div class="ml-3">
                          <h4 class="text-lg font-medium text-red-800">
                            Critical Low Stock
                          </h4>
                          <div
                            id="criticalLowStock"
                            class="mt-2 text-sm text-red-700"
                          ></div>
                        </div>
                      </div>
                    </div>
                    <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4">
                      <div class="flex">
                        <div class="flex-shrink-0">
                          <i class="fas fa-clock text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                          <h4 class="text-lg font-medium text-yellow-800">
                            Expiry Warnings
                          </h4>
                          <div
                            id="expiryWarnings"
                            class="mt-2 text-sm text-yellow-700"
                          ></div>
                        </div>
                      </div>
                    </div>
                    <div class="border-l-4 border-blue-400 bg-blue-50 p-4">
                      <div class="flex">
                        <div class="flex-shrink-0">
                          <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                          <h4 class="text-lg font-medium text-blue-800">
                            General Notifications
                          </h4>
                          <div
                            id="generalAlerts"
                            class="mt-2 text-sm text-blue-700"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Staff Performance Tab -->
              <div id="performanceContent" class="tab-content hidden">
                <div class="p-6">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">
                      Staff Performance Analytics
                    </h3>
                    <div class="flex space-x-3">
                      <select
                        id="performancePeriod"
                        class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                      >
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                      </select>
                      <button
                        id="refreshPerformanceBtn"
                        class="bg-primary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors"
                      >
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                      </button>
                      <button
                        id="exportPerformanceBtn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                      >
                        <i class="fas fa-download mr-2"></i>Export
                      </button>
                    </div>
                  </div>

                  <!-- Performance Metrics Cards -->
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-sm p-6 text-white">
                      <div class="flex items-center">
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                          <i class="fas fa-users text-2xl"></i>
                        </div>
                        <div class="ml-4">
                          <p class="text-sm font-medium opacity-90">Active Staff</p>
                          <p id="activeStaffCount" class="text-3xl font-bold">0</p>
                          <p class="text-sm opacity-75">Currently working</p>
                        </div>
                      </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-sm p-6 text-white">
                      <div class="flex items-center">
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                          <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                        <div class="ml-4">
                          <p class="text-sm font-medium opacity-90">Avg Performance</p>
                          <p id="avgPerformanceGrade" class="text-3xl font-bold">B+</p>
                          <p class="text-sm opacity-75">Team grade</p>
                        </div>
                      </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-sm p-6 text-white">
                      <div class="flex items-center">
                        <div class="p-3 rounded-full bg-white bg-opacity-20">
                          <i class="fas fa-clock text-2xl"></i>
                        </div>
                        <div class="ml-4">
                          <p class="text-sm font-medium opacity-90">Total Hours</p>
                          <p id="totalHoursWorked" class="text-3xl font-bold">0</p>
                          <p class="text-sm opacity-75">This period</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Performance Charts -->
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm p-6 border">
                      <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Staff Performance Ranking
                      </h4>
                      <canvas id="performanceRankingChart" width="400" height="300"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-6 border">
                      <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        Sales vs Accuracy
                      </h4>
                      <canvas id="salesAccuracyChart" width="400" height="300"></canvas>
                    </div>
                  </div>

                  <!-- Detailed Performance Table -->
                  <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-gray-200">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Detailed Performance Analysis
                      </h4>
                      <p class="text-sm text-gray-600 mt-1">
                        Comprehensive metrics for all staff members including efficiency, accuracy, and customer service
                      </p>
                    </div>
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                          <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Staff Member
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Grade
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Days Worked
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Total Hours
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Orders Processed
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Total Sales
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Avg Order Value
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Orders/Hour
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Sales/Hour
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Accuracy Rate
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Avg Transaction Time
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Efficiency Rank
                            </th>
                          </tr>
                        </thead>
                        <tbody id="performanceTable" class="bg-white divide-y divide-gray-200">
                          <!-- Performance data will be populated here -->
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Performance Insights -->
                  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                      <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-trophy text-yellow-500 mr-2"></i>Top Performers
                      </h4>
                      <div id="topPerformers" class="space-y-3">
                        <!-- Top performers will be populated here -->
                      </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                      <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i>Performance Insights
                      </h4>
                      <div id="performanceInsights" class="space-y-3">
                        <!-- Performance insights will be populated here -->
                      </div>
                    </div>
                  </div>

                  <!-- Data Collection Information -->
                  <div class="mt-8 bg-gray-50 rounded-lg p-6 border">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                      <i class="fas fa-info-circle text-blue-500 mr-2"></i>How Performance Data is Collected
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <h5 class="font-medium text-gray-800 mb-2">Automatic Data Collection</h5>
                        <ul class="text-sm text-gray-600 space-y-1">
                          <li>• Orders processed (tracked when order status changes to "completed")</li>
                          <li>• Sales amounts (automatically calculated from completed orders)</li>
                          <li>• Customer count (each completed order counts as one customer)</li>
                          <li>• Medicines dispensed (sum of quantities from order items)</li>
                          <li>• Transaction timing (measured from order start to completion)</li>
                        </ul>
                      </div>
                      <div>
                        <h5 class="font-medium text-gray-800 mb-2">Manual Tracking Points</h5>
                        <ul class="text-sm text-gray-600 space-y-1">
                          <li>• Shift management (clock in/out times)</li>
                          <li>• Cash register sessions (opening/closing balances)</li>
                          <li>• Error tracking (manual entry when errors occur)</li>
                          <li>• Customer feedback (if collected)</li>
                          <li>• Special notes and observations</li>
                        </ul>
                      </div>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                      <h5 class="font-medium text-blue-800 mb-2">Performance Grading System</h5>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div class="text-center">
                          <span class="inline-block w-8 h-8 bg-green-500 text-white rounded-full font-bold leading-8">A+</span>
                          <p class="mt-1 text-gray-600">≥98% accuracy + ≥100 RWF/hour</p>
                        </div>
                        <div class="text-center">
                          <span class="inline-block w-8 h-8 bg-blue-500 text-white rounded-full font-bold leading-8">A</span>
                          <p class="mt-1 text-gray-600">≥95% accuracy + ≥80 RWF/hour</p>
                        </div>
                        <div class="text-center">
                          <span class="inline-block w-8 h-8 bg-yellow-500 text-white rounded-full font-bold leading-8">B</span>
                          <p class="mt-1 text-gray-600">≥90% accuracy + ≥60 RWF/hour</p>
                        </div>
                        <div class="text-center">
                          <span class="inline-block w-8 h-8 bg-orange-500 text-white rounded-full font-bold leading-8">C</span>
                          <p class="mt-1 text-gray-600">≥85% accuracy</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Add Stock Modal -->
    <div id="addStockModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="text-xl font-bold text-gray-900">Add Stock Movement</h2>
          <button id="closeStockModal" class="close">&times;</button>
        </div>
        <form id="addStockForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Medicine</label
            >
            <select
              id="stockMedicineId"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              required
            >
              <option value="">Select Medicine</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Movement Type</label
            >
            <select
              id="stockMovementType"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              required
            >
              <option value="in">Stock In (Add Inventory)</option>
              <option value="out">Stock Out (Reduce Inventory)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Quantity</label
            >
            <input
              type="number"
              id="stockQuantity"
              min="1"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Reason</label
            >
            <select
              id="stockReason"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              required
            >
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
              <option value="expired">Expired</option>
              <option value="damaged">Damaged</option>
              <option value="adjustment">Stock Adjustment</option>
              <option value="return">Return</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Notes (Optional)</label
            >
            <textarea
              id="stockNotes"
              rows="3"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
            ></textarea>
          </div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="cancelStockBtn"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 border border-gray-300 rounded-md hover:bg-gray-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md hover:bg-green-600"
            >
              Add Movement
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
      let stockTrendsChart = null;
      let categoriesChart = null;
      let performanceRankingChart = null;
      let salesAccuracyChart = null;
      let allMedicines = [];
      let allMovements = [];
      let staffPerformanceData = [];

      async function logout() {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          window.location.href = "login.html";
        } catch (error) {
          showError("Error signing out: " + error.message);
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        if (!(await isAuthenticated())) {
          window.location.href = "login.html";
          return;
        }

        const user = await getUserProfile();
        if (!user || user.role !== "admin") {
          showNotification(
            "Access denied. Admin privileges required.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "index.html?dashboard=true";
          }, 2000);
          return;
        }

        await updateNavigation();
        await loadAllReportsData();
        setupEventListeners();
        setupTabSwitching();
      });

      async function updateNavigation() {
        try {
          const user = await getUserProfile();
          if (user) {
            document.getElementById("currentUser").textContent = `${
              user.full_name || "User"
            }`;
            document.getElementById("userInfo").textContent = `${
              user.full_name || "User"
            } (${user.role || "staff"})`;

            const avatarImg = document.querySelector("#userAvatar img");
            if (avatarImg) {
              avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(
                user.full_name || "User"
              )}&background=16a34a&color=fff&bold=true`;
            }

            const adminElements = document.querySelectorAll(".admin-only");
            adminElements.forEach((el) => {
              el.style.setProperty('display', user.role === "admin" ? "flex" : "none", 'important');
            });

            const receptionistElements =
              document.querySelectorAll(".receptionist-only");
            receptionistElements.forEach((el) => {
              el.style.setProperty('display', 
                user.role === "receptionist" || user.role === "admin" ? "flex" : "none", 
                'important');
            });
          } else {
            document.getElementById("currentUser").textContent = "Guest";
            document.getElementById("userInfo").textContent = "Guest User";
          }
        } catch (error) {
          console.error("Error updating navigation:", error);
          document.getElementById("currentUser").textContent = "User";
          document.getElementById("userInfo").textContent = "User";
        }
      }

      function setupEventListeners() {
        document
          .getElementById("refreshBtn")
          .addEventListener("click", loadAllReportsData);
        document
          .getElementById("exportReportsBtn")
          .addEventListener("click", exportAllReports);
        document
          .getElementById("addStockBtn")
          .addEventListener("click", openAddStockModal);
        document
          .getElementById("addStockForm")
          .addEventListener("submit", handleAddStock);
        document
          .getElementById("cancelStockBtn")
          .addEventListener("click", closeAddStockModal);
        document
          .getElementById("closeStockModal")
          .addEventListener("click", closeAddStockModal);

        // Performance tab event listeners
        document
          .getElementById("refreshPerformanceBtn")
          .addEventListener("click", loadStaffPerformanceData);
        document
          .getElementById("exportPerformanceBtn")
          .addEventListener("click", exportPerformanceReport);
        document
          .getElementById("performancePeriod")
          .addEventListener("change", loadStaffPerformanceData);

        document
          .getElementById("inventorySearch")
          .addEventListener("input", filterInventoryTable);
        document
          .getElementById("categoryFilter")
          .addEventListener("change", filterInventoryTable);
        document
          .getElementById("dateFilter")
          .addEventListener("change", filterMovementsTable);
        document
          .getElementById("movementTypeFilter")
          .addEventListener("change", filterMovementsTable);

        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        menuToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          sidebar.classList.toggle("hidden");
        });

        const userAvatar = document.getElementById("userAvatar");
        const userDropdown = document.getElementById("userDropdown");
        userAvatar.addEventListener("click", (e) => {
          e.stopPropagation();
          userDropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", function (e) {
          if (
            !sidebar.classList.contains("hidden") &&
            !sidebar.contains(e.target) &&
            !menuToggle.contains(e.target)
          ) {
            sidebar.classList.add("hidden");
          }
          if (
            !userDropdown.classList.contains("hidden") &&
            !userAvatar.contains(e.target)
          ) {
            userDropdown.classList.add("hidden");
          }
        });
      }

      function setupTabSwitching() {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const tabId = this.id.replace("Tab", "Content");
            tabButtons.forEach((btn) => {
              btn.classList.remove("active", "border-primary", "text-primary");
              btn.classList.add("border-transparent", "text-gray-500");
            });
            tabContents.forEach((content) => content.classList.add("hidden"));

            this.classList.add("active", "border-primary", "text-primary");
            this.classList.remove("border-transparent", "text-gray-500");
            document.getElementById(tabId).classList.remove("hidden");
          });
        });
      }

      async function loadAllReportsData() {
        try {
          showNotification("Loading comprehensive reports data...", "info");
          const [medicines, movements] = await Promise.all([
            fetchMedicines(),
            fetchStockMovements(),
          ]);

          allMedicines = medicines;
          allMovements = movements;

          updateKeyMetrics(medicines, movements);
          updateCharts(medicines, movements);
          updateInventoryTable(medicines, movements);
          updateMovementsTable(movements);
          updateAlertsTab(medicines);
          populateMedicineDropdown(medicines);
          populateCategoryFilter(medicines);

          // Load staff performance data
          await loadStaffPerformanceData();

          showNotification("All reports loaded successfully!", "success");
        } catch (error) {
          console.error("Error loading reports:", error);
          showNotification("Error loading reports data.", "error");
        }
      }

      function formatCurrency(amount) {
        return Math.round(amount || 0).toLocaleString() + " RWF";
      }

      function updateKeyMetrics(medicines, movements) {
        const today = new Date().toISOString().split("T")[0];
        const stockInToday = movements
          .filter((m) => m.movement_type === "in" && m.movement_date === today)
          .reduce((sum, m) => sum + m.quantity, 0);
        const stockOutToday = movements
          .filter((m) => m.movement_type === "out" && m.movement_date === today)
          .reduce((sum, m) => sum + m.quantity, 0);
        const lowStockItems = medicines.filter((m) => (m.stock || 0) <= 20);

        document.getElementById("totalMedicines").textContent =
          medicines.length;
        document.getElementById("stockInToday").textContent = stockInToday;
        document.getElementById("stockOutToday").textContent = stockOutToday;
        document.getElementById("lowStockCount").textContent =
          lowStockItems.length;
      }

      function updateCharts(medicines, movements) {
        updateStockTrendsChart(movements);
        updateCategoriesChart(medicines);
        updateStockInOutTables(movements);
      }

      function updateStockTrendsChart(movements) {
        const ctx = document
          .getElementById("stockTrendsChart")
          .getContext("2d");
        const last7Days = Array.from({ length: 7 }, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - i);
          return d.toISOString().split("T")[0];
        }).reverse();

        const stockInData = last7Days.map((date) =>
          movements
            .filter((m) => m.movement_type === "in" && m.movement_date === date)
            .reduce((sum, m) => sum + m.quantity, 0)
        );
        const stockOutData = last7Days.map((date) =>
          movements
            .filter(
              (m) => m.movement_type === "out" && m.movement_date === date
            )
            .reduce((sum, m) => sum + m.quantity, 0)
        );

        if (stockTrendsChart) stockTrendsChart.destroy();
        stockTrendsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: last7Days.map((date) =>
              new Date(date).toLocaleDateString()
            ),
            datasets: [
              {
                label: "Stock In",
                data: stockInData,
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                tension: 0.4,
              },
              {
                label: "Stock Out",
                data: stockOutData,
                borderColor: "#ef4444",
                backgroundColor: "rgba(239, 68, 68, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      function updateCategoriesChart(medicines) {
        const ctx = document.getElementById("categoriesChart").getContext("2d");
        const categories = medicines.reduce((acc, med) => {
          const cat =
            med.category || med.medicine_categories?.name || "Uncategorized";
          acc[cat] = (acc[cat] || 0) + 1;
          return acc;
        }, {});

        if (categoriesChart) categoriesChart.destroy();
        categoriesChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(categories),
            datasets: [
              {
                data: Object.values(categories),
                backgroundColor: [
                  "#3b82f6",
                  "#ef4444",
                  "#10b981",
                  "#f59e0b",
                  "#8b5cf6",
                  "#06b6d4",
                  "#ec4899",
                  "#84cc16",
                ],
                borderWidth: 2,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      function updateInventoryTable(medicines, movements) {
        const tbody = document.getElementById("inventoryTable");
        tbody.innerHTML = medicines
          .map((medicine) => {
            const stockLevel = medicine.stock || 0;
            const stockStatus =
              stockLevel <= 10 ? "Critical" : stockLevel <= 50 ? "Low" : "Good";
            const stockClass =
              stockLevel <= 10
                ? "text-red-600"
                : stockLevel <= 50
                ? "text-yellow-600"
                : "text-green-600";
            const totalValue = stockLevel * (medicine.selling_price || 0);
            const lastMovement = movements
              .filter((m) => m.medicine_id === medicine.id)
              .sort(
                (a, b) => new Date(b.movement_date) - new Date(a.movement_date)
              )[0];
            const lastMovementText = lastMovement
              ? `${lastMovement.movement_type.toUpperCase()} (${
                  lastMovement.movement_date
                })`
              : "No movements";

            return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${
                          medicine.name
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">${
                          medicine.strength || 'N/A'
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${
                          medicine.category ||
                          medicine.medicine_categories?.name ||
                          "Uncategorized"
                        }</span></td>
                        <td class="px-6 py-4 whitespace-nowrap ${stockClass} font-semibold">${stockLevel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-900">${formatCurrency(
                          totalValue
                        )}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full ${
                          stockClass === "text-red-600"
                            ? "bg-red-100"
                            : stockClass === "text-yellow-600"
                            ? "bg-yellow-100"
                            : "bg-green-100"
                        } ${stockClass}">${stockStatus}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastMovementText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button onclick="viewMedicineMovements(${
                          medicine.id
                        })" class="text-primary hover:text-green-600">View History</button></td>
                    </tr>`;
          })
          .join("");
      }

      function updateMovementsTable(movements) {
        const tbody = document.getElementById("movementsTable");
        tbody.innerHTML = movements
          .slice(0, 50)
          .map((movement) => {
            const movementClass =
              movement.movement_type === "in"
                ? "text-green-600"
                : "text-red-600";
            const movementIcon =
              movement.movement_type === "in" ? "fa-arrow-up" : "fa-arrow-down";
            return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          movement.movement_date
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${
                          movement.medicine_name
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">${
                          movement.medicines?.strength || 'N/A'
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${movementClass}"><i class="fas ${movementIcon} mr-1"></i>${movement.movement_type.toUpperCase()}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${movementClass} font-semibold">${
              movement.quantity
            }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                          movement.previous_stock
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${
                          movement.new_stock
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${
                          movement.reason
                        }</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          movement.notes || "-"
                        }</td>
                    </tr>`;
          })
          .join("");
      }

      function updateStockInOutTables(movements) {
        const today = new Date().toISOString().split("T")[0];

        const stockInRows = movements
          .filter((m) => m.movement_type === "in" && m.movement_date === today)
          .slice(0, 10)
          .map(
            (m) => `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${m.movement_date}</td>
                        <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-900">${m.medicine_name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-green-700 font-semibold">${m.quantity}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${m.reason}</td>
                    </tr>
                `
          )
          .join("");
        document.getElementById("stockInTable").innerHTML =
          stockInRows ||
          '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-400">No Stock In movements found today.</td></tr>';

        const stockOutRows = movements
          .filter((m) => m.movement_type === "out" && m.movement_date === today)
          .slice(0, 10)
          .map(
            (m) => `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${m.movement_date}</td>
                        <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-900">${m.medicine_name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-red-700 font-semibold">${m.quantity}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${m.reason}</td>
                    </tr>
                `
          )
          .join("");
        document.getElementById("stockOutTable").innerHTML =
          stockOutRows ||
          '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-400">No Stock Out movements found today.</td></tr>';
      }

      function updateAlertsTab(medicines) {
        const criticalLowStock = document.getElementById("criticalLowStock");
        const expiryWarnings = document.getElementById("expiryWarnings");
        const generalAlerts = document.getElementById("generalAlerts");

        const criticalItems = medicines.filter((m) => (m.stock || 0) <= 5);
        const expiringItems = medicines.filter((m) => {
          if (!m.expiry_date) return false;
          const today = new Date();
          const thirtyDaysFromNow = new Date(
            today.getTime() + 30 * 24 * 60 * 60 * 1000
          );
          return (
            new Date(m.expiry_date) <= thirtyDaysFromNow &&
            new Date(m.expiry_date) >= today
          );
        });
        const lowStockItems = medicines.filter(
          (m) => (m.stock || 0) > 5 && (m.stock || 0) <= 20
        );

        if (criticalLowStock) {
          criticalLowStock.innerHTML =
            criticalItems.length > 0
              ? criticalItems
                  .map(
                    (m) =>
                      `<p>• ${m.name}: Only ${m.stock || 0} units remaining</p>`
                  )
                  .join("")
              : "<p>No critical low stock items.</p>";
        }

        if (expiryWarnings) {
          expiryWarnings.innerHTML =
            expiringItems.length > 0
              ? expiringItems
                  .map((m) => `<p>• ${m.name}: Expires on ${m.expiry_date}</p>`)
                  .join("")
              : "<p>No expiry warnings for the next 30 days.</p>";
        }

        if (generalAlerts) {
          generalAlerts.innerHTML = `
                    <p>• ${medicines.length} total medicines in inventory</p>
                    <p>• ${
                      lowStockItems.length
                    } items with low stock (6-20 units)</p>
                    <p>• ${
                      medicines.filter(
                        (m) => !m.category && !m.medicine_categories
                      ).length
                    } uncategorized medicines</p>
                    <p>• ${
                      expiringItems.length
                    } medicines expiring in the next 30 days</p>
                `;
        }

        // Create notifications for critical alerts
        createAlertsNotifications(criticalItems, expiringItems, lowStockItems);
      }

      async function createAlertsNotifications(
        criticalItems,
        expiringItems,
        lowStockItems
      ) {
        try {
          // Create notifications for critical low stock items
          if (criticalItems.length > 0) {
            for (const item of criticalItems) {
              await createNotification({
                title: "Critical Low Stock Alert",
                message: `${item.name} is critically low with only ${
                  item.stock || 0
                } units remaining. Immediate restocking required.`,
                type: "error",
                targetRole: "admin",
                relatedTo: "medicine",
                relatedId: item.id,
                priority: "urgent",
                actionRequired: true,
                actionUrl: "/medicines.html",
              });
            }
          }

          // Create notifications for expiring items
          if (expiringItems.length > 0) {
            for (const item of expiringItems) {
              await createNotification({
                title: "Medicine Expiry Warning",
                message: `${item.name} is expiring on ${item.expiry_date}. Please check inventory and plan accordingly.`,
                type: "warning",
                targetRole: "admin",
                relatedTo: "medicine",
                relatedId: item.id,
                priority: "high",
                actionRequired: true,
                actionUrl: "/medicines.html",
              });
            }
          }

          // Create notification for general low stock summary (only if there are items)
          if (lowStockItems.length > 0) {
            await createNotification({
              title: "Low Stock Summary",
              message: `${lowStockItems.length} medicines have low stock levels (6-20 units). Consider restocking soon.`,
              type: "warning",
              targetRole: "admin",
              relatedTo: "stock",
              priority: "normal",
              actionRequired: false,
              actionUrl: "/medicines.html",
            });
          }

          // Refresh notification system to show new notifications
          if (window.notificationSystem) {
            await window.notificationSystem.loadNotifications();
          }
        } catch (error) {
          console.error("Error creating alert notifications:", error);
        }
      }

      function filterInventoryTable() {
        const searchTerm = document
          .getElementById("inventorySearch")
          .value.toLowerCase();
        const categoryFilter = document.getElementById("categoryFilter").value;
        const filteredMedicines = allMedicines.filter((m) => {
          const matchesSearch = m.name.toLowerCase().includes(searchTerm);
          const medicineCategory = m.category || m.medicine_categories?.name;
          const matchesCategory =
            !categoryFilter || medicineCategory === categoryFilter;
          return matchesSearch && matchesCategory;
        });
        updateInventoryTable(filteredMedicines, allMovements);
      }

      function filterMovementsTable() {
        const dateFilter = document.getElementById("dateFilter").value;
        const typeFilter = document.getElementById("movementTypeFilter").value;
        const filteredMovements = allMovements.filter(
          (m) =>
            (!dateFilter || m.movement_date === dateFilter) &&
            (!typeFilter || m.movement_type === typeFilter)
        );
        updateMovementsTable(filteredMovements);
      }

      function populateMedicineDropdown(medicines) {
        const select = document.getElementById("stockMedicineId");
        select.innerHTML =
          '<option value="">Select Medicine</option>' +
          medicines
            .map((m) => `<option value="${m.id}">${m.name}${m.strength ? ' - ' + m.strength : ''}</option>`)
            .join("");
      }

      function populateCategoryFilter(medicines) {
        const categories = [
          ...new Set(
            medicines
              .map((m) => m.category || m.medicine_categories?.name)
              .filter(Boolean)
          ),
        ];
        const select = document.getElementById("categoryFilter");
        if (select) {
          select.innerHTML =
            '<option value="">All Categories</option>' +
            categories
              .map((c) => `<option value="${c}">${c}</option>`)
              .join("");
        }
      }

      function openAddStockModal() {
        document.getElementById("addStockModal").style.display = "flex";
      }

      function closeAddStockModal() {
        document.getElementById("addStockModal").style.display = "none";
        document.getElementById("addStockForm").reset();
      }

      async function handleAddStock(event) {
        event.preventDefault();
        const medicineId = parseInt(
          document.getElementById("stockMedicineId").value
        );
        const movementType = document.getElementById("stockMovementType").value;
        const quantity = parseInt(
          document.getElementById("stockQuantity").value
        );
        const reason = document.getElementById("stockReason").value;
        const notes = document.getElementById("stockNotes").value;

        if (!medicineId || !quantity || quantity <= 0) {
          showNotification(
            "Please fill in all required fields with valid values.",
            "error"
          );
          return;
        }

        try {
          showNotification("Processing stock movement...", "info");
          const result =
            movementType === "in"
              ? await processStockIn(medicineId, quantity, reason, notes)
              : await processStockOut(medicineId, quantity, reason, notes);

          if (result !== null) {
            showNotification(
              "Stock movement recorded successfully!",
              "success"
            );
            closeAddStockModal();
            setTimeout(loadAllReportsData, 1000);
          } else {
            showNotification(
              "Error: Could not process stock movement. Check stock levels.",
              "error"
            );
          }
        } catch (error) {
          showNotification("Error recording stock movement.", "error");
        }
      }

      function viewMedicineMovements(medicineId) {
        document.getElementById("movementsTab").click();
        const filteredMovements = allMovements.filter(
          (m) => m.medicine_id === medicineId
        );
        updateMovementsTable(filteredMovements);
        showNotification(`Showing movements for selected medicine`, "info");
      }

      async function exportAllReports() {
        try {
          showNotification("Preparing export...", "info");
          
          if (!allMedicines.length && !allMovements.length) {
            showNotification("No data available to export. Please load reports first.", "warning");
            return;
          }

          if (typeof ExcelJS === "undefined") {
            showNotification("ExcelJS library not loaded. Please refresh the page.", "error");
            return;
          }

          // Create a new workbook
          const workbook = new ExcelJS.Workbook();
          
          // Medicine Inventory Sheet
          if (allMedicines.length > 0) {
            const inventorySheet = workbook.addWorksheet("Medicine Inventory");
            
            // Headers for inventory
            const inventoryHeaders = ["Medicine", "Category", "Stock", "Selling Price", "Total Value", "Stock Status"];
            inventorySheet.addRow(inventoryHeaders);
            
            // Add inventory data
            allMedicines.forEach((m) => {
              const stockLevel = m.stock || 0;
              const sellingPrice = m.selling_price || 0;
              const totalValue = stockLevel * sellingPrice;
              const stockStatus = stockLevel <= 10 ? "Critical" : stockLevel <= 50 ? "Low" : "Good";
              
              inventorySheet.addRow([
                m.name || "N/A",
                m.category || m.medicine_categories?.name || "Uncategorized",
                stockLevel,
                sellingPrice,
                totalValue,
                stockStatus
              ]);
            });

            // Style inventory sheet
            const inventoryHeaderRow = inventorySheet.getRow(1);
            inventoryHeaderRow.eachCell((cell) => {
              cell.font = { bold: true };
              cell.alignment = { vertical: "middle", horizontal: "center" };
              cell.fill = {
                type: "pattern",
                pattern: "solid",
                fgColor: { argb: "FFD9D9D9" }
              };
              cell.border = {
                top: { style: "thin" },
                left: { style: "thin" },
                bottom: { style: "thin" },
                right: { style: "thin" }
              };
            });
            inventoryHeaderRow.height = 25;

            // Style inventory data rows
            inventorySheet.eachRow((row, rowNumber) => {
              row.eachCell((cell) => {
                cell.border = {
                  top: { style: "thin" },
                  left: { style: "thin" },
                  bottom: { style: "thin" },
                  right: { style: "thin" }
                };
                cell.alignment = { vertical: "middle", horizontal: "left" };
              });
              if (rowNumber > 1) {
                row.height = 18;
              }
            });

            inventorySheet.columns = [
              { width: 30 }, // Medicine
              { width: 20 }, // Category
              { width: 10 }, // Stock
              { width: 15 }, // Selling Price
              { width: 15 }, // Total Value
              { width: 12 }  // Stock Status
            ];

            // Enable autofilter
            inventorySheet.autoFilter = {
              from: "A1",
              to: "F1"
            };
          }

          // Stock Movements Sheet
          if (allMovements.length > 0) {
            const movementsSheet = workbook.addWorksheet("Stock Movements");
            
            // Headers for movements
            const movementHeaders = ["Date", "Medicine", "Movement Type", "Quantity", "Previous Stock", "New Stock", "Reason", "Notes"];
            movementsSheet.addRow(movementHeaders);
            
            // Add movements data (limit to recent 500 for performance)
            allMovements.slice(0, 500).forEach((m) => {
              movementsSheet.addRow([
                m.movement_date || "N/A",
                m.medicine_name || "N/A",
                m.movement_type ? m.movement_type.toUpperCase() : "N/A",
                m.quantity || 0,
                m.previous_stock || 0,
                m.new_stock || 0,
                m.reason || "N/A",
                m.notes || "N/A"
              ]);
            });

            // Style movements sheet
            const movementHeaderRow = movementsSheet.getRow(1);
            movementHeaderRow.eachCell((cell) => {
              cell.font = { bold: true };
              cell.alignment = { vertical: "middle", horizontal: "center" };
              cell.fill = {
                type: "pattern",
                pattern: "solid",
                fgColor: { argb: "FFD9D9D9" }
              };
              cell.border = {
                top: { style: "thin" },
                left: { style: "thin" },
                bottom: { style: "thin" },
                right: { style: "thin" }
              };
            });
            movementHeaderRow.height = 25;

            // Style movements data rows
            movementsSheet.eachRow((row, rowNumber) => {
              row.eachCell((cell) => {
                cell.border = {
                  top: { style: "thin" },
                  left: { style: "thin" },
                  bottom: { style: "thin" },
                  right: { style: "thin" }
                };
                cell.alignment = { vertical: "middle", horizontal: "left" };
              });
              if (rowNumber > 1) {
                row.height = 18;
              }
            });

            movementsSheet.columns = [
              { width: 12 }, // Date
              { width: 25 }, // Medicine
              { width: 15 }, // Movement Type
              { width: 10 }, // Quantity
              { width: 12 }, // Previous Stock
              { width: 12 }, // New Stock
              { width: 20 }, // Reason
              { width: 30 }  // Notes
            ];

            // Enable autofilter
            movementsSheet.autoFilter = {
              from: "A1",
              to: "H1"
            };
          }

          // Generate filename
          const now = new Date();
          const dateStr = now.toISOString().split("T")[0];
          const timeStr = now.toTimeString().split(" ")[0].replace(/:/g, "-");
          const filename = `medicine_reports_${dateStr}_${timeStr}.xlsx`;

          // Write file (ExcelJS → Blob → saveAs)
          const buffer = await workbook.xlsx.writeBuffer();
          saveAs(new Blob([buffer]), filename);

          showNotification(`Reports exported successfully as ${filename}!`, "success");
        } catch (error) {
          console.error("Export error:", error);
          showNotification("Error exporting reports.", "error");
        }
      }

      function showNotification(message, type = "info") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification show ${type}`;
        setTimeout(() => notification.classList.remove("show"), 3000);
      }

      // =============================================
      // STAFF PERFORMANCE FUNCTIONS
      // =============================================

      async function loadStaffPerformanceData() {
        try {
          const days = parseInt(document.getElementById("performancePeriod").value) || 7;
          showNotification("Loading staff performance data...", "info");
          
          const performanceData = await getStaffPerformanceAnalysis(days);
          staffPerformanceData = performanceData;
          
          updatePerformanceMetrics(performanceData);
          updatePerformanceCharts(performanceData);
          updatePerformanceTable(performanceData);
          updatePerformanceInsights(performanceData);
          
          showNotification("Staff performance data loaded successfully!", "success");
        } catch (error) {
          console.error("Error loading staff performance:", error);
          showNotification("Error loading staff performance data.", "error");
        }
      }

      function updatePerformanceMetrics(data) {
        const activeStaff = data.filter(staff => staff.days_worked > 0).length;
        const avgGrade = calculateAverageGrade(data);
        const totalHours = data.reduce((sum, staff) => sum + (staff.total_hours_worked || 0), 0);
        
        document.getElementById("activeStaffCount").textContent = activeStaff;
        document.getElementById("avgPerformanceGrade").textContent = avgGrade;
        document.getElementById("totalHoursWorked").textContent = Math.round(totalHours);
      }

      function calculateAverageGrade(data) {
        if (!data || data.length === 0) return "N/A";
        
        const gradePoints = { 'A+': 4.3, 'A': 4.0, 'B': 3.0, 'C': 2.0, 'D': 1.0 };
        const activeStaff = data.filter(staff => staff.days_worked > 0);
        
        if (activeStaff.length === 0) return "N/A";
        
        const avgPoints = activeStaff.reduce((sum, staff) => {
          return sum + (gradePoints[staff.performance_grade] || 1.0);
        }, 0) / activeStaff.length;
        
        if (avgPoints >= 4.2) return "A+";
        if (avgPoints >= 3.7) return "A";
        if (avgPoints >= 2.7) return "B";
        if (avgPoints >= 1.7) return "C";
        return "D";
      }

      function updatePerformanceCharts(data) {
        updatePerformanceRankingChart(data);
        updateSalesAccuracyChart(data);
      }

      function updatePerformanceRankingChart(data) {
        const ctx = document.getElementById("performanceRankingChart").getContext("2d");
        const activeStaff = data.filter(staff => staff.days_worked > 0).slice(0, 10);
        
        if (performanceRankingChart) performanceRankingChart.destroy();
        
        performanceRankingChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: activeStaff.map(staff => staff.staff_name || "Unknown"),
            datasets: [{
              label: "Sales per Hour (RWF)",
              data: activeStaff.map(staff => Math.round(staff.sales_per_hour || 0)),
              backgroundColor: activeStaff.map(staff => {
                const grade = staff.performance_grade;
                return grade === 'A+' ? '#22c55e' : 
                       grade === 'A' ? '#3b82f6' : 
                       grade === 'B' ? '#f59e0b' : 
                       grade === 'C' ? '#ef4444' : '#6b7280';
              }),
              borderColor: '#ffffff',
              borderWidth: 2,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                title: { display: true, text: 'Sales per Hour (RWF)' }
              },
              x: {
                ticks: { maxRotation: 45 }
              }
            }
          }
        });
      }

      function updateSalesAccuracyChart(data) {
        const ctx = document.getElementById("salesAccuracyChart").getContext("2d");
        const activeStaff = data.filter(staff => staff.days_worked > 0);
        
        if (salesAccuracyChart) salesAccuracyChart.destroy();
        
        salesAccuracyChart = new Chart(ctx, {
          type: "scatter",
          data: {
            datasets: [{
              label: "Staff Performance",
              data: activeStaff.map(staff => ({
                x: staff.accuracy_rate || 100,
                y: staff.sales_per_hour || 0,
                r: Math.max(5, (staff.total_orders || 0) / 10) // Bubble size based on orders
              })),
              backgroundColor: activeStaff.map(staff => {
                const grade = staff.performance_grade;
                return grade === 'A+' ? 'rgba(34, 197, 94, 0.7)' : 
                       grade === 'A' ? 'rgba(59, 130, 246, 0.7)' : 
                       grade === 'B' ? 'rgba(245, 158, 11, 0.7)' : 
                       grade === 'C' ? 'rgba(239, 68, 68, 0.7)' : 'rgba(107, 114, 128, 0.7)';
              }),
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const staff = activeStaff[context.dataIndex];
                    return [
                      `${staff.staff_name}`,
                      `Accuracy: ${context.parsed.x}%`,
                      `Sales/Hour: ${formatCurrency(context.parsed.y)}`,
                      `Orders: ${staff.total_orders}`,
                      `Grade: ${staff.performance_grade}`
                    ];
                  }
                }
              }
            },
            scales: {
              x: { 
                title: { display: true, text: 'Accuracy Rate (%)' },
                min: 80, max: 100
              },
              y: { 
                title: { display: true, text: 'Sales per Hour (RWF)' },
                beginAtZero: true
              }
            }
          }
        });
      }

      function updatePerformanceTable(data) {
        const tbody = document.getElementById("performanceTable");
        
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 text-center text-gray-500">No performance data available for the selected period.</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.map((staff, index) => {
          const gradeColors = {
            'A+': 'bg-green-100 text-green-800',
            'A': 'bg-blue-100 text-blue-800',
            'B': 'bg-yellow-100 text-yellow-800',
            'C': 'bg-orange-100 text-orange-800',
            'D': 'bg-red-100 text-red-800'
          };
          
          const gradeClass = gradeColors[staff.performance_grade] || 'bg-gray-100 text-gray-800';
          
          return `
            <tr class="hover:bg-gray-50 ${index < 3 ? 'bg-blue-50' : ''}">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center text-sm font-semibold">
                    ${(staff.staff_name || 'U').charAt(0)}
                  </div>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">${staff.staff_name || 'Unknown'}</div>
                    <div class="text-sm text-gray-500">Rank #${staff.efficiency_rank}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${gradeClass}">
                  ${staff.performance_grade || 'N/A'}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${staff.days_worked || 0}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${Math.round(staff.total_hours_worked || 0)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-semibold">${staff.total_orders || 0}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-semibold">${formatCurrency(staff.total_sales || 0)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${formatCurrency(staff.average_order_value || 0)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${Math.round((staff.orders_per_hour || 0) * 100) / 100}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-medium">${formatCurrency(staff.sales_per_hour || 0)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <span class="text-green-600 font-semibold">${Math.round(staff.accuracy_rate || 100)}%</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${staff.average_transaction_time || 0}s</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                  staff.efficiency_rank <= 3 ? 'bg-yellow-100 text-yellow-800' : 
                  staff.efficiency_rank <= 5 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                }">
                  #${staff.efficiency_rank}
                </span>
              </td>
            </tr>
          `;
        }).join("");
      }

      function updatePerformanceInsights(data) {
        // Update top performers
        const topPerformers = data
          .filter(staff => staff.days_worked > 0)
          .sort((a, b) => b.sales_per_hour - a.sales_per_hour)
          .slice(0, 5);

        const topPerformersElement = document.getElementById("topPerformers");
        if (topPerformersElement) {
          topPerformersElement.innerHTML = topPerformers.map((staff, index) => {
            const medalClass = index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-blue-500';
            const medalIcon = index < 3 ? 'fa-medal' : 'fa-star';
            
            return `
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <i class="fas ${medalIcon} ${medalClass} text-lg"></i>
                  <div>
                    <p class="font-medium text-gray-900">${staff.staff_name || 'Unknown'}</p>
                    <p class="text-sm text-gray-600">Grade: ${staff.performance_grade} • ${staff.total_orders} orders</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-semibold text-primary">${formatCurrency(staff.sales_per_hour || 0)}/hr</p>
                  <p class="text-sm text-gray-500">${Math.round(staff.accuracy_rate || 100)}% accuracy</p>
                </div>
              </div>
            `;
          }).join("") || '<p class="text-gray-500">No performance data available.</p>';
        }

        // Update performance insights
        const insights = generatePerformanceInsights(data);
        const insightsElement = document.getElementById("performanceInsights");
        if (insightsElement) {
          insightsElement.innerHTML = insights.map(insight => `
            <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
              <i class="fas ${insight.icon} ${insight.color} text-lg mt-1"></i>
              <div>
                <p class="font-medium text-gray-900">${insight.title}</p>
                <p class="text-sm text-gray-600">${insight.description}</p>
              </div>
            </div>
          `).join("");
        }
      }

      function generatePerformanceInsights(data) {
        const insights = [];
        const activeStaff = data.filter(staff => staff.days_worked > 0);
        
        if (activeStaff.length === 0) {
          return [{
            icon: 'fa-info-circle',
            color: 'text-blue-500',
            title: 'No Data Available',
            description: 'No staff performance data available for the selected period.'
          }];
        }

        // Team performance overview
        const avgAccuracy = activeStaff.reduce((sum, staff) => sum + (staff.accuracy_rate || 100), 0) / activeStaff.length;
        const avgSalesPerHour = activeStaff.reduce((sum, staff) => sum + (staff.sales_per_hour || 0), 0) / activeStaff.length;
        
        insights.push({
          icon: 'fa-users',
          color: 'text-blue-500',
          title: 'Team Overview',
          description: `${activeStaff.length} active staff with ${Math.round(avgAccuracy)}% avg accuracy and ${formatCurrency(avgSalesPerHour)}/hour avg sales.`
        });

        // High performers
        const highPerformers = activeStaff.filter(staff => ['A+', 'A'].includes(staff.performance_grade));
        if (highPerformers.length > 0) {
          insights.push({
            icon: 'fa-star',
            color: 'text-green-500',
            title: 'Excellent Performance',
            description: `${highPerformers.length} staff members achieving A or A+ grades with outstanding sales and accuracy.`
          });
        }

        // Improvement opportunities
        const needsImprovement = activeStaff.filter(staff => ['C', 'D'].includes(staff.performance_grade));
        if (needsImprovement.length > 0) {
          insights.push({
            icon: 'fa-chart-line',
            color: 'text-orange-500',
            title: 'Growth Opportunities',
            description: `${needsImprovement.length} staff members could benefit from additional training or support.`
          });
        }

        // Efficiency insights
        const fastWorkers = activeStaff.filter(staff => (staff.orders_per_hour || 0) > 3);
        if (fastWorkers.length > 0) {
          insights.push({
            icon: 'fa-clock',
            color: 'text-purple-500',
            title: 'High Efficiency',
            description: `${fastWorkers.length} staff members processing more than 3 orders per hour, showing excellent efficiency.`
          });
        }

        return insights;
      }

      async function exportPerformanceReport() {
        try {
          if (!staffPerformanceData || staffPerformanceData.length === 0) {
            showNotification("No performance data to export. Please load data first.", "warning");
            return;
          }

          showNotification("Preparing performance export...", "info");
          
          let csvContent = "Staff Performance Report\n";
          csvContent += `Generated: ${new Date().toLocaleDateString()}\n`;
          csvContent += `Period: ${document.getElementById("performancePeriod").value} days\n\n`;
          
          csvContent += "Staff Name,Grade,Days Worked,Total Hours,Orders Processed,Total Sales,Avg Order Value,Orders/Hour,Sales/Hour,Accuracy Rate,Avg Transaction Time,Efficiency Rank\n";
          
          staffPerformanceData.forEach(staff => {
            csvContent += `"${staff.staff_name || 'Unknown'}","${staff.performance_grade || 'N/A'}",${staff.days_worked || 0},${Math.round(staff.total_hours_worked || 0)},${staff.total_orders || 0},${Math.round(staff.total_sales || 0)},${Math.round(staff.average_order_value || 0)},${Math.round((staff.orders_per_hour || 0) * 100) / 100},${Math.round(staff.sales_per_hour || 0)},${Math.round(staff.accuracy_rate || 100)},${staff.average_transaction_time || 0},${staff.efficiency_rank || 0}\n`;
          });

          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `staff_performance_report_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showNotification("Performance report exported successfully!", "success");
        } catch (error) {
          console.error("Export error:", error);
          showNotification("Error exporting performance report.", "error");
        }
      }
    </script>

    <style>
      :root {
        --primary: #16a34a; /* Green-600 */
      }
      .bg-primary {
        background-color: var(--primary);
      }
      .text-primary {
        color: var(--primary);
      }
      .border-primary {
        border-color: var(--primary);
      }
      .ring-primary {
        --tw-ring-color: var(--primary);
      }
      .hover\:bg-green-600:hover {
        background-color: #15803d;
      } /* Green-700 */

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        transform: translateX(120%);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        z-index: 1001;
      }
      .notification.show {
        transform: translateX(0);
        opacity: 1;
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.warning {
        background-color: #f59e0b;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.info {
        background-color: #3b82f6;
      }

      canvas {
        max-height: 300px;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: white;
        padding: 0;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: modalSlideIn 0.3s ease-out;
      }
      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background-color: #f9fafb;
        border-radius: 0.5rem 0.5rem 0 0;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
      }
      .close {
        color: #6b7280;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0.25rem;
        line-height: 1;
        border-radius: 0.25rem;
        transition: color 0.2s ease, background-color 0.2s ease;
      }
      .close:hover,
      .close:focus {
        color: #374151;
        background-color: #f3f4f6;
      }
      .modal form {
        padding: 1.5rem;
      }
      .tab-button.active {
        border-bottom-color: var(--primary) !important;
        color: var(--primary) !important;
      }

      /* Role-based visibility */
      .admin-only {
        display: none !important;
      }
      .receptionist-only {
        display: none !important;
      }
      .customer-only {
        display: none !important;
      }
    </style>
  </body>
</html>
